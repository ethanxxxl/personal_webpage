<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2023-06-08 Thu 12:15 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Portfolio</title>
<meta name="author" content="Ethan Smith" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
<div id="content" class="content">
<h1 class="title">Portfolio</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org0df1858">Introduction</a></li>
<li><a href="#orgaf2ef9f">This Website</a></li>
<li><a href="#org2f84340">Courses at Penn State</a>
<ul>
<li><a href="#org672cdd5">Computer Engineering 472</a></li>
<li><a href="#org5e5455a">Computer Engineering 473</a></li>
</ul>
</li>
<li><a href="#org3cb48c2">Programming</a>
<ul>
<li><a href="#orgf35ed52">Capabilities Overview</a></li>
<li><a href="#org2ce4716">Code Wars</a></li>
<li><a href="#org2bf0b45">Hack Chat</a></li>
<li><a href="#org0964b96">Rust-Snake</a></li>
</ul>
</li>
</ul>
</div>
</div>
<nav>
    <a href="index.html">Home</a> |
    <a href="blogs.html">Blogs</a> |
    <a href="https://github.com/ethanxxxl">Github</a> |
    <a href="religion.html">Religion</a> |
    <a href="portfolio.html">Portfolio</a>
</nav>

<div class="portfolio-content">
<script src="../resources/full-screen.js"></script>

<div id="outline-container-org0df1858" class="outline-2">
<h2 id="org0df1858">Introduction</h2>
<div class="outline-text-2" id="text-org0df1858">
<p>
Here I have compiled a subset of the things I have worked on throughout my life.
It is certainly not comprehensive and many projects are unfinished. I have
included things I have worked on both in school and on my own time.
</p>
</div>
</div>

<div id="outline-container-orgaf2ef9f" class="outline-2">
<h2 id="orgaf2ef9f">This Website</h2>
<div class="outline-text-2" id="text-orgaf2ef9f">
<p>
I write this site using Emacs <code>org-mode</code>, making good use of its fantastic
export capabilities. My workflow is a little different from how emacs is
configured by default, however. <code>org-publish</code> is sort of set up for someone who
uses a single computer. My workflow involves a plethora of devices. I actively
edit this site on my Macbook, and my desktop running Arch. I can foresee myself
also editing it on my desktop under Windows, or on other laptops running
whatever operating system I decide to run at that time.
</p>

<p>
Because of this workflow, I wanted to be able to contain all the information
related to this website, including export information, inside of a single
directory tree. This immediately presents challenges, because <code>org-publish</code>
makes use of several global variables which add state to its export functions.
The main variable of concern, however, is <code>org-publish-project-alist</code>. This
variable is intended to contain <b>all</b> projects that you ever work on. In theory,
there are benefits to this, but in practice, it just means my config files for
the website are spread all over my computer.
</p>

<p>
To solve this, I wrote some elisp which is bound to <code>SPC m P l</code>. Simply put, it
looks for a file named <code>export-config.el</code> in the root directory of your project.
This file defines a varaible called <code>org-publish-project-local-alist</code>, which
does the same thing as <code>org-publish-project-alist</code>, but <i>it&rsquo;s local</i> (real
complex stuff, I know).
</p>

<p>
There is one problem though. In the local alist, I can&rsquo;t use absolute paths,
because that would sort of defeat the purpose of being able to clone the git
repo anywhere and work on it. I don&rsquo;t really need absolute paths, because all
the files I reference in <code>export-config.el</code> are relative to the website root
directory. But when the publishing function runs, it gets really confused with
the relative paths (especially when using <code>#+include: ...</code> in my files.)
</p>

<p>
At this point, I pull an India Jones with these two variables and swap them
before calling the <code>org-publish-all</code> function. This publishes the entire website
with a local configuration.
</p>

<p>
I moved the elisp I wrote for this modification into a separate file which is
loaded during startup for emacs. This file is shown below.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="linenr">  1: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">org-publish-local.el -*- lexical-binding: t; -*-</span>
<span class="linenr">  2: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  3: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">PROGRAMMER: Ethan Smith</span>
<span class="linenr">  4: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  5: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">DATE: 5 June 2023</span>
<span class="linenr">  6: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  7: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">DESCRIPTION: this file is an extention to org-publish. Project export</span>
<span class="linenr">  8: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">configuration is placed in a file caled export-config.el. this file must set</span>
<span class="linenr">  9: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">a variable called ~org-publish-local-project-alist~. it should be an alist</span>
<span class="linenr"> 10: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">in the same format as ~org-publish-project-alist~, for details see its</span>
<span class="linenr"> 11: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">documentation. The only difference between these two variables is that the</span>
<span class="linenr"> 12: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">local one may use relative paths for its base directories, and the export</span>
<span class="linenr"> 13: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">local command will resolve those paths.</span>
<span class="linenr"> 14: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 15: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">BINDINGS:</span>
<span class="linenr"> 16: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">"SPC m P l"  org-publish-local-project</span>
<span class="linenr"> 17: </span>
<span class="linenr"> 18: </span><span style="color: #4078f2;">(</span><span style="color: #a626a4;">add-hook</span>
<span class="linenr"> 19: </span> <span style="color: #4078f2;">'</span><span style="color: #6a1868;">org-mode-hook</span>
<span class="linenr"> 20: </span> <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">()</span>
<span class="linenr"> 21: </span>   <span style="color: #50a14f;">(</span><span style="color: #e45649;">evil-define-key</span> <span style="color: #4078f2;">'</span><span style="color: #b751b6;">(</span>normal visual<span style="color: #b751b6;">)</span> <span style="color: #6a1868;">org-mode-map</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">kbd</span> <span style="color: #50a14f;">"SPC m P l"</span><span style="color: #b751b6;">)</span> <span style="color: #4078f2;">#'</span><span style="color: #986801;">org-publish-local-project</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span class="linenr"> 22: </span>
<span class="linenr"> 23: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #50a14f; font-weight: bold;">NOTE:</span><span style="color: #9ca0a4;"> every file in a project is loaded into a buffer, and made current in</span>
<span class="linenr"> 24: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">the org-publish-to function. That function tries to use existing buffers if</span>
<span class="linenr"> 25: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">available, otherwise it will just create a new one, temporarily.</span>
<span class="linenr"> 26: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 27: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">If a buffer already exists, but its path is screwed up, that will screw up</span>
<span class="linenr"> 28: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">the path of its includes.</span>
<span class="linenr"> 29: </span>
<span class="linenr"> 30: </span><span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">state variable for local publish function</span>
<span class="linenr"> 31: </span><span style="color: #4078f2;">(</span><span style="color: #e45649;">setq</span> org-publish-local-root nil<span style="color: #4078f2;">)</span>
<span class="linenr"> 32: </span><span style="color: #4078f2;">(</span><span style="color: #e45649;">defun</span> <span style="color: #a626a4;">org-publish-local-project</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">project-root</span><span style="color: #a626a4;">)</span>
<span class="linenr"> 33: </span>  <span style="color: #84888b; font-style: italic;">"command to publish projects not listed in ~org-publish-project-alist~.</span>
<span class="linenr"> 34: </span>
<span class="linenr"> 35: </span><span style="color: #84888b; font-style: italic;">This requrires the project alist to be defined as</span>
<span class="linenr"> 36: </span><span style="color: #84888b; font-style: italic;">org-publish-local-alist in a file called export-config.el in the</span>
<span class="linenr"> 37: </span><span style="color: #84888b; font-style: italic;">project root directory. When this command is called for the first</span>
<span class="linenr"> 38: </span><span style="color: #84888b; font-style: italic;">time during a session, the user will be prompted to select the</span>
<span class="linenr"> 39: </span><span style="color: #84888b; font-style: italic;">root directory for their project. This directory is remembered</span>
<span class="linenr"> 40: </span><span style="color: #84888b; font-style: italic;">between calls"</span>
<span class="linenr"> 41: </span>  <span style="color: #a626a4;">(</span><span style="color: #e45649;">interactive</span> <span style="color: #50a14f;">(</span><span style="color: #b751b6;">list</span> <span style="color: #b751b6;">(</span><span style="color: #e45649;">if</span> org-publish-local-root org-publish-local-root
<span class="linenr"> 42: </span>                       <span style="color: #4078f2;">(</span><span style="color: #e45649;">setq</span> org-publish-local-root
<span class="linenr"> 43: </span>                             <span style="color: #a626a4;">(</span><span style="color: #a626a4;">read-directory-name</span> <span style="color: #50a14f;">"Select project root: "</span> <span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span><span style="color: #b751b6;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
<span class="linenr"> 44: </span>
<span class="linenr"> 45: </span>  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #b751b6;">(</span>config-file <span style="color: #4078f2;">(</span><span style="color: #b751b6;">concat</span> project-root <span style="color: #50a14f;">"export-config.el"</span><span style="color: #4078f2;">)</span><span style="color: #b751b6;">)</span><span style="color: #50a14f;">)</span>
<span class="linenr"> 46: </span>    <span style="color: #50a14f;">(</span><span style="color: #e45649;">when</span> <span style="color: #b751b6;">(</span><span style="color: #b751b6;">file-exists-p</span> config-file<span style="color: #b751b6;">)</span>
<span class="linenr"> 47: </span>      <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">file exists, so get the code from it</span>
<span class="linenr"> 48: </span>      <span style="color: #b751b6;">(</span><span style="color: #b751b6;">require</span> <span style="color: #4078f2;">'</span><span style="color: #b751b6;">ox-publish</span><span style="color: #b751b6;">)</span>
<span class="linenr"> 49: </span>      <span style="color: #b751b6;">(</span><span style="color: #b751b6;">load</span> config-file nil nil t<span style="color: #b751b6;">)</span>
<span class="linenr"> 50: </span>      <span style="color: #b751b6;">(</span><span style="color: #e45649;">let</span> <span style="color: #4078f2;">(</span>tmp-alist
<span class="linenr"> 51: </span>            <span style="color: #a626a4;">(</span><span style="color: #6a1868;">org-publish-use-timestamps-flag</span> nil<span style="color: #a626a4;">)</span>
<span class="linenr"> 52: </span>            <span style="color: #a626a4;">(</span>buffer-directory <span style="color: #50a14f;">(</span><span style="color: #b751b6;">file-name-directory</span> <span style="color: #b751b6;">(</span><span style="color: #6a1868;">buffer-file-name</span><span style="color: #b751b6;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span> <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">force all files to be published</span>
<span class="linenr"> 53: </span>
<span class="linenr"> 54: </span>        <span style="color: #4078f2;">(</span><span style="color: #e45649;">setq</span> org-publish-local-alist
<span class="linenr"> 55: </span>              <span style="color: #a626a4;">(</span><span style="color: #a626a4;">map</span> <span style="color: #4078f2;">'</span><span style="color: #986801;">list</span>
<span class="linenr"> 56: </span>                   <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #b751b6;">(</span>project<span style="color: #b751b6;">)</span>
<span class="linenr"> 57: </span>                     <span style="color: #b751b6;">(</span><span style="color: #b751b6;">cons</span> <span style="color: #4078f2;">(</span><span style="color: #b751b6;">car</span> project<span style="color: #4078f2;">)</span>
<span class="linenr"> 58: </span>                           <span style="color: #4078f2;">(</span><span style="color: #a626a4;">publish-local-fix-base-dir</span> org-publish-local-root
<span class="linenr"> 59: </span>                                                           <span style="color: #a626a4;">(</span><span style="color: #b751b6;">cdr</span> project<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span><span style="color: #b751b6;">)</span><span style="color: #50a14f;">)</span>
<span class="linenr"> 60: </span>                   org-publish-local-alist<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span class="linenr"> 61: </span>
<span class="linenr"> 62: </span>        <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">the org-publish-expand-project function requires that</span>
<span class="linenr"> 63: </span>        <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">org-publish-project-alist contain all projects. save the current</span>
<span class="linenr"> 64: </span>        <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">value of org-publish-project-alist, and restore it after this</span>
<span class="linenr"> 65: </span>        <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">function is ran.</span>
<span class="linenr"> 66: </span>        <span style="color: #4078f2;">(</span><span style="color: #e45649;">cl-rotatef</span> org-publish-local-alist <span style="color: #6a1868;">org-publish-project-alist</span><span style="color: #4078f2;">)</span>
<span class="linenr"> 67: </span>
<span class="linenr"> 68: </span>        <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">publish all files in the project. </span><span style="color: #50a14f; font-weight: bold;">NOTE:</span><span style="color: #9ca0a4;"> this might not actually work.</span>
<span class="linenr"> 69: </span>        <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">(cd org-publish-local-root)</span>
<span class="linenr"> 70: </span>        <span style="color: #4078f2;">(</span><span style="color: #a626a4;">org-publish-all</span> t<span style="color: #4078f2;">)</span>
<span class="linenr"> 71: </span>        <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">(cd buffer-directory)</span>
<span class="linenr"> 72: </span>
<span class="linenr"> 73: </span>        <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">restore project-alist variable</span>
<span class="linenr"> 74: </span>        <span style="color: #4078f2;">(</span><span style="color: #e45649;">cl-rotatef</span> org-publish-local-alist <span style="color: #6a1868;">org-publish-project-alist</span><span style="color: #4078f2;">)</span><span style="color: #b751b6;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span class="linenr"> 75: </span>
<span class="linenr"> 76: </span><span style="color: #4078f2;">(</span><span style="color: #e45649;">defun</span> <span style="color: #a626a4;">publish-local-fix-base-dir</span> <span style="color: #a626a4;">(</span>root-dir plist<span style="color: #a626a4;">)</span>
<span class="linenr"> 77: </span>  <span style="color: #84888b; font-style: italic;">"updates :base-directory in project plist to be a subdirectory of root-dir.</span>
<span class="linenr"> 78: </span>
<span class="linenr"> 79: </span><span style="color: #84888b; font-style: italic;">if :base-directory is absolute, then then this function simply</span>
<span class="linenr"> 80: </span><span style="color: #84888b; font-style: italic;">returns a copy of project. when :base-directory is relative, that</span>
<span class="linenr"> 81: </span><span style="color: #84888b; font-style: italic;">key is updated in a copy of project, which is returned.</span>
<span class="linenr"> 82: </span>
<span class="linenr"> 83: </span><span style="color: #84888b; font-style: italic;">root-dir is the directory where export-config.el is located. It</span>
<span class="linenr"> 84: </span><span style="color: #84888b; font-style: italic;">should be in the form of /foo/bar/</span>
<span class="linenr"> 85: </span>
<span class="linenr"> 86: </span><span style="color: #84888b; font-style: italic;">project is the project plist"</span>
<span class="linenr"> 87: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 88: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">org-publish-fix-base-dir</span>
<span class="linenr"> 89: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 90: </span>
<span class="linenr"> 91: </span>  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #b751b6;">(</span>new-plist <span style="color: #4078f2;">(</span><span style="color: #a626a4;">copy-tree</span> plist<span style="color: #4078f2;">)</span><span style="color: #b751b6;">)</span>
<span class="linenr"> 92: </span>        relative-dir<span style="color: #50a14f;">)</span>
<span class="linenr"> 93: </span>    <span style="color: #50a14f;">(</span><span style="color: #e45649;">dolist</span> <span style="color: #b751b6;">(</span>key <span style="color: #4078f2;">'</span><span style="color: #4078f2;">(</span><span style="color: #a626a4;">:base-directory</span> <span style="color: #a626a4;">:publishing-directory</span><span style="color: #4078f2;">)</span> new-plist<span style="color: #b751b6;">)</span>
<span class="linenr"> 94: </span>      <span style="color: #b751b6;">(</span><span style="color: #e45649;">setf</span> relative-dir <span style="color: #4078f2;">(</span><span style="color: #b751b6;">plist-get</span> plist key<span style="color: #4078f2;">)</span><span style="color: #b751b6;">)</span>
<span class="linenr"> 95: </span>      <span style="color: #b751b6;">(</span><span style="color: #e45649;">cond</span> <span style="color: #4078f2;">(</span><span style="color: #a626a4;">(</span><span style="color: #a626a4;">f-relative-p</span> root-dir<span style="color: #a626a4;">)</span>
<span class="linenr"> 96: </span>             <span style="color: #a626a4;">(</span><span style="color: #a626a4;">error</span> <span style="color: #50a14f;">"root-dir must be absolute: %S"</span> root-dir<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span class="linenr"> 97: </span>            <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">don't return error if base-directory is nil</span>
<span class="linenr"> 98: </span>            <span style="color: #4078f2;">(</span><span style="color: #a626a4;">(</span><span style="color: #e45649;">and</span> relative-dir
<span class="linenr"> 99: </span>                  <span style="color: #50a14f;">(</span><span style="color: #b751b6;">not</span> <span style="color: #b751b6;">(</span><span style="color: #b751b6;">directory-name-p</span> relative-dir<span style="color: #b751b6;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
<span class="linenr">100: </span>             <span style="color: #a626a4;">(</span><span style="color: #a626a4;">error</span> <span style="color: #50a14f;">"%S must be a directory. (did you mean  %S?)"</span>
<span class="linenr">101: </span>                    relative-dir
<span class="linenr">102: </span>                    <span style="color: #50a14f;">(</span><span style="color: #b751b6;">concat</span> relative-dir <span style="color: #50a14f;">"/"</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span><span style="color: #b751b6;">)</span>
<span class="linenr">103: </span>
<span class="linenr">104: </span>      <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">update key with either expanded or replaced filename</span>
<span class="linenr">105: </span>      <span style="color: #b751b6;">(</span><span style="color: #e45649;">setf</span> new-plist
<span class="linenr">106: </span>            <span style="color: #4078f2;">(</span><span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span><span style="color: #e45649;">and</span> relative-dir
<span class="linenr">107: </span>                     <span style="color: #50a14f;">(</span><span style="color: #a626a4;">f-relative-p</span> relative-dir<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
<span class="linenr">108: </span>                <span style="color: #a626a4;">(</span><span style="color: #b751b6;">plist-put</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">copy-tree</span> new-plist<span style="color: #50a14f;">)</span> key
<span class="linenr">109: </span>                           <span style="color: #50a14f;">(</span><span style="color: #b751b6;">expand-file-name</span> relative-dir root-dir<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
<span class="linenr">110: </span>              <span style="color: #a626a4;">(</span><span style="color: #a626a4;">copy-tree</span> new-plist<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span><span style="color: #b751b6;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span class="linenr">111: </span>
<span class="linenr">112: </span><span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">this function is no longer used in this file, but I like it so much, I can't</span>
<span class="linenr">113: </span><span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">bring myself to delete it.</span>
<span class="linenr">114: </span><span style="color: #4078f2;">(</span><span style="color: #e45649;">defun</span> <span style="color: #a626a4;">alist-update-key</span> <span style="color: #a626a4;">(</span>key value alist<span style="color: #a626a4;">)</span>
<span class="linenr">115: </span>  <span style="color: #84888b; font-style: italic;">"returns a new alist with the value at key updated.</span>
<span class="linenr">116: </span>
<span class="linenr">117: </span><span style="color: #84888b; font-style: italic;">The whole structure of the alist is copied over (ie copy-tree vs</span>
<span class="linenr">118: </span><span style="color: #84888b; font-style: italic;">copy-list). the result is an alist with key removed, and a new</span>
<span class="linenr">119: </span><span style="color: #84888b; font-style: italic;">element with key pushed to the front of the alist. "</span>
<span class="linenr">120: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">121: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">alist-update-key</span>
<span class="linenr">122: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">123: </span>  <span style="color: #a626a4;">(</span><span style="color: #b751b6;">cons</span> <span style="color: #50a14f;">(</span><span style="color: #b751b6;">list</span> key value<span style="color: #50a14f;">)</span>
<span class="linenr">124: </span>        <span style="color: #50a14f;">(</span><span style="color: #a626a4;">assq-delete-all</span> key <span style="color: #b751b6;">(</span><span style="color: #a626a4;">copy-tree</span> alist<span style="color: #b751b6;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2f84340" class="outline-2">
<h2 id="org2f84340">Courses at Penn State</h2>
<div class="outline-text-2" id="text-org2f84340">
<p>
There were a few classes in that I learned anything of substance during college.
</p>
</div>

<div id="outline-container-org672cdd5" class="outline-3">
<h3 id="org672cdd5">Computer Engineering 472</h3>
<div class="outline-text-3" id="text-org672cdd5">
<p>
The <a href="https://www.cse.psu.edu/~kxc104/class/cmpen472/23s/index.html">coures webpage</a> has a lot of information about the course. Professor Choi
updates the course from year to year, so the curriculum posted there probably
isn&rsquo;t exactly what I did.
</p>

<p>
We spent the semester programming the HC12 Microcontroller in Assembly. We
learned about many different programming techniques specific to embedded
systems:
</p>
<ul class="org-ul">
<li>Peripherals</li>
<li>Memory access/management</li>
<li>Interrupts</li>
<li>Using the stack</li>
</ul>

<p>
We were assigned homework every week, which consisted of writing various
routines. It was incredibly important to complete these routines because they
would be used in subsequent assignments. Many hard lessons about assembly were
learned in this class.
</p>

<p>
Some notable applications we made included a prefix notation calculator and a
command line memory editor. I remember my excitement when I punched in the
address for the command prompt and changed the symbol from a &rsquo;&gt;&rsquo; to &rsquo;$&rsquo;!
</p>

<p>
I have included the code from the first and last homework we completed in this
class to show the progression of program complexity.
</p>
</div>

<div id="outline-container-orgbe850b4" class="outline-4">
<h4 id="orgbe850b4">Homework 1</h4>
<div class="outline-text-4" id="text-orgbe850b4">
<div class="org-src-container">
<pre class="src src-asm"><span class="linenr"> 1: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">***********************************</span>
<span class="linenr"> 2: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr"> 3: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Title: StarFill (in Memory lane)</span>
<span class="linenr"> 4: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr"> 5: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Objective: COMPEN472 Homework 1</span>
<span class="linenr"> 6: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr"> 7: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Revision: V2</span>
<span class="linenr"> 8: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr"> 9: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Date: 27 Aug 2022</span>
<span class="linenr">10: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">11: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Programmer: Ethan Smith</span>
<span class="linenr">12: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">13: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Company: The Pennsylvania State University</span>
<span class="linenr">14: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Electrical Engineering and Computer Science</span>
<span class="linenr">15: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">16: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Algorithm: Simple while-loop demo of HCS12 assembly program</span>
<span class="linenr">17: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">18: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Register use: A accumulator: character data to be filled</span>
<span class="linenr">19: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*               B accumulator: counter, number of filled locations</span>
<span class="linenr">20: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*               X register: memory address pointer</span>
<span class="linenr">21: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">22: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Memory Use: RAM Locations from $3000 to $30C9</span>
<span class="linenr">23: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">24: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Input: Parameters hard coded in the program</span>
<span class="linenr">25: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">26: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Output: Data filled in memory locations, from $3000 to $30C9</span>
<span class="linenr">27: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">28: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Observation: This program is designed for instruction purpose.</span>
<span class="linenr">29: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* This program can be used as a 'loop' template</span>
<span class="linenr">30: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">31: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Note: This is a good example of program comments</span>
<span class="linenr">32: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* All Homework programs MUST have comments similar</span>
<span class="linenr">33: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* to this Homework 1 Program. So, please use this</span>
<span class="linenr">34: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* comment format for all your subsequent CMPEN 472</span>
<span class="linenr">35: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Homework programs.</span>
<span class="linenr">36: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">37: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Adding more explanations and comments help you and</span>
<span class="linenr">38: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* others to understand your program later.</span>
<span class="linenr">39: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">40: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Comments: This program is developed and simulated using CodeWarrior</span>
<span class="linenr">41: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* development software</span>
<span class="linenr">42: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">43: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*********************************************************</span>
<span class="linenr">44: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Parameter Declearation Section</span>
<span class="linenr">45: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">46: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Export Symbols</span>
<span class="linenr">47: </span>        <span style="color: #e45649;">XDEF</span>        Entry   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">export 'pgstart' symbol</span>
<span class="linenr">48: </span>        <span style="color: #e45649;">ABSENTRY</span>    Entry   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">for assembly entry point</span>
<span class="linenr">49: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Symbols and Macros</span>
<span class="linenr">50: </span><span style="color: #a626a4;">PORTA</span>   <span style="color: #e45649;">equ</span>         $0000   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">i/o port addresses</span>
<span class="linenr">51: </span><span style="color: #a626a4;">PORTB</span>   <span style="color: #e45649;">equ</span>         $0001
<span class="linenr">52: </span><span style="color: #a626a4;">DDRA</span>    <span style="color: #e45649;">equ</span>         $0002
<span class="linenr">53: </span><span style="color: #a626a4;">DDRB</span>    <span style="color: #e45649;">equ</span>         $0003
<span class="linenr">54: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*********************************************************</span>
<span class="linenr">55: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Data Section</span>
<span class="linenr">56: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">57: </span>        <span style="color: #e45649;">org</span>     $3000   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">reserved memory starting address</span>
<span class="linenr">58: </span><span style="color: #a626a4;">here</span>    <span style="color: #e45649;">DS.B</span>    $CA     <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">202 memory locations reserved</span>
<span class="linenr">59: </span><span style="color: #a626a4;">count</span>   <span style="color: #e45649;">DC.B</span>    $CA     <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">constant. star count = 202</span>
<span class="linenr">60: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*********************************************************</span>
<span class="linenr">61: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Program Section</span>
<span class="linenr">62: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">63: </span>        <span style="color: #e45649;">org</span>     $3100   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">program start address, in RAM</span>
<span class="linenr">64: </span><span style="color: #a626a4;">Entry</span>   <span style="color: #e45649;">ldaa</span>    #'*'    <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">load '*' into accumulator A</span>
<span class="linenr">65: </span>        <span style="color: #e45649;">ldab</span>    count   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">load star counter into B</span>
<span class="linenr">66: </span>        <span style="color: #e45649;">ldx</span>     #here   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">load address pointer into X</span>
<span class="linenr">67: </span><span style="color: #a626a4;">loop</span>    <span style="color: #e45649;">staa</span>    <span style="color: #50a14f;">0</span>, x    <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">put a star</span>
<span class="linenr">68: </span>        <span style="color: #e45649;">inx</span>             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">point to next location</span>
<span class="linenr">69: </span>        <span style="color: #e45649;">decb</span>            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">decrease counter</span>
<span class="linenr">70: </span>        <span style="color: #e45649;">bne</span>     loop    <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if not done, repeat</span>
<span class="linenr">71: </span><span style="color: #a626a4;">done</span>    <span style="color: #e45649;">bra</span>     done    <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">task finished</span>
<span class="linenr">72: </span>                        <span style="color: #9ca0a4;">;  </span><span style="color: #9ca0a4;">do nothing</span>
<span class="linenr">73: </span>
<span class="linenr">74: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">75: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Add any subroutines here</span>
<span class="linenr">76: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr">77: </span>
<span class="linenr">78: </span>        <span style="color: #e45649;">END</span>             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">last line of a file</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org616fd5b" class="outline-4">
<h4 id="org616fd5b">Homework 11</h4>
<div class="outline-text-4" id="text-org616fd5b">
<div class="org-src-container">
<pre class="src src-asm"><span class="linenr">   1: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Title:          Analog signal decoder/transmitter and generator</span>
<span class="linenr">   2: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">   3: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Objective:      CMPEN 472 Homework 11</span>
<span class="linenr">   4: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">   5: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Revision:       V3.2  for CodeWarrior 5.2 Debugger Simulation</span>
<span class="linenr">   6: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">   7: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Date:           30 November 2022</span>
<span class="linenr">   8: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">   9: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Programmer:     Ethan Smith</span>
<span class="linenr">  10: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  11: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Company:        The Pennsylvania State University</span>
<span class="linenr">  12: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">Department of Computer Science and Engineering</span>
<span class="linenr">  13: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  14: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Program:        Generates waves (saw, triangle, and square), outputting them over serial.</span>
<span class="linenr">  15: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">a timer runs in the background</span>
<span class="linenr">  16: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  17: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Algorithm:      Command line interface. The user is presented with a command</span>
<span class="linenr">  18: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">prompt on which they can type.</span>
<span class="linenr">  19: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  20: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">when the user hits enter, their input is validated.</span>
<span class="linenr">  21: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">if the input is valid, then it is parsed and evaluated.</span>
<span class="linenr">  22: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">otherwise, the program returns an error.</span>
<span class="linenr">  23: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  24: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">the clock is run using the RTI interrupt, which increments a counter.</span>
<span class="linenr">  25: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">this counter is checked periodically, and when it is 400 (set lower for</span>
<span class="linenr">  26: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">sim purposes), 1 second has elapsed, and the seconds/minutes counters are</span>
<span class="linenr">  27: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">also updated.</span>
<span class="linenr">  28: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  29: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">the waves are generated using the oc5 interrupt. Depending on the type of wave</span>
<span class="linenr">  30: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">desired, there are 3 separate ISRs which will be set in the ISR jump vector when</span>
<span class="linenr">  31: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">the appropriate command is run.</span>
<span class="linenr">  32: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  33: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">the ADC command creates another interrupt routine on oc5 which</span>
<span class="linenr">  34: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">reads from the ADC channel 7, and transmits the data to the</span>
<span class="linenr">  35: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">terminal</span>
<span class="linenr">  36: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  37: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Register use:   Various usages depending on the subroutine.</span>
<span class="linenr">  38: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">typically, X is used as input buffer pointer.</span>
<span class="linenr">  39: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">D is typically used as the data pointer.</span>
<span class="linenr">  40: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  41: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">each subroutine defines stack variables which are used throughout</span>
<span class="linenr">  42: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">the subroutine.</span>
<span class="linenr">  43: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  44: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Memory use:     RAM Locations from $3000 for data,</span>
<span class="linenr">  45: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">RAM Locations after data for program</span>
<span class="linenr">  46: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  47: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">RAM Locations from program to 4100 for SP</span>
<span class="linenr">  48: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  49: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  50: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Observation:    Clock which counts up and loops around to 0:00 after 9:59</span>
<span class="linenr">  51: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">can be set via tty s command.</span>
<span class="linenr">  52: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  53: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">clock can be stopped with the quit command</span>
<span class="linenr">  54: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  55: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">wave generator works as expected, with the caveat that the clock is slowed down</span>
<span class="linenr">  56: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">while the wave is being generated, because the simulator slows down while printing.</span>
<span class="linenr">  57: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  58: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">adc command works as expected. ADC channel 7 is sampled at</span>
<span class="linenr">  59: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">8000Hz. it returns 2048 samples worth of data over the</span>
<span class="linenr">  60: </span><span style="color: #9ca0a4;">;;;                 </span><span style="color: #9ca0a4;">serial output.</span>
<span class="linenr">  61: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  62: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr">  63: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Parameter Declearation Section</span>
<span class="linenr">  64: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">  65: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Export Symbols</span>
<span class="linenr">  66: </span>            <span style="color: #e45649;">XDEF</span>        pstart       <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">export 'pstart' symbol</span>
<span class="linenr">  67: </span>            <span style="color: #e45649;">ABSENTRY</span>    pstart       <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">for assembly entry point</span>
<span class="linenr">  68: </span>
<span class="linenr">  69: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Symbols and Macros</span>
<span class="linenr">  70: </span><span style="color: #a626a4;">PORTA</span>       <span style="color: #e45649;">EQU</span>         $0000        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">i/o port A addresses</span>
<span class="linenr">  71: </span><span style="color: #a626a4;">DDRA</span>        <span style="color: #e45649;">EQU</span>         $0002
<span class="linenr">  72: </span><span style="color: #a626a4;">PORTB</span>       <span style="color: #e45649;">EQU</span>         $0001        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">i/o port B addresses</span>
<span class="linenr">  73: </span><span style="color: #a626a4;">DDRB</span>        <span style="color: #e45649;">EQU</span>         $0003
<span class="linenr">  74: </span>
<span class="linenr">  75: </span><span style="color: #a626a4;">SCIBDH</span>      <span style="color: #e45649;">EQU</span>         $00C8        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Serial port (SCI) Baud Register H</span>
<span class="linenr">  76: </span><span style="color: #a626a4;">SCIBDL</span>      <span style="color: #e45649;">EQU</span>         $00C9        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Serial port (SCI) Baud Register L</span>
<span class="linenr">  77: </span><span style="color: #a626a4;">SCICR2</span>      <span style="color: #e45649;">EQU</span>         $00CB        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Serial port (SCI) Control Register 2</span>
<span class="linenr">  78: </span><span style="color: #a626a4;">SCISR1</span>      <span style="color: #e45649;">EQU</span>         $00CC        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Serial port (SCI) Status Register 1</span>
<span class="linenr">  79: </span><span style="color: #a626a4;">SCIDRL</span>      <span style="color: #e45649;">EQU</span>         $00CF        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Serial port (SCI) Data Register</span>
<span class="linenr">  80: </span>
<span class="linenr">  81: </span><span style="color: #a626a4;">TIOS</span>        <span style="color: #e45649;">EQU</span>         $0040        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Timer Input Capture (IC) or Output Compare (OC) select</span>
<span class="linenr">  82: </span><span style="color: #a626a4;">TIE</span>         <span style="color: #e45649;">EQU</span>         $004C        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Timer interrupt enable register</span>
<span class="linenr">  83: </span><span style="color: #a626a4;">TCNTH</span>       <span style="color: #e45649;">EQU</span>         $0044        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Timer free runing main counter</span>
<span class="linenr">  84: </span><span style="color: #a626a4;">TSCR1</span>       <span style="color: #e45649;">EQU</span>         $0046        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Timer system control 1</span>
<span class="linenr">  85: </span><span style="color: #a626a4;">TSCR2</span>       <span style="color: #e45649;">EQU</span>         $004D        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Timer system control 2</span>
<span class="linenr">  86: </span><span style="color: #a626a4;">TFLG1</span>       <span style="color: #e45649;">EQU</span>         $004E        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Timer interrupt flag 1</span>
<span class="linenr">  87: </span><span style="color: #a626a4;">TC5H</span>        <span style="color: #e45649;">EQU</span>         $005A        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Timer channel 5 register</span>
<span class="linenr">  88: </span>
<span class="linenr">  89: </span><span style="color: #a626a4;">CRGFLG</span>      <span style="color: #e45649;">EQU</span>         $0037        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Clock and Reset Generator Flags</span>
<span class="linenr">  90: </span><span style="color: #a626a4;">CRGINT</span>      <span style="color: #e45649;">EQU</span>         $0038        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Clock and Reset Generator Interrupts</span>
<span class="linenr">  91: </span><span style="color: #a626a4;">RTICTL</span>      <span style="color: #e45649;">EQU</span>         $003B        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Real Time Interrupt Control</span>
<span class="linenr">  92: </span>
<span class="linenr">  93: </span><span style="color: #a626a4;">ATDCTL2</span>     <span style="color: #e45649;">EQU</span>  $0082               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Analog-to-Digital Converter (ADC) registers</span>
<span class="linenr">  94: </span><span style="color: #a626a4;">ATDCTL3</span>     <span style="color: #e45649;">EQU</span>  $0083
<span class="linenr">  95: </span><span style="color: #a626a4;">ATDCTL4</span>     <span style="color: #e45649;">EQU</span>  $0084
<span class="linenr">  96: </span><span style="color: #a626a4;">ATDCTL5</span>     <span style="color: #e45649;">EQU</span>  $0085
<span class="linenr">  97: </span><span style="color: #a626a4;">ATDSTAT0</span>    <span style="color: #e45649;">EQU</span>  $0086
<span class="linenr">  98: </span><span style="color: #a626a4;">ATDDR0H</span>     <span style="color: #e45649;">EQU</span>  $0090
<span class="linenr">  99: </span><span style="color: #a626a4;">ATDDR0L</span>     <span style="color: #e45649;">EQU</span>  $0091
<span class="linenr"> 100: </span><span style="color: #a626a4;">ATDDR7H</span>     <span style="color: #e45649;">EQU</span>  $009e
<span class="linenr"> 101: </span><span style="color: #a626a4;">ATDDR7L</span>     <span style="color: #e45649;">EQU</span>  $009f
<span class="linenr"> 102: </span>
<span class="linenr"> 103: </span><span style="color: #a626a4;">BS</span>          <span style="color: #e45649;">equ</span>         $08          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">backspace character</span>
<span class="linenr"> 104: </span><span style="color: #a626a4;">CR</span>          <span style="color: #e45649;">equ</span>         $0d          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">carriage return, ASCII 'Return' key</span>
<span class="linenr"> 105: </span><span style="color: #a626a4;">LF</span>          <span style="color: #e45649;">equ</span>         $0a          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">line feed, ASCII 'next line' character</span>
<span class="linenr"> 106: </span><span style="color: #a626a4;">NULL</span>        <span style="color: #e45649;">equ</span>         $00          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">null terminator</span>
<span class="linenr"> 107: </span>
<span class="linenr"> 108: </span><span style="color: #a626a4;">DATAmax</span>     <span style="color: #e45649;">equ</span>         <span style="color: #50a14f;">2048</span>         <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Data count maximum, 1024 constant</span>
<span class="linenr"> 109: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr"> 110: </span>
<span class="linenr"> 111: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr"> 112: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Interrupt Vector Section</span>
<span class="linenr"> 113: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">org     $3FF0               ; RTI interrupt vector setup for CSM-128 board</span>
<span class="linenr"> 114: </span>            <span style="color: #e45649;">org</span>     $FFF0               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">RTI interrupt vector setup for the simulator</span>
<span class="linenr"> 115: </span>            <span style="color: #e45649;">DC.W</span>    rtiisr              <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">place the address of the ISR at this location</span>
<span class="linenr"> 116: </span>
<span class="linenr"> 117: </span>            <span style="color: #e45649;">ORG</span>     $FFE4       <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Timer channel 5 interrupt vector setup, on simulator</span>
<span class="linenr"> 118: </span><span style="color: #a626a4;">oc5isr</span>      <span style="color: #e45649;">DC.W</span>    $0000
<span class="linenr"> 119: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr"> 120: </span>
<span class="linenr"> 121: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr"> 122: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Data Section: address used [ $3000 to $30FF ] RAM memory</span>
<span class="linenr"> 123: </span>            <span style="color: #e45649;">ORG</span>         $3000        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Reserved RAM memory starting address</span>
<span class="linenr"> 124: </span>                                     <span style="color: #9ca0a4;">;   </span><span style="color: #9ca0a4;">for Data for CMPEN 472 class</span>
<span class="linenr"> 125: </span>
<span class="linenr"> 126: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">convenience string for sending newlines to terminal</span>
<span class="linenr"> 127: </span><span style="color: #a626a4;">NEWLINE</span>     <span style="color: #e45649;">DC.B</span>         CR, LF, NULL
<span class="linenr"> 128: </span>
<span class="linenr"> 129: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">the menu which is printed when the program first starts</span>
<span class="linenr"> 130: </span><span style="color: #a626a4;">MENU</span>        <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"Wave Generation Program"</span>, CR, LF
<span class="linenr"> 131: </span>            <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"use 'gw' to generate a sawtooth wave"</span>, CR, LF
<span class="linenr"> 132: </span>            <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"use 'gt' to generate a triangle wave"</span>, CR, LF
<span class="linenr"> 133: </span>            <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"use 'gq' to generate a square wave"</span>, CR, LF
<span class="linenr"> 134: </span>            <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"use 's M:SS' to set the current time"</span>, CR, LF
<span class="linenr"> 135: </span>            <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"use 'q' to quit the program and stop the clock"</span>, CR, LF, NULL
<span class="linenr"> 136: </span>
<span class="linenr"> 137: </span><span style="color: #a626a4;">PROMPT</span>      <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"HW11&gt; "</span>, NULL
<span class="linenr"> 138: </span><span style="color: #a626a4;">QUIT_MSG</span>    <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"Stopping Clock..."</span>, CR, LF
<span class="linenr"> 139: </span>            <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"Typewriter Program Started..."</span>, CR, LF, NULL
<span class="linenr"> 140: </span>
<span class="linenr"> 141: </span><span style="color: #a626a4;">BUFF_ERR</span>    <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"Buffer Error"</span>, CR, LF, NULL
<span class="linenr"> 142: </span><span style="color: #a626a4;">FMT_ERR</span>     <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"Format Error: proper format is 's M:SS'. M=[0,9] SS=[00,59]"</span>, CR, LF, NULL
<span class="linenr"> 143: </span><span style="color: #a626a4;">FMT_ERR2</span>    <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"Format Error: you can only generate sawtooth (gw) triangle (gt) or square (gq) waves"</span>, CR, LF, NULL
<span class="linenr"> 144: </span><span style="color: #a626a4;">CMD_ERR</span>     <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"Command Error: valid commands are"</span>, CR, LF
<span class="linenr"> 145: </span>            <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"                            's'  : set time"</span>, CR, LF
<span class="linenr"> 146: </span>            <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"                            'gw' : sawtooth wave generation"</span>, CR, LF
<span class="linenr"> 147: </span>            <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"                            'qt' : triangle wave generation"</span>, CR, LF
<span class="linenr"> 148: </span>            <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"                            'gq' : square wave generation"</span>, CR, LF
<span class="linenr"> 149: </span>            <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"                            'adc': get and print analog wave"</span>, CR, LF
<span class="linenr"> 150: </span>            <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"                            'q'  : quit"</span>, CR, LF, NULL
<span class="linenr"> 151: </span>
<span class="linenr"> 152: </span><span style="color: #a626a4;">msg3</span>        <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"&gt; Be sure to start saving Terminal data: open Output file = RxData3.txt"</span>, CR, LF, NULL
<span class="linenr"> 153: </span><span style="color: #a626a4;">msg4</span>        <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"&gt; press any key to continue..."</span>, CR, LF, CR, LF, NULL
<span class="linenr"> 154: </span><span style="color: #a626a4;">msg5</span>        <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"&gt; Done!  Close Output file."</span>, CR, LF, NULL
<span class="linenr"> 155: </span><span style="color: #a626a4;">msg6</span>        <span style="color: #e45649;">DC.B</span>   <span style="color: #50a14f;">"&gt; Ready for next data transmission."</span>, CR, LF, NULL
<span class="linenr"> 156: </span>
<span class="linenr"> 157: </span><span style="color: #a626a4;">ctr125u</span>     <span style="color: #e45649;">DS.W</span>   <span style="color: #50a14f;">1</span>            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">16bit interrupt counter for 125 uSec. of time</span>
<span class="linenr"> 158: </span>
<span class="linenr"> 159: </span><span style="color: #a626a4;">BUF</span>         <span style="color: #e45649;">DS.B</span>   <span style="color: #50a14f;">6</span>            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">character buffer for a 16bit number in decimal ASCII</span>
<span class="linenr"> 160: </span><span style="color: #a626a4;">CTR</span>         <span style="color: #e45649;">DS.B</span>   <span style="color: #50a14f;">1</span>            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">character buffer fill count</span>
<span class="linenr"> 161: </span>
<span class="linenr"> 162: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">ADC variables</span>
<span class="linenr"> 163: </span><span style="color: #a626a4;">ATDdone</span>     <span style="color: #e45649;">DS.B</span>   <span style="color: #50a14f;">1</span>
<span class="linenr"> 164: </span>
<span class="linenr"> 165: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">input and output string buffers</span>
<span class="linenr"> 166: </span><span style="color: #a626a4;">buffer</span>    <span style="color: #e45649;">DS</span>      <span style="color: #50a14f;">30</span>      <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">30 bytes for user input</span>
<span class="linenr"> 167: </span>
<span class="linenr"> 168: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">global variables for the current time</span>
<span class="linenr"> 169: </span><span style="color: #a626a4;">timem</span>       <span style="color: #e45649;">DS.B</span>    <span style="color: #50a14f;">1</span>           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">minute</span>
<span class="linenr"> 170: </span><span style="color: #a626a4;">times</span>       <span style="color: #e45649;">DS.B</span>    <span style="color: #50a14f;">1</span>           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">second</span>
<span class="linenr"> 171: </span>
<span class="linenr"> 172: </span><span style="color: #a626a4;">ctr2p5m</span>     <span style="color: #e45649;">DS.W</span>    <span style="color: #50a14f;">1</span>           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">interrupt counter for 2.5msec</span>
<span class="linenr"> 173: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr"> 174: </span>
<span class="linenr"> 175: </span>
<span class="linenr"> 176: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr"> 177: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Program Section: address used [ end of DATA to $3FFF ] RAM memory</span>
<span class="linenr"> 178: </span>
<span class="linenr"> 179: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">char* buffer;</span>
<span class="linenr"> 180: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 181: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">while(true) {</span>
<span class="linenr"> 182: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">update_leds();</span>
<span class="linenr"> 183: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">print("Clock&gt; ");</span>
<span class="linenr"> 184: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">read_line(buffer);  // get user input</span>
<span class="linenr"> 185: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">eval_input(buffer); // send user input to eval subroutine</span>
<span class="linenr"> 186: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">}</span>
<span class="linenr"> 187: </span><span style="color: #a626a4;">pstart</span>
<span class="linenr"> 188: </span>    <span style="color: #e45649;">lds</span>     #$4100              <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">initialize stack pointer</span>
<span class="linenr"> 189: </span>
<span class="linenr"> 190: </span>    <span style="color: #e45649;">ldaa</span>    #<span style="color: #6a1868;">%11111111</span>          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">set all PORTA/B bits as output</span>
<span class="linenr"> 191: </span>    <span style="color: #e45649;">staa</span>    DDRB                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 192: </span>    <span style="color: #e45649;">staa</span>    DDRA                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 193: </span>
<span class="linenr"> 194: </span>    <span style="color: #e45649;">ldaa</span>    #<span style="color: #6a1868;">%00000000</span>          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">clear PORTA/B</span>
<span class="linenr"> 195: </span>    <span style="color: #e45649;">staa</span>    PORTB               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 196: </span>    <span style="color: #e45649;">staa</span>    PORTA               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 197: </span>
<span class="linenr"> 198: </span>    <span style="color: #e45649;">ldaa</span>    #$0C         <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Enable SCI port Tx and Rx units</span>
<span class="linenr"> 199: </span>    <span style="color: #e45649;">staa</span>    SCICR2       <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">disable SCI interrupts</span>
<span class="linenr"> 200: </span>
<span class="linenr"> 201: </span>    <span style="color: #e45649;">ldd</span>     #$0001       <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Set SCI Baud Register = $0001 =&gt; 1.5M baud at 24MHz (for simulation)</span>
<span class="linenr"> 202: </span><span style="color: #9ca0a4;">;   </span><span style="color: #9ca0a4;">ldd     #$0002       ; Set SCI Baud Register = $0002 =&gt; 750K baud at 24MHz</span>
<span class="linenr"> 203: </span><span style="color: #9ca0a4;">;   </span><span style="color: #9ca0a4;">ldd     #$000D       ; Set SCI Baud Register = $000D =&gt; 115200 baud at 24MHz</span>
<span class="linenr"> 204: </span><span style="color: #9ca0a4;">;   </span><span style="color: #9ca0a4;">ldd     #$009C       ; Set SCI Baud Register = $009C =&gt; 9600 baud at 24MHz</span>
<span class="linenr"> 205: </span>    <span style="color: #e45649;">std</span>     SCIBDH       <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">SCI port baud rate change</span>
<span class="linenr"> 206: </span>
<span class="linenr"> 207: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">RTI ISR configuration</span>
<span class="linenr"> 208: </span>    <span style="color: #e45649;">bset</span>   RTICTL,<span style="color: #6a1868;">%00011001</span> <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">set RTI: dev=10*(2**10)=2.555msec for C128 board</span>
<span class="linenr"> 209: </span>                            <span style="color: #9ca0a4;">;      </span><span style="color: #9ca0a4;">4MHz quartz oscillator clock</span>
<span class="linenr"> 210: </span>    <span style="color: #e45649;">bset</span>   CRGINT,<span style="color: #6a1868;">%10000000</span> <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">enable RTI interrupt</span>
<span class="linenr"> 211: </span>    <span style="color: #e45649;">bset</span>   CRGFLG,<span style="color: #6a1868;">%10000000</span> <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">clear RTI IF (Interrupt Flag)</span>
<span class="linenr"> 212: </span>
<span class="linenr"> 213: </span>    <span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">ATD initialization</span>
<span class="linenr"> 214: </span>    <span style="color: #e45649;">ldaa</span>    #<span style="color: #6a1868;">%11000000</span>       <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Turn ON ADC, clear flags, Disable ATD interrupt</span>
<span class="linenr"> 215: </span>    <span style="color: #e45649;">staa</span>    ATDCTL2
<span class="linenr"> 216: </span>    <span style="color: #e45649;">ldaa</span>    #<span style="color: #6a1868;">%00001000</span>       <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Single conversion per sequence, no FIFO</span>
<span class="linenr"> 217: </span>    <span style="color: #e45649;">staa</span>    ATDCTL3
<span class="linenr"> 218: </span>    <span style="color: #e45649;">ldaa</span>    #<span style="color: #6a1868;">%10000111</span>       <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">8bit, ADCLK=24MHz/16=1.5MHz, sampling time=2*(1/ADCLK)</span>
<span class="linenr"> 219: </span>    <span style="color: #e45649;">staa</span>    ATDCTL4          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">for SIMULATION</span>
<span class="linenr"> 220: </span>
<span class="linenr"> 221: </span>    <span style="color: #e45649;">ldx</span>    #<span style="color: #50a14f;">0</span>
<span class="linenr"> 222: </span>    <span style="color: #e45649;">stx</span>    ctr2p5m          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">initialize interrupt counter with 0.</span>
<span class="linenr"> 223: </span>    <span style="color: #e45649;">cli</span>                     <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">enable interrupt, global</span>
<span class="linenr"> 224: </span>
<span class="linenr"> 225: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">print the menu</span>
<span class="linenr"> 226: </span>    <span style="color: #e45649;">ldx</span>     #MENU
<span class="linenr"> 227: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 228: </span>
<span class="linenr"> 229: </span>    <span style="color: #e45649;">ldx</span>     #PROMPT
<span class="linenr"> 230: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 231: </span>
<span class="linenr"> 232: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">get user input and evaluate the command</span>
<span class="linenr"> 233: </span>    <span style="color: #e45649;">ldx</span>     #buffer             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">load input_buffer</span>
<span class="linenr"> 234: </span>
<span class="linenr"> 235: </span><span style="color: #a626a4;">looop</span>
<span class="linenr"> 236: </span>    <span style="color: #e45649;">jsr</span>     update_LEDs      <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">make sure clock LEDs are updated</span>
<span class="linenr"> 237: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">prompt the user for a command</span>
<span class="linenr"> 238: </span>    <span style="color: #e45649;">jsr</span>     getchar             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">type writer - check the key board</span>
<span class="linenr"> 239: </span>    <span style="color: #e45649;">cmpa</span>    #$00                <span style="color: #9ca0a4;">;  </span><span style="color: #9ca0a4;">if nothing typed, keep checking</span>
<span class="linenr"> 240: </span>    <span style="color: #e45649;">beq</span>     looop
<span class="linenr"> 241: </span>
<span class="linenr"> 242: </span>    <span style="color: #e45649;">cmpa</span>    #CR                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">was an enter typed?</span>
<span class="linenr"> 243: </span>    <span style="color: #e45649;">beq</span>     on_enter            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 244: </span>
<span class="linenr"> 245: </span>    <span style="color: #e45649;">cmpa</span>    #BS                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">| was a backspace typed?</span>
<span class="linenr"> 246: </span>    <span style="color: #e45649;">beq</span>     on_backspace        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 247: </span>
<span class="linenr"> 248: </span>    <span style="color: #e45649;">cpx</span>     #buffer+<span style="color: #50a14f;">30</span>          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">is there enough space in the input buffer?</span>
<span class="linenr"> 249: </span>    <span style="color: #e45649;">bls</span>     append              <span style="color: #9ca0a4;">;  </span><span style="color: #9ca0a4;">if yes, append input to input buffer</span>
<span class="linenr"> 250: </span>
<span class="linenr"> 251: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">there is not enough space in the buffer, clear it (by reseting X)</span>
<span class="linenr"> 252: </span>    <span style="color: #9ca0a4;">;;  </span><span style="color: #9ca0a4;">and report an error</span>
<span class="linenr"> 253: </span><span style="color: #a626a4;">clr_buf</span>
<span class="linenr"> 254: </span>    <span style="color: #e45649;">ldx</span>     #NEWLINE            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">print a newline</span>
<span class="linenr"> 255: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 256: </span>
<span class="linenr"> 257: </span>    <span style="color: #e45649;">ldx</span>     #BUFF_ERR           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">print 'invalid command'</span>
<span class="linenr"> 258: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 259: </span>
<span class="linenr"> 260: </span>    <span style="color: #e45649;">ldx</span>     #NEWLINE            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">print a newline</span>
<span class="linenr"> 261: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 262: </span>
<span class="linenr"> 263: </span>    <span style="color: #e45649;">ldx</span>     #PROMPT
<span class="linenr"> 264: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 265: </span>
<span class="linenr"> 266: </span>    <span style="color: #e45649;">ldx</span>     #buffer             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">reset input_buffer</span>
<span class="linenr"> 267: </span>    <span style="color: #e45649;">bra</span>     looop               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">re-enter loop</span>
<span class="linenr"> 268: </span>
<span class="linenr"> 269: </span>
<span class="linenr"> 270: </span><span style="color: #a626a4;">append</span>
<span class="linenr"> 271: </span>    <span style="color: #e45649;">staa</span>    <span style="color: #50a14f;">1</span>,X+                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">store the the typed character, and move the pointer</span>
<span class="linenr"> 272: </span>    <span style="color: #e45649;">clr</span>     X                   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">null terminate</span>
<span class="linenr"> 273: </span>
<span class="linenr"> 274: </span>    <span style="color: #e45649;">jsr</span>     putchar             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">display typed character in terminal</span>
<span class="linenr"> 275: </span>    <span style="color: #e45649;">bra</span>     looop               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">get next character</span>
<span class="linenr"> 276: </span>
<span class="linenr"> 277: </span><span style="color: #a626a4;">on_enter</span>
<span class="linenr"> 278: </span>    <span style="color: #e45649;">ldx</span>     #buffer             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">set input for evaluate_cmd</span>
<span class="linenr"> 279: </span>
<span class="linenr"> 280: </span>    <span style="color: #e45649;">ldaa</span>    X                   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if the user just pressed enter, without typing anything</span>
<span class="linenr"> 281: </span>    <span style="color: #e45649;">cmpa</span>    #NULL               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">just print a new prompt (don't call evaluate)</span>
<span class="linenr"> 282: </span>    <span style="color: #e45649;">beq</span>     blank_line          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 283: </span>
<span class="linenr"> 284: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">the user actually typed something</span>
<span class="linenr"> 285: </span>    <span style="color: #e45649;">jsr</span>     eval                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">check the command</span>
<span class="linenr"> 286: </span>
<span class="linenr"> 287: </span><span style="color: #a626a4;">blank_line</span>
<span class="linenr"> 288: </span>    <span style="color: #e45649;">ldx</span>     #NEWLINE            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">print a newline</span>
<span class="linenr"> 289: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 290: </span>
<span class="linenr"> 291: </span>    <span style="color: #e45649;">ldx</span>     #PROMPT
<span class="linenr"> 292: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 293: </span>
<span class="linenr"> 294: </span>    <span style="color: #e45649;">ldx</span>     #buffer             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">reset input_buffer</span>
<span class="linenr"> 295: </span>    <span style="color: #e45649;">clr</span>     X                   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">NULL terminate beginning of input buffer to clear it.</span>
<span class="linenr"> 296: </span>
<span class="linenr"> 297: </span>    <span style="color: #e45649;">bra</span>     looop               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">get next command</span>
<span class="linenr"> 298: </span>
<span class="linenr"> 299: </span><span style="color: #a626a4;">on_backspace</span>
<span class="linenr"> 300: </span>    <span style="color: #e45649;">cpx</span>     #buffer             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">ensure that there are characters to delete</span>
<span class="linenr"> 301: </span>    <span style="color: #e45649;">beq</span>     looop               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if there is nothing in the buffer, return to looop</span>
<span class="linenr"> 302: </span>
<span class="linenr"> 303: </span>    <span style="color: #e45649;">clr</span>     <span style="color: #50a14f;">1</span>,-X                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">delete the last character, move pointer</span>
<span class="linenr"> 304: </span>    <span style="color: #e45649;">pshx</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">store this value on stack so we can use X to print stuff</span>
<span class="linenr"> 305: </span>
<span class="linenr"> 306: </span>    <span style="color: #e45649;">ldaa</span>    #LF                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">move cursor to beginning of line</span>
<span class="linenr"> 307: </span>    <span style="color: #e45649;">jsr</span>     putchar             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 308: </span>
<span class="linenr"> 309: </span>    <span style="color: #e45649;">ldx</span>     #PROMPT             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">print as new prompt</span>
<span class="linenr"> 310: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 311: </span>
<span class="linenr"> 312: </span>    <span style="color: #e45649;">ldx</span>     #buffer             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">print the input buffer</span>
<span class="linenr"> 313: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 314: </span>
<span class="linenr"> 315: </span>    <span style="color: #e45649;">pulx</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">restore current location of cursor in buffer</span>
<span class="linenr"> 316: </span>
<span class="linenr"> 317: </span>    <span style="color: #e45649;">bra</span>     looop
<span class="linenr"> 318: </span>
<span class="linenr"> 319: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">subroutine section below</span>
<span class="linenr"> 320: </span>
<span class="linenr"> 321: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">eval</span>
<span class="linenr"> 322: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 323: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Program:    validates input and executes the command</span>
<span class="linenr"> 324: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 325: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Input:      X Register: buffer</span>
<span class="linenr"> 326: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 327: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Algorithm:</span>
<span class="linenr"> 328: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">checks if command is s or q. if not, then exit to command error.</span>
<span class="linenr"> 329: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 330: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">if command is s:</span>
<span class="linenr"> 331: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">is the rest of the command in this format: M:SS? (where M is [0,9], S is [00,59])</span>
<span class="linenr"> 332: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">if so, then set the minutes and seconds variables.</span>
<span class="linenr"> 333: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">else, exit format error.</span>
<span class="linenr"> 334: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 335: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">if command is q:</span>
<span class="linenr"> 336: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">check and make the buffer only contains q</span>
<span class="linenr"> 337: </span><span style="color: #9ca0a4;">;;;             </span><span style="color: #9ca0a4;">if not, exit command error</span>
<span class="linenr"> 338: </span><span style="color: #9ca0a4;">;;;             </span><span style="color: #9ca0a4;">else, print quit message, enter typewriter program</span>
<span class="linenr"> 339: </span><span style="color: #a626a4;">eval</span>
<span class="linenr"> 340: </span>    <span style="color: #e45649;">pshx</span>
<span class="linenr"> 341: </span>    <span style="color: #e45649;">pshy</span>
<span class="linenr"> 342: </span>    <span style="color: #e45649;">psha</span>
<span class="linenr"> 343: </span>
<span class="linenr"> 344: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X+                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">A = command (every command is just one character)</span>
<span class="linenr"> 345: </span>    <span style="color: #e45649;">cmpa</span>    #'s'                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">does command == 's'?</span>
<span class="linenr"> 346: </span>    <span style="color: #e45649;">beq</span>     eval_set_time       <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if so, validate and execute it.</span>
<span class="linenr"> 347: </span>
<span class="linenr"> 348: </span>    <span style="color: #e45649;">cmpa</span>    #'g'                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">does command == 'g'?</span>
<span class="linenr"> 349: </span>    <span style="color: #e45649;">beq</span>     eval_gen_sig        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if so, validate and execute it.</span>
<span class="linenr"> 350: </span>
<span class="linenr"> 351: </span>    <span style="color: #e45649;">cmpa</span>    #'a'                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">does command == 'a'?</span>
<span class="linenr"> 352: </span>    <span style="color: #e45649;">lbeq</span>     eval_adc            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if so, see if it is 'adc'</span>
<span class="linenr"> 353: </span>
<span class="linenr"> 354: </span>    <span style="color: #e45649;">cmpa</span>    #'q'                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">does command == 'q'?</span>
<span class="linenr"> 355: </span>    <span style="color: #e45649;">lbeq</span>     eval_quit           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if so, validate and execute it.</span>
<span class="linenr"> 356: </span>
<span class="linenr"> 357: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">the command didn't match anything, so exit failure</span>
<span class="linenr"> 358: </span>    <span style="color: #e45649;">lbra</span>     eval_exit_cmd_error
<span class="linenr"> 359: </span>
<span class="linenr"> 360: </span><span style="color: #a626a4;">eval_set_time</span>
<span class="linenr"> 361: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X+                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">is the input in the format of "s M:SS"?</span>
<span class="linenr"> 362: </span>    <span style="color: #e45649;">cmpa</span>    #' '                <span style="color: #9ca0a4;">;    </span><span style="color: #9ca0a4;">if not, jump to exit_error</span>
<span class="linenr"> 363: </span>    <span style="color: #e45649;">lbne</span>    eval_exit_error      <span style="color: #9ca0a4;">;    </span><span style="color: #9ca0a4;">else, continue</span>
<span class="linenr"> 364: </span>                                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 365: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X+                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 366: </span>    <span style="color: #e45649;">jsr</span>     is_dig              <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 367: </span>    <span style="color: #e45649;">lbne</span>     eval_exit_error     <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 368: </span>                                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 369: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X+                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 370: </span>    <span style="color: #e45649;">cmpa</span>    #':'                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 371: </span>    <span style="color: #e45649;">lbne</span>     eval_exit_error     <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 372: </span>                                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 373: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X+                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 374: </span>    <span style="color: #e45649;">jsr</span>     is_dig              <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 375: </span>    <span style="color: #e45649;">lbne</span>     eval_exit_error     <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 376: </span>                                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 377: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X+                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 378: </span>    <span style="color: #e45649;">jsr</span>     is_dig              <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 379: </span>    <span style="color: #e45649;">lbne</span>     eval_exit_error     <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 380: </span>                                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 381: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X+                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 382: </span>    <span style="color: #e45649;">cmpa</span>    #NULL               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 383: </span>    <span style="color: #e45649;">lbne</span>     eval_exit_error     <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 384: </span>
<span class="linenr"> 385: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">at this point, we know the buffer is properly formatted</span>
<span class="linenr"> 386: </span>    <span style="color: #e45649;">ldx</span>     <span style="color: #50a14f;">3</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">reset buffer pointer</span>
<span class="linenr"> 387: </span>    <span style="color: #e45649;">leax</span>    <span style="color: #50a14f;">4</span>,X                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">load address of seconds number</span>
<span class="linenr"> 388: </span>    <span style="color: #e45649;">jsr</span>     atoi                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">convert number at address from ascii to integer</span>
<span class="linenr"> 389: </span>
<span class="linenr"> 390: </span>    <span style="color: #e45649;">cpd</span>     #<span style="color: #50a14f;">59</span>                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if seconds &gt; 59 then:</span>
<span class="linenr"> 391: </span>    <span style="color: #e45649;">lbhi</span>     eval_exit_error     <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">invalid time input, exit error</span>
<span class="linenr"> 392: </span>
<span class="linenr"> 393: </span>    <span style="color: #e45649;">stab</span>    times               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">store lower 8 bits of output to seconds variable</span>
<span class="linenr"> 394: </span>
<span class="linenr"> 395: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">store the minutes now that we know the seconds are valid</span>
<span class="linenr"> 396: </span>    <span style="color: #e45649;">ldx</span>     <span style="color: #50a14f;">3</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">reset buffer pointer</span>
<span class="linenr"> 397: </span>    <span style="color: #e45649;">leax</span>    <span style="color: #50a14f;">2</span>,X                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">load address of first digit</span>
<span class="linenr"> 398: </span>    <span style="color: #e45649;">ldaa</span>    X                   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">A = first digit</span>
<span class="linenr"> 399: </span>    <span style="color: #e45649;">suba</span>    #$30                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Convert A from ascii to integer</span>
<span class="linenr"> 400: </span>
<span class="linenr"> 401: </span>    <span style="color: #e45649;">staa</span>    timem               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">store to minutes variable</span>
<span class="linenr"> 402: </span>
<span class="linenr"> 403: </span>    <span style="color: #e45649;">lbra</span>     eval_exit           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">exit subroutine</span>
<span class="linenr"> 404: </span>
<span class="linenr"> 405: </span><span style="color: #a626a4;">eval_gen_sig</span>
<span class="linenr"> 406: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X+
<span class="linenr"> 407: </span>    <span style="color: #e45649;">cmpa</span>    #'w'
<span class="linenr"> 408: </span>    <span style="color: #e45649;">beq</span>     eval_sig_valid
<span class="linenr"> 409: </span>    <span style="color: #e45649;">cmpa</span>    #'t'
<span class="linenr"> 410: </span>    <span style="color: #e45649;">beq</span>     eval_sig_valid
<span class="linenr"> 411: </span>    <span style="color: #e45649;">cmpa</span>    #'q'
<span class="linenr"> 412: </span>    <span style="color: #e45649;">beq</span>     eval_sig_valid
<span class="linenr"> 413: </span>    <span style="color: #e45649;">lbra</span>    eval_exit_error2
<span class="linenr"> 414: </span>
<span class="linenr"> 415: </span><span style="color: #a626a4;">eval_sig_valid</span>
<span class="linenr"> 416: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X-                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">move pointer back to the wave specifier</span>
<span class="linenr"> 417: </span>    <span style="color: #e45649;">cmpa</span>    #NULL
<span class="linenr"> 418: </span>    <span style="color: #e45649;">lbne</span>    eval_exit_error2    <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">exit error</span>
<span class="linenr"> 419: </span>    <span style="color: #e45649;">tfr</span>     X,Y                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">Move X to Y, so X can be used for print</span>
<span class="linenr"> 420: </span>
<span class="linenr"> 421: </span>    <span style="color: #e45649;">ldx</span>     #NEWLINE
<span class="linenr"> 422: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 423: </span>    <span style="color: #e45649;">ldx</span>     #msg3
<span class="linenr"> 424: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 425: </span>    <span style="color: #e45649;">ldx</span>     #msg4
<span class="linenr"> 426: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 427: </span>
<span class="linenr"> 428: </span><span style="color: #a626a4;">eval_sig_get_key</span>
<span class="linenr"> 429: </span>    <span style="color: #e45649;">jsr</span>     update_LEDs
<span class="linenr"> 430: </span>    <span style="color: #e45649;">jsr</span>     getchar
<span class="linenr"> 431: </span>    <span style="color: #e45649;">cmpa</span>    #NULL
<span class="linenr"> 432: </span>    <span style="color: #e45649;">beq</span>     eval_sig_get_key
<span class="linenr"> 433: </span>
<span class="linenr"> 434: </span>    <span style="color: #e45649;">ldx</span>     #<span style="color: #50a14f;">0</span>                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">reset counter</span>
<span class="linenr"> 435: </span>    <span style="color: #e45649;">stx</span>     ctr125u
<span class="linenr"> 436: </span>
<span class="linenr"> 437: </span>    <span style="color: #e45649;">ldaa</span>    Y
<span class="linenr"> 438: </span>    <span style="color: #e45649;">jsr</span>     StartTimer5oc
<span class="linenr"> 439: </span>
<span class="linenr"> 440: </span><span style="color: #a626a4;">loop2048</span>
<span class="linenr"> 441: </span>    <span style="color: #e45649;">jsr</span>     update_LEDs      <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">make sure clock LEDs are updated</span>
<span class="linenr"> 442: </span>    <span style="color: #e45649;">ldd</span>     ctr125u
<span class="linenr"> 443: </span>    <span style="color: #e45649;">cpd</span>     #DATAmax         <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">1024 bytes will be sent, the receiver at Windows PC</span>
<span class="linenr"> 444: </span>    <span style="color: #e45649;">bhs</span>     loopTxON         <span style="color: #9ca0a4;">;   </span><span style="color: #9ca0a4;">will only take 2048 bytes.</span>
<span class="linenr"> 445: </span>    <span style="color: #e45649;">bra</span>     loop2048         <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">set Terminal Cache Size to 10000 lines, update from 1000 lines</span>
<span class="linenr"> 446: </span>
<span class="linenr"> 447: </span><span style="color: #a626a4;">loopTxON</span>
<span class="linenr"> 448: </span>    <span style="color: #e45649;">LDAA</span>    #<span style="color: #6a1868;">%00000000</span>
<span class="linenr"> 449: </span>    <span style="color: #e45649;">STAA</span>    TIE               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">disable OC5 interrupt</span>
<span class="linenr"> 450: </span>
<span class="linenr"> 451: </span>    <span style="color: #e45649;">ldx</span>     #NEWLINE
<span class="linenr"> 452: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 453: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 454: </span>
<span class="linenr"> 455: </span>    <span style="color: #e45649;">ldx</span>     #msg5            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">print '&gt; Done!  Close Output file.'</span>
<span class="linenr"> 456: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 457: </span>
<span class="linenr"> 458: </span>    <span style="color: #e45649;">ldx</span>     #msg6            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">print '&gt; Ready for next data transmission'</span>
<span class="linenr"> 459: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 460: </span>
<span class="linenr"> 461: </span>    <span style="color: #e45649;">ldx</span>     #NEWLINE
<span class="linenr"> 462: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 463: </span>
<span class="linenr"> 464: </span>    <span style="color: #e45649;">bra</span>     eval_exit
<span class="linenr"> 465: </span>
<span class="linenr"> 466: </span><span style="color: #a626a4;">eval_adc</span>
<span class="linenr"> 467: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X+
<span class="linenr"> 468: </span>    <span style="color: #e45649;">cmpa</span>    #'d'
<span class="linenr"> 469: </span>    <span style="color: #e45649;">bne</span>     eval_exit_cmd_error
<span class="linenr"> 470: </span>
<span class="linenr"> 471: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X+
<span class="linenr"> 472: </span>    <span style="color: #e45649;">cmpa</span>    #'c'
<span class="linenr"> 473: </span>    <span style="color: #e45649;">bne</span>     eval_exit_cmd_error
<span class="linenr"> 474: </span>
<span class="linenr"> 475: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X+
<span class="linenr"> 476: </span>    <span style="color: #e45649;">cmpa</span>    #NULL
<span class="linenr"> 477: </span>    <span style="color: #e45649;">bne</span>     eval_exit_cmd_error
<span class="linenr"> 478: </span>
<span class="linenr"> 479: </span>    <span style="color: #e45649;">ldx</span>     #NEWLINE
<span class="linenr"> 480: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 481: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 482: </span>
<span class="linenr"> 483: </span><span style="color: #a626a4;">eval_adc_get_key</span>
<span class="linenr"> 484: </span>    <span style="color: #e45649;">jsr</span>     update_LEDs
<span class="linenr"> 485: </span>    <span style="color: #e45649;">jsr</span>     getchar
<span class="linenr"> 486: </span>    <span style="color: #e45649;">cmpa</span>    #NULL
<span class="linenr"> 487: </span>    <span style="color: #e45649;">beq</span>     eval_adc_get_key
<span class="linenr"> 488: </span>
<span class="linenr"> 489: </span>    <span style="color: #e45649;">ldx</span>     #<span style="color: #50a14f;">0</span>                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">reset counter</span>
<span class="linenr"> 490: </span>    <span style="color: #e45649;">stx</span>     ctr125u
<span class="linenr"> 491: </span>
<span class="linenr"> 492: </span>    <span style="color: #e45649;">ldx</span>     #NEWLINE
<span class="linenr"> 493: </span>    <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 494: </span>
<span class="linenr"> 495: </span>    <span style="color: #e45649;">ldaa</span>    #'a'
<span class="linenr"> 496: </span>    <span style="color: #e45649;">jsr</span>     StartTimer5oc
<span class="linenr"> 497: </span>    <span style="color: #e45649;">bra</span>     loop2048
<span class="linenr"> 498: </span>
<span class="linenr"> 499: </span><span style="color: #a626a4;">eval_quit</span>
<span class="linenr"> 500: </span>    <span style="color: #e45649;">ldaa</span>    X
<span class="linenr"> 501: </span>    <span style="color: #e45649;">cmpa</span>    #NULL
<span class="linenr"> 502: </span>    <span style="color: #e45649;">bne</span>     eval_exit_cmd_error
<span class="linenr"> 503: </span>
<span class="linenr"> 504: </span>    <span style="color: #e45649;">sei</span>                         <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">disable interrupts, thus stopping the clock</span>
<span class="linenr"> 505: </span>
<span class="linenr"> 506: </span>    <span style="color: #e45649;">ldx</span>     #NEWLINE            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">print quit message</span>
<span class="linenr"> 507: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 508: </span>    <span style="color: #e45649;">ldx</span>     #QUIT_MSG           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 509: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 510: </span>
<span class="linenr"> 511: </span>    <span style="color: #e45649;">jsr</span>     typewriter          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">enter typewriter program</span>
<span class="linenr"> 512: </span>
<span class="linenr"> 513: </span><span style="color: #a626a4;">eval_exit_error</span>
<span class="linenr"> 514: </span>    <span style="color: #e45649;">ldx</span>     #NEWLINE            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">print a newline, then the error message</span>
<span class="linenr"> 515: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 516: </span>    <span style="color: #e45649;">ldx</span>     #FMT_ERR            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 517: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 518: </span>    <span style="color: #e45649;">bra</span>     eval_exit           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 519: </span>
<span class="linenr"> 520: </span><span style="color: #a626a4;">eval_exit_error2</span>
<span class="linenr"> 521: </span>    <span style="color: #e45649;">ldx</span>     #NEWLINE            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">print a newline, then the error message</span>
<span class="linenr"> 522: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 523: </span>    <span style="color: #e45649;">ldx</span>     #FMT_ERR2           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 524: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 525: </span>    <span style="color: #e45649;">bra</span>     eval_exit           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 526: </span>
<span class="linenr"> 527: </span><span style="color: #a626a4;">eval_exit_cmd_error</span>
<span class="linenr"> 528: </span>    <span style="color: #e45649;">ldx</span>     #NEWLINE            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">print a newline, then the error message</span>
<span class="linenr"> 529: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 530: </span>    <span style="color: #e45649;">ldx</span>     #CMD_ERR            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 531: </span>    <span style="color: #e45649;">jsr</span>     print               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 532: </span>
<span class="linenr"> 533: </span><span style="color: #a626a4;">eval_exit</span>
<span class="linenr"> 534: </span>    <span style="color: #e45649;">pula</span>
<span class="linenr"> 535: </span>    <span style="color: #e45649;">puly</span>
<span class="linenr"> 536: </span>    <span style="color: #e45649;">pulx</span>
<span class="linenr"> 537: </span>
<span class="linenr"> 538: </span>    <span style="color: #e45649;">rts</span>
<span class="linenr"> 539: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr"> 540: </span>
<span class="linenr"> 541: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">***********Timer OC5 interrupt service routine***************</span>
<span class="linenr"> 542: </span><span style="color: #a626a4;">oc5isr_saw</span>
<span class="linenr"> 543: </span>    <span style="color: #e45649;">ldd</span>     #<span style="color: #50a14f;">3000</span>              <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">125usec with (24MHz/1 clock)</span>
<span class="linenr"> 544: </span>    <span style="color: #e45649;">addd</span>    TC5H               <span style="color: #9ca0a4;">;    </span><span style="color: #9ca0a4;">for next interrupt</span>
<span class="linenr"> 545: </span>    <span style="color: #e45649;">std</span>     TC5H               <span style="color: #9ca0a4;">;</span>
<span class="linenr"> 546: </span>    <span style="color: #e45649;">bset</span>    TFLG1,<span style="color: #6a1868;">%00100000</span>    <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">clear timer CH6 interrupt flag, not needed if fast clear enabled</span>
<span class="linenr"> 547: </span>    <span style="color: #e45649;">ldd</span>     ctr125u
<span class="linenr"> 548: </span>    <span style="color: #e45649;">ldx</span>     ctr125u
<span class="linenr"> 549: </span>    <span style="color: #e45649;">inx</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">update OC5 (125usec) interrupt counter</span>
<span class="linenr"> 550: </span>    <span style="color: #e45649;">stx</span>     ctr125u
<span class="linenr"> 551: </span>    <span style="color: #e45649;">clra</span>                       <span style="color: #9ca0a4;">;   </span><span style="color: #9ca0a4;">print ctr125u, only the last byte</span>
<span class="linenr"> 552: </span>    <span style="color: #e45649;">jsr</span>     pnum10             <span style="color: #9ca0a4;">;   </span><span style="color: #9ca0a4;">to make the file RxData3.txt with exactly 1024 data</span>
<span class="linenr"> 553: </span>    <span style="color: #e45649;">RTI</span>
<span class="linenr"> 554: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">***********end of Timer OC5 interrupt service routine********</span>
<span class="linenr"> 555: </span>
<span class="linenr"> 556: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">Timer OC5 interrupt service routine***************</span>
<span class="linenr"> 557: </span><span style="color: #a626a4;">oc5isr_tri</span>
<span class="linenr"> 558: </span>    <span style="color: #e45649;">ldd</span>     #<span style="color: #50a14f;">3000</span>              <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">125usec with (24MHz/1 clock)</span>
<span class="linenr"> 559: </span>    <span style="color: #e45649;">addd</span>    TC5H               <span style="color: #9ca0a4;">;    </span><span style="color: #9ca0a4;">for next interrupt</span>
<span class="linenr"> 560: </span>    <span style="color: #e45649;">std</span>     TC5H               <span style="color: #9ca0a4;">;</span>
<span class="linenr"> 561: </span>    <span style="color: #e45649;">bset</span>    TFLG1,<span style="color: #6a1868;">%00100000</span>    <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">clear timer CH6 interrupt flag, not needed if fast clear enabled</span>
<span class="linenr"> 562: </span>    <span style="color: #e45649;">ldd</span>     ctr125u
<span class="linenr"> 563: </span>    <span style="color: #e45649;">ldx</span>     ctr125u
<span class="linenr"> 564: </span>    <span style="color: #e45649;">inx</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">update OC5 (125usec) interrupt counter</span>
<span class="linenr"> 565: </span>    <span style="color: #e45649;">stx</span>     ctr125u
<span class="linenr"> 566: </span>
<span class="linenr"> 567: </span>
<span class="linenr"> 568: </span>    <span style="color: #e45649;">anda</span>    #<span style="color: #6a1868;">%00000001</span>          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if lsb is 1, countdown</span>
<span class="linenr"> 569: </span>    <span style="color: #e45649;">bne</span>     tri_countdown       <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">else, countup</span>
<span class="linenr"> 570: </span>    <span style="color: #e45649;">bra</span>     tri_countup
<span class="linenr"> 571: </span>
<span class="linenr"> 572: </span><span style="color: #a626a4;">tri_countdown</span>
<span class="linenr"> 573: </span>    <span style="color: #e45649;">ldaa</span>    #$FF                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">do 255 - B</span>
<span class="linenr"> 574: </span>    <span style="color: #e45649;">sba</span>                         <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">result is stored in A,</span>
<span class="linenr"> 575: </span>    <span style="color: #e45649;">tab</span>                         <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">so move it to B</span>
<span class="linenr"> 576: </span>    <span style="color: #e45649;">bra</span>     tri_exit
<span class="linenr"> 577: </span>
<span class="linenr"> 578: </span><span style="color: #a626a4;">tri_countup</span>
<span class="linenr"> 579: </span>
<span class="linenr"> 580: </span><span style="color: #a626a4;">tri_exit</span>
<span class="linenr"> 581: </span>    <span style="color: #e45649;">clra</span>
<span class="linenr"> 582: </span>    <span style="color: #e45649;">jsr</span>   pnum10             <span style="color: #9ca0a4;">;   </span><span style="color: #9ca0a4;">to make the file RxData3.txt with exactly 1024 data</span>
<span class="linenr"> 583: </span>    <span style="color: #e45649;">rti</span>
<span class="linenr"> 584: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">***********end of Timer OC5 interrupt service routine********</span>
<span class="linenr"> 585: </span>
<span class="linenr"> 586: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">Timer OC5 interrupt service routine***************</span>
<span class="linenr"> 587: </span><span style="color: #a626a4;">oc5isr_square</span>
<span class="linenr"> 588: </span>    <span style="color: #e45649;">ldd</span>     #<span style="color: #50a14f;">3000</span>              <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">125usec with (24MHz/1 clock)</span>
<span class="linenr"> 589: </span>    <span style="color: #e45649;">addd</span>    TC5H               <span style="color: #9ca0a4;">;    </span><span style="color: #9ca0a4;">for next interrupt</span>
<span class="linenr"> 590: </span>    <span style="color: #e45649;">std</span>     TC5H               <span style="color: #9ca0a4;">;</span>
<span class="linenr"> 591: </span>    <span style="color: #e45649;">bset</span>    TFLG1,<span style="color: #6a1868;">%00100000</span>    <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">clear timer CH6 interrupt flag, not needed if fast clear enabled</span>
<span class="linenr"> 592: </span>    <span style="color: #e45649;">ldd</span>     ctr125u
<span class="linenr"> 593: </span>    <span style="color: #e45649;">ldx</span>     ctr125u
<span class="linenr"> 594: </span>    <span style="color: #e45649;">inx</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">update OC5 (125usec) interrupt counter</span>
<span class="linenr"> 595: </span>    <span style="color: #e45649;">stx</span>     ctr125u
<span class="linenr"> 596: </span>
<span class="linenr"> 597: </span>    <span style="color: #e45649;">anda</span>    #<span style="color: #6a1868;">%00000001</span>          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if lsb is 1, hi</span>
<span class="linenr"> 598: </span>    <span style="color: #e45649;">bne</span>     square_hi           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">else, low</span>
<span class="linenr"> 599: </span>    <span style="color: #e45649;">bra</span>     square_lo
<span class="linenr"> 600: </span>
<span class="linenr"> 601: </span><span style="color: #a626a4;">square_hi</span>
<span class="linenr"> 602: </span>    <span style="color: #e45649;">ldab</span>    #$FF
<span class="linenr"> 603: </span>    <span style="color: #e45649;">bra</span>     square_exit
<span class="linenr"> 604: </span><span style="color: #a626a4;">square_lo</span>
<span class="linenr"> 605: </span>    <span style="color: #e45649;">ldab</span>    #<span style="color: #50a14f;">0</span>
<span class="linenr"> 606: </span>
<span class="linenr"> 607: </span><span style="color: #a626a4;">square_exit</span>
<span class="linenr"> 608: </span>    <span style="color: #e45649;">clra</span>                     <span style="color: #9ca0a4;">;   </span><span style="color: #9ca0a4;">print ctr125u, only the last byte</span>
<span class="linenr"> 609: </span>    <span style="color: #e45649;">jsr</span>     pnum10             <span style="color: #9ca0a4;">;   </span><span style="color: #9ca0a4;">to make the file RxData3.txt with exactly 1024 data</span>
<span class="linenr"> 610: </span>    <span style="color: #e45649;">RTI</span>
<span class="linenr"> 611: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">***********end of Timer OC5 interrupt service routine********</span>
<span class="linenr"> 612: </span>
<span class="linenr"> 613: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">Timer OC5 interrupt service routine***************</span>
<span class="linenr"> 614: </span><span style="color: #a626a4;">oc5isr_adc</span>
<span class="linenr"> 615: </span>    <span style="color: #e45649;">ldd</span>     #<span style="color: #50a14f;">3000</span>              <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">125usec with (24MHz/1 clock)</span>
<span class="linenr"> 616: </span>    <span style="color: #e45649;">addd</span>    TC5H               <span style="color: #9ca0a4;">;    </span><span style="color: #9ca0a4;">for next interrupt</span>
<span class="linenr"> 617: </span>    <span style="color: #e45649;">std</span>     TC5H               <span style="color: #9ca0a4;">;</span>
<span class="linenr"> 618: </span>    <span style="color: #e45649;">bset</span>    TFLG1,<span style="color: #6a1868;">%00100000</span>    <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">clear timer CH6 interrupt flag, not needed if fast clear enabled</span>
<span class="linenr"> 619: </span>    <span style="color: #e45649;">ldx</span>     ctr125u
<span class="linenr"> 620: </span>    <span style="color: #e45649;">inx</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">update OC5 (125usec) interrupt counter</span>
<span class="linenr"> 621: </span>    <span style="color: #e45649;">stx</span>     ctr125u
<span class="linenr"> 622: </span>
<span class="linenr"> 623: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">adcwait</span>
<span class="linenr"> 624: </span><span style="color: #9ca0a4;">;    </span><span style="color: #9ca0a4;">ldaa    ATDSTAT0            ; if necessary, wait until conversion is done.</span>
<span class="linenr"> 625: </span><span style="color: #9ca0a4;">;    </span><span style="color: #9ca0a4;">anda    #%10000000</span>
<span class="linenr"> 626: </span><span style="color: #9ca0a4;">;    </span><span style="color: #9ca0a4;">beq     adcwait</span>
<span class="linenr"> 627: </span>
<span class="linenr"> 628: </span>    <span style="color: #e45649;">ldab</span>    ATDDR0L            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">get number from adc</span>
<span class="linenr"> 629: </span>    <span style="color: #e45649;">clra</span>
<span class="linenr"> 630: </span>    <span style="color: #e45649;">jsr</span>     pnum10             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">print number from adc</span>
<span class="linenr"> 631: </span>
<span class="linenr"> 632: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">start another conversion</span>
<span class="linenr"> 633: </span>    <span style="color: #e45649;">ldaa</span>    #<span style="color: #6a1868;">%10000111</span>       <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">right justified, unsigned, single conversion,</span>
<span class="linenr"> 634: </span>    <span style="color: #e45649;">staa</span>    ATDCTL5          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">single channel, CHANNEL 7, start the conversion</span>
<span class="linenr"> 635: </span>    <span style="color: #e45649;">RTI</span>
<span class="linenr"> 636: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">***********end of Timer OC5 interrupt service routine********</span>
<span class="linenr"> 637: </span>
<span class="linenr"> 638: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">***************StartTimer5oc************************</span>
<span class="linenr"> 639: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Program: Start the timer interrupt, timer channel 6 output compare</span>
<span class="linenr"> 640: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Input:   A Register: ascii code for type of signal</span>
<span class="linenr"> 641: </span><span style="color: #9ca0a4;">;           </span><span style="color: #9ca0a4;">Constants - channel 6 output compare, 125usec at 24MHz</span>
<span class="linenr"> 642: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Output:  None, only the timer interrupt</span>
<span class="linenr"> 643: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Registers modified: D used and CCR modified</span>
<span class="linenr"> 644: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Algorithm:</span>
<span class="linenr"> 645: </span><span style="color: #9ca0a4;">;             </span><span style="color: #9ca0a4;">initialize TIOS, TIE, TSCR1, TSCR2, TC2H, and TFLG1</span>
<span class="linenr"> 646: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">**********************************************</span>
<span class="linenr"> 647: </span><span style="color: #a626a4;">StartTimer5oc</span>
<span class="linenr"> 648: </span>    <span style="color: #e45649;">pshd</span>
<span class="linenr"> 649: </span>    <span style="color: #e45649;">pshx</span>
<span class="linenr"> 650: </span>
<span class="linenr"> 651: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">set appropriate interrupt vector</span>
<span class="linenr"> 652: </span>    <span style="color: #e45649;">cmpa</span>    #'w'
<span class="linenr"> 653: </span>    <span style="color: #e45649;">beq</span>     saw5oc
<span class="linenr"> 654: </span>    <span style="color: #e45649;">cmpa</span>    #'t'
<span class="linenr"> 655: </span>    <span style="color: #e45649;">beq</span>     triangle5oc
<span class="linenr"> 656: </span>    <span style="color: #e45649;">cmpa</span>    #'q'
<span class="linenr"> 657: </span>    <span style="color: #e45649;">beq</span>     square5oc
<span class="linenr"> 658: </span>    <span style="color: #e45649;">cmpa</span>    #'a'
<span class="linenr"> 659: </span>    <span style="color: #e45649;">beq</span>     adc5oc
<span class="linenr"> 660: </span>
<span class="linenr"> 661: </span><span style="color: #a626a4;">saw5oc</span>
<span class="linenr"> 662: </span>    <span style="color: #e45649;">ldx</span>     #oc5isr_saw
<span class="linenr"> 663: </span>    <span style="color: #e45649;">bra</span>     store5oc
<span class="linenr"> 664: </span><span style="color: #a626a4;">triangle5oc</span>
<span class="linenr"> 665: </span>    <span style="color: #e45649;">ldx</span>     #oc5isr_tri
<span class="linenr"> 666: </span>    <span style="color: #e45649;">bra</span>     store5oc
<span class="linenr"> 667: </span><span style="color: #a626a4;">square5oc</span>
<span class="linenr"> 668: </span>    <span style="color: #e45649;">ldx</span>     #oc5isr_square
<span class="linenr"> 669: </span>    <span style="color: #e45649;">bra</span>     store5oc
<span class="linenr"> 670: </span><span style="color: #a626a4;">adc5oc</span>
<span class="linenr"> 671: </span>    <span style="color: #e45649;">ldx</span>     #oc5isr_adc
<span class="linenr"> 672: </span>
<span class="linenr"> 673: </span>
<span class="linenr"> 674: </span><span style="color: #a626a4;">store5oc</span>
<span class="linenr"> 675: </span>    <span style="color: #e45649;">stx</span>     oc5isr
<span class="linenr"> 676: </span>
<span class="linenr"> 677: </span>    <span style="color: #e45649;">ldaa</span>    #<span style="color: #6a1868;">%00100000</span>
<span class="linenr"> 678: </span>    <span style="color: #e45649;">staa</span>    TIOS              <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">set CH5 Output Compare</span>
<span class="linenr"> 679: </span>    <span style="color: #e45649;">staa</span>    TIE               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">set CH5 interrupt Enable</span>
<span class="linenr"> 680: </span>    <span style="color: #e45649;">ldaa</span>    #<span style="color: #6a1868;">%10000000</span>        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">enable timer, Fast Flag Clear not set</span>
<span class="linenr"> 681: </span>    <span style="color: #e45649;">staa</span>    TSCR1
<span class="linenr"> 682: </span>    <span style="color: #e45649;">ldaa</span>    #<span style="color: #6a1868;">%00000000</span>        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">TOI Off, TCRE Off, TCLK = BCLK/1</span>
<span class="linenr"> 683: </span>    <span style="color: #e45649;">staa</span>    TSCR2             <span style="color: #9ca0a4;">;   </span><span style="color: #9ca0a4;">not needed if started from reset</span>
<span class="linenr"> 684: </span>
<span class="linenr"> 685: </span>    <span style="color: #e45649;">ldd</span>     #<span style="color: #50a14f;">3000</span>            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">125usec with (24MHz/1 clock)</span>
<span class="linenr"> 686: </span>    <span style="color: #e45649;">addd</span>    TCNTH            <span style="color: #9ca0a4;">;    </span><span style="color: #9ca0a4;">for first interrupt</span>
<span class="linenr"> 687: </span>    <span style="color: #e45649;">std</span>     TC5H             <span style="color: #9ca0a4;">;</span>
<span class="linenr"> 688: </span>
<span class="linenr"> 689: </span>    <span style="color: #e45649;">bset</span>    TFLG1,<span style="color: #6a1868;">%00100000</span>   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">initial Timer CH5 interrupt flag Clear, not needed if fast clear set</span>
<span class="linenr"> 690: </span>    <span style="color: #e45649;">ldaa</span>    #<span style="color: #6a1868;">%00100000</span>
<span class="linenr"> 691: </span>    <span style="color: #e45649;">staa</span>    TIE               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">set CH5 interrupt Enable</span>
<span class="linenr"> 692: </span>
<span class="linenr"> 693: </span>    <span style="color: #e45649;">pulx</span>
<span class="linenr"> 694: </span>    <span style="color: #e45649;">puld</span>
<span class="linenr"> 695: </span>    <span style="color: #e45649;">rts</span>
<span class="linenr"> 696: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">***************end of StartTimer2oc*****************</span>
<span class="linenr"> 697: </span>
<span class="linenr"> 698: </span>
<span class="linenr"> 699: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">***********pnum10***************************</span>
<span class="linenr"> 700: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Program: print a word (16bit) in decimal to SCI port</span>
<span class="linenr"> 701: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Input:   Register D contains a 16 bit number to print in decimal number</span>
<span class="linenr"> 702: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Output:  decimal number printed on the terminal connected to SCI port</span>
<span class="linenr"> 703: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">*</span>
<span class="linenr"> 704: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Registers modified: CCR</span>
<span class="linenr"> 705: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">* Algorithm:</span>
<span class="linenr"> 706: </span><span style="color: #9ca0a4;">;     </span><span style="color: #9ca0a4;">Keep divide number by 10 and keep the remainders</span>
<span class="linenr"> 707: </span><span style="color: #9ca0a4;">;     </span><span style="color: #9ca0a4;">Then send it out to SCI port</span>
<span class="linenr"> 708: </span><span style="color: #9ca0a4;">;  </span><span style="color: #9ca0a4;">Need memory location for counter CTR and buffer BUF(6 byte max)</span>
<span class="linenr"> 709: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">**********************************************</span>
<span class="linenr"> 710: </span><span style="color: #a626a4;">pnum10</span>          <span style="color: #e45649;">pshd</span>                   <span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">Save registers</span>
<span class="linenr"> 711: </span>                <span style="color: #e45649;">pshx</span>
<span class="linenr"> 712: </span>                <span style="color: #e45649;">pshy</span>
<span class="linenr"> 713: </span>                <span style="color: #e45649;">clr</span>     CTR            <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">clear character count of an 8 bit number</span>
<span class="linenr"> 714: </span>
<span class="linenr"> 715: </span>                <span style="color: #e45649;">ldy</span>     #BUF
<span class="linenr"> 716: </span><span style="color: #a626a4;">pnum10p1</span>        <span style="color: #e45649;">ldx</span>     #<span style="color: #50a14f;">10</span>
<span class="linenr"> 717: </span>                <span style="color: #e45649;">idiv</span>
<span class="linenr"> 718: </span>                <span style="color: #e45649;">beq</span>     pnum10p2
<span class="linenr"> 719: </span>                <span style="color: #e45649;">stab</span>    <span style="color: #50a14f;">1</span>,y+
<span class="linenr"> 720: </span>                <span style="color: #e45649;">inc</span>     CTR
<span class="linenr"> 721: </span>                <span style="color: #e45649;">tfr</span>     x,d
<span class="linenr"> 722: </span>                <span style="color: #e45649;">bra</span>     pnum10p1
<span class="linenr"> 723: </span>
<span class="linenr"> 724: </span><span style="color: #a626a4;">pnum10p2</span>        <span style="color: #e45649;">stab</span>    <span style="color: #50a14f;">1</span>,y+
<span class="linenr"> 725: </span>                <span style="color: #e45649;">inc</span>     CTR
<span class="linenr"> 726: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">--------------------------------------</span>
<span class="linenr"> 727: </span>
<span class="linenr"> 728: </span><span style="color: #a626a4;">pnum10p3</span>        <span style="color: #e45649;">ldaa</span>    #$30
<span class="linenr"> 729: </span>                <span style="color: #e45649;">adda</span>    <span style="color: #50a14f;">1</span>,-y
<span class="linenr"> 730: </span>                <span style="color: #e45649;">jsr</span>     putchar
<span class="linenr"> 731: </span>                <span style="color: #e45649;">dec</span>     CTR
<span class="linenr"> 732: </span>                <span style="color: #e45649;">bne</span>     pnum10p3
<span class="linenr"> 733: </span>                <span style="color: #e45649;">ldx</span>     #NEWLINE
<span class="linenr"> 734: </span>                <span style="color: #e45649;">jsr</span>     print
<span class="linenr"> 735: </span>                <span style="color: #e45649;">puly</span>
<span class="linenr"> 736: </span>                <span style="color: #e45649;">pulx</span>
<span class="linenr"> 737: </span>                <span style="color: #e45649;">puld</span>
<span class="linenr"> 738: </span>                <span style="color: #e45649;">rts</span>
<span class="linenr"> 739: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">***********end of pnum10********************</span>
<span class="linenr"> 740: </span>
<span class="linenr"> 741: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr"> 742: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">typewriter</span>
<span class="linenr"> 743: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Program:    simple echo program which sends user input back to the terminal</span>
<span class="linenr"> 744: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 745: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Input:      None</span>
<span class="linenr"> 746: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Output:     None, doesn't ever return to main loop</span>
<span class="linenr"> 747: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Algorithm:</span>
<span class="linenr"> 748: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">gets character from terminal</span>
<span class="linenr"> 749: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">sends character back to terminal.</span>
<span class="linenr"> 750: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">if newline is recieved, a linefeed is also sent to terminal</span>
<span class="linenr"> 751: </span><span style="color: #a626a4;">typewriter</span>
<span class="linenr"> 752: </span>    <span style="color: #e45649;">jsr</span>     getchar
<span class="linenr"> 753: </span>    <span style="color: #e45649;">jsr</span>     putchar
<span class="linenr"> 754: </span>
<span class="linenr"> 755: </span>    <span style="color: #e45649;">cmpa</span>    #CR
<span class="linenr"> 756: </span>    <span style="color: #e45649;">bne</span>     typewriter
<span class="linenr"> 757: </span>
<span class="linenr"> 758: </span><span style="color: #a626a4;">typewriter_onenter</span>
<span class="linenr"> 759: </span>    <span style="color: #e45649;">ldaa</span>    #LF
<span class="linenr"> 760: </span>    <span style="color: #e45649;">jsr</span>     putchar
<span class="linenr"> 761: </span>    <span style="color: #e45649;">bra</span>     typewriter
<span class="linenr"> 762: </span>
<span class="linenr"> 763: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr"> 764: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">update_LEDs</span>
<span class="linenr"> 765: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Program:    convert integer to binary coded decimal, and update PORTA/PORTB with minutes and seconds.</span>
<span class="linenr"> 766: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 767: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Input:      None. uses global minutes and seconds counters</span>
<span class="linenr"> 768: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Ouput:      Modifies PORTA and PORTB</span>
<span class="linenr"> 769: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Algorithm:</span>
<span class="linenr"> 770: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">values are stored as integers. minutes is easy, just store it at PORTA</span>
<span class="linenr"> 771: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 772: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">for PORTB, first it is divided by 10. the remainder is the 1's place,</span>
<span class="linenr"> 773: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">quotient is the 10's place.</span>
<span class="linenr"> 774: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 775: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">the 1's digit is stored in the temp variable. then the 10's digit is shifted.</span>
<span class="linenr"> 776: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">they are or'ed together</span>
<span class="linenr"> 777: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">the result is stored in PORTB</span>
<span class="linenr"> 778: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 779: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #50a14f; font-weight: bold;">NOTE:</span><span style="color: #9ca0a4;"> A temp variable isn't needed, but if PORTB is used directly, then the simulator</span>
<span class="linenr"> 780: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">will flicker the seconds 10's place digit (this wouldn't be visible in real life).</span>
<span class="linenr"> 781: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">a temp variable is used soley for the simulator.</span>
<span class="linenr"> 782: </span><span style="color: #a626a4;">update_LEDs</span>
<span class="linenr"> 783: </span>    <span style="color: #e45649;">pshd</span>
<span class="linenr"> 784: </span>    <span style="color: #e45649;">pshx</span>
<span class="linenr"> 785: </span>    <span style="color: #e45649;">clr</span>     <span style="color: #50a14f;">1</span>,-SP               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">temp variable</span>
<span class="linenr"> 786: </span>
<span class="linenr"> 787: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">does the time need updated?</span>
<span class="linenr"> 788: </span>    <span style="color: #e45649;">ldd</span>     ctr2p5m             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">check the 2.5ms counter, has 1000ms elapsed?</span>
<span class="linenr"> 789: </span>    <span style="color: #e45649;">cpd</span>     #<span style="color: #50a14f;">150</span>                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">| (ie, counter == 400)</span>
<span class="linenr"> 790: </span>    <span style="color: #e45649;">bls</span>     update_LEDs_skip    <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">| (for sim purposes, this value is set to 150)</span>
<span class="linenr"> 791: </span>
<span class="linenr"> 792: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">the counter</span>
<span class="linenr"> 793: </span>    <span style="color: #e45649;">clr</span>     ctr2p5m             <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">clear (BOTH BYTES) of the counter</span>
<span class="linenr"> 794: </span>    <span style="color: #e45649;">clr</span>     ctr2p5m+<span style="color: #50a14f;">1</span>           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 795: </span>    <span style="color: #e45649;">inc</span>     times               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">increment the seconds counter</span>
<span class="linenr"> 796: </span>
<span class="linenr"> 797: </span>    <span style="color: #e45649;">ldaa</span>    times               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">is the seconds counter == 60?</span>
<span class="linenr"> 798: </span>    <span style="color: #e45649;">cmpa</span>    #<span style="color: #50a14f;">60</span>                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 799: </span>    <span style="color: #e45649;">blo</span>     update_LEDs_skip    <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 800: </span>
<span class="linenr"> 801: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">seconds counter == 60</span>
<span class="linenr"> 802: </span>    <span style="color: #e45649;">clr</span>     times               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">reset the seconds counter</span>
<span class="linenr"> 803: </span>    <span style="color: #e45649;">inc</span>     timem               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">increment the minutes counter</span>
<span class="linenr"> 804: </span>
<span class="linenr"> 805: </span>    <span style="color: #e45649;">ldaa</span>    timem               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">is the minutes counter == 10?</span>
<span class="linenr"> 806: </span>    <span style="color: #e45649;">cmpa</span>    #<span style="color: #50a14f;">10</span>                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 807: </span>    <span style="color: #e45649;">blo</span>     update_LEDs_skip    <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 808: </span>
<span class="linenr"> 809: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">minutes counter == 10</span>
<span class="linenr"> 810: </span>    <span style="color: #e45649;">clr</span>     timem               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">reset minutes counter back to 0</span>
<span class="linenr"> 811: </span>
<span class="linenr"> 812: </span><span style="color: #a626a4;">update_LEDs_skip</span>
<span class="linenr"> 813: </span>
<span class="linenr"> 814: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">do first divide (for 1's digit)</span>
<span class="linenr"> 815: </span>    <span style="color: #e45649;">ldab</span>    times               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">set dividend (total num of seconds)</span>
<span class="linenr"> 816: </span>    <span style="color: #e45649;">clra</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">ensure A is zero for divide</span>
<span class="linenr"> 817: </span>    <span style="color: #e45649;">ldx</span>     #<span style="color: #50a14f;">10</span>                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">set divisor</span>
<span class="linenr"> 818: </span>    <span style="color: #e45649;">idiv</span>
<span class="linenr"> 819: </span>
<span class="linenr"> 820: </span>    <span style="color: #e45649;">stab</span>    SP                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">stash 1's digit on temp variable</span>
<span class="linenr"> 821: </span>
<span class="linenr"> 822: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">10's digit is now in X register</span>
<span class="linenr"> 823: </span>    <span style="color: #e45649;">tfr</span>     X,D                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">move from X to D (low-4 will be in B register)</span>
<span class="linenr"> 824: </span>
<span class="linenr"> 825: </span>    <span style="color: #e45649;">lslb</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">move digit to upper four bits</span>
<span class="linenr"> 826: </span>    <span style="color: #e45649;">lslb</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 827: </span>    <span style="color: #e45649;">lslb</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 828: </span>    <span style="color: #e45649;">lslb</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 829: </span>
<span class="linenr"> 830: </span>    <span style="color: #e45649;">orab</span>    SP                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">combine 10's and 1's in PORTB</span>
<span class="linenr"> 831: </span>    <span style="color: #e45649;">stab</span>    PORTB               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">store value to PORTB</span>
<span class="linenr"> 832: </span>
<span class="linenr"> 833: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">send result out to ports</span>
<span class="linenr"> 834: </span>    <span style="color: #e45649;">ldaa</span>    timem
<span class="linenr"> 835: </span>    <span style="color: #e45649;">staa</span>    PORTA
<span class="linenr"> 836: </span>
<span class="linenr"> 837: </span>    <span style="color: #e45649;">leas</span>    <span style="color: #50a14f;">1</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">pop off temp variable</span>
<span class="linenr"> 838: </span>    <span style="color: #e45649;">pulx</span>
<span class="linenr"> 839: </span>    <span style="color: #e45649;">puld</span>
<span class="linenr"> 840: </span>    <span style="color: #e45649;">rts</span>
<span class="linenr"> 841: </span>
<span class="linenr"> 842: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">atoi</span>
<span class="linenr"> 843: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 844: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Program:    converts a string to an integer (if possible)</span>
<span class="linenr"> 845: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 846: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Input:      X Register: pointer to string</span>
<span class="linenr"> 847: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 848: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Output:     D Register: integer representation of string</span>
<span class="linenr"> 849: </span><span style="color: #9ca0a4;">;;;             </span><span style="color: #9ca0a4;">modifies err_flag and err_data</span>
<span class="linenr"> 850: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 851: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Algorithm:</span>
<span class="linenr"> 852: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">converts digits up to first non-number character.</span>
<span class="linenr"> 853: </span><span style="color: #9ca0a4;">;;;      </span><span style="color: #9ca0a4;">e.g. atoi("12hey there") -&gt; 12</span>
<span class="linenr"> 854: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 855: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">if the first character is a non-number, D is set to zero</span>
<span class="linenr"> 856: </span><span style="color: #9ca0a4;">;;;      </span><span style="color: #9ca0a4;">and err_flag and err_data are set accordingly</span>
<span class="linenr"> 857: </span><span style="color: #9ca0a4;">;;;      </span><span style="color: #9ca0a4;">e.g. atoi("afs12") -&gt; 0 (ERROR)</span>
<span class="linenr"> 858: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 859: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">Stack Layout:</span>
<span class="linenr"> 860: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">SP + 8: return address</span>
<span class="linenr"> 861: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">SP + 6: X reg</span>
<span class="linenr"> 862: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">SP + 5: len var</span>
<span class="linenr"> 863: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">SP + 4: pow var</span>
<span class="linenr"> 864: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">SP + 2: tmp var</span>
<span class="linenr"> 865: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">SP + 0: accum var</span>
<span class="linenr"> 866: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 867: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">// find length of number</span>
<span class="linenr"> 868: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">len = 0 ; length accumulator</span>
<span class="linenr"> 869: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">while is_digit((X++)*):</span>
<span class="linenr"> 870: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">len++;</span>
<span class="linenr"> 871: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 872: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">// add up each digit</span>
<span class="linenr"> 873: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">index = len; // len is now index for X</span>
<span class="linenr"> 874: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">accum = A; store A on the stack</span>
<span class="linenr"> 875: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">pow = 0; // power variable</span>
<span class="linenr"> 876: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">B = 1 ; // B is now the Power Accumulator</span>
<span class="linenr"> 877: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">X = index+X ; we are going through this number backwards</span>
<span class="linenr"> 878: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">while index &gt; 0:</span>
<span class="linenr"> 879: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">index--;</span>
<span class="linenr"> 880: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">pow = index;</span>
<span class="linenr"> 881: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">D = X[-index];</span>
<span class="linenr"> 882: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 883: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">if pow == 0:</span>
<span class="linenr"> 884: </span><span style="color: #9ca0a4;">;;;             </span><span style="color: #9ca0a4;">accum += D</span>
<span class="linenr"> 885: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 886: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">tmp = D</span>
<span class="linenr"> 887: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">while pow &gt; 0:</span>
<span class="linenr"> 888: </span><span style="color: #9ca0a4;">;;;             </span><span style="color: #9ca0a4;">tmp += tmp &lt;&lt; 3</span>
<span class="linenr"> 889: </span><span style="color: #9ca0a4;">;;;             </span><span style="color: #9ca0a4;">tmp += tmp &lt;&lt; 1</span>
<span class="linenr"> 890: </span><span style="color: #9ca0a4;">;;;             </span><span style="color: #9ca0a4;">pow--;</span>
<span class="linenr"> 891: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 892: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">accum += tmp</span>
<span class="linenr"> 893: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 894: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr"> 895: </span><span style="color: #a626a4;">atoi</span>
<span class="linenr"> 896: </span>    <span style="color: #e45649;">pshy</span>
<span class="linenr"> 897: </span>    <span style="color: #e45649;">pshx</span>
<span class="linenr"> 898: </span>    <span style="color: #e45649;">clr</span>     <span style="color: #50a14f;">1</span>,-SP               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">len var / index var</span>
<span class="linenr"> 899: </span>    <span style="color: #e45649;">clr</span>     <span style="color: #50a14f;">1</span>,-SP               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">pow var</span>
<span class="linenr"> 900: </span>    <span style="color: #e45649;">clr</span>     <span style="color: #50a14f;">1</span>,-SP               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">tmp var</span>
<span class="linenr"> 901: </span>    <span style="color: #e45649;">clr</span>     <span style="color: #50a14f;">1</span>,-SP               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 902: </span>    <span style="color: #e45649;">clr</span>     <span style="color: #50a14f;">1</span>,-SP               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">accum var</span>
<span class="linenr"> 903: </span>    <span style="color: #e45649;">clr</span>     <span style="color: #50a14f;">1</span>,-SP               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 904: </span>
<span class="linenr"> 905: </span><span style="color: #a626a4;">atoi_getlen</span>
<span class="linenr"> 906: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X+                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">get next character</span>
<span class="linenr"> 907: </span>    <span style="color: #e45649;">jsr</span>     is_dig              <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">break if character != number</span>
<span class="linenr"> 908: </span>    <span style="color: #e45649;">bne</span>     atoi_getlen_exit    <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 909: </span>
<span class="linenr"> 910: </span>    <span style="color: #e45649;">inc</span>     <span style="color: #50a14f;">5</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">increment length</span>
<span class="linenr"> 911: </span>    <span style="color: #e45649;">bra</span>     atoi_getlen         <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">continue</span>
<span class="linenr"> 912: </span>
<span class="linenr"> 913: </span><span style="color: #a626a4;">atoi_getlen_exit</span>
<span class="linenr"> 914: </span>    <span style="color: #e45649;">ldx</span>     <span style="color: #50a14f;">6</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">reload x from stack</span>
<span class="linenr"> 915: </span>    <span style="color: #e45649;">dex</span>                         <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">keep X from being incremented prematurely.</span>
<span class="linenr"> 916: </span><span style="color: #a626a4;">atoi_accumulate</span>
<span class="linenr"> 917: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">5</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if index == 0, break</span>
<span class="linenr"> 918: </span>    <span style="color: #e45649;">cmpa</span>    #<span style="color: #50a14f;">0</span>                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 919: </span>    <span style="color: #e45649;">beq</span>     atoi_exit           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 920: </span>    <span style="color: #e45649;">dec</span>     <span style="color: #50a14f;">5</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">decrement index</span>
<span class="linenr"> 921: </span>    <span style="color: #e45649;">deca</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">decrement register to track</span>
<span class="linenr"> 922: </span>    <span style="color: #e45649;">inx</span>                         <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">decrement pointer</span>
<span class="linenr"> 923: </span>
<span class="linenr"> 924: </span>    <span style="color: #e45649;">movb</span>    <span style="color: #50a14f;">5</span>,SP, <span style="color: #50a14f;">4</span>,SP          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">pow = index</span>
<span class="linenr"> 925: </span>
<span class="linenr"> 926: </span>    <span style="color: #e45649;">cmpa</span>    #<span style="color: #50a14f;">0</span>                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if pow &gt; 0, skip special handling</span>
<span class="linenr"> 927: </span>    <span style="color: #e45649;">bne</span>     atoi_calc_power     <span style="color: #9ca0a4;">;</span>
<span class="linenr"> 928: </span>
<span class="linenr"> 929: </span>    <span style="color: #e45649;">clra</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">clear A register</span>
<span class="linenr"> 930: </span>    <span style="color: #e45649;">ldab</span>     X                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">load lower 8 bits to B</span>
<span class="linenr"> 931: </span>    <span style="color: #e45649;">subb</span>    #$30                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">convert from ascii</span>
<span class="linenr"> 932: </span>    <span style="color: #e45649;">addd</span>    SP                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">D += accum</span>
<span class="linenr"> 933: </span>    <span style="color: #e45649;">std</span>     SP                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">accum = D</span>
<span class="linenr"> 934: </span>    <span style="color: #e45649;">bra</span>     atoi_exit           <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">at this point, loop is finished</span>
<span class="linenr"> 935: </span>
<span class="linenr"> 936: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">because of the previous if statement, we know that index and power</span>
<span class="linenr"> 937: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">will always be at least 1</span>
<span class="linenr"> 938: </span><span style="color: #a626a4;">atoi_calc_power</span>
<span class="linenr"> 939: </span>    <span style="color: #e45649;">clra</span>
<span class="linenr"> 940: </span>    <span style="color: #e45649;">ldab</span>    X                   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">load lower 8 bits to B</span>
<span class="linenr"> 941: </span>    <span style="color: #e45649;">subb</span>    #$30                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">convert from ascii</span>
<span class="linenr"> 942: </span>
<span class="linenr"> 943: </span>    <span style="color: #e45649;">std</span>     <span style="color: #50a14f;">2</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">store in tmp</span>
<span class="linenr"> 944: </span><span style="color: #a626a4;">atoi_calc_power_lp</span>
<span class="linenr"> 945: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">4</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if pow = 0, break</span>
<span class="linenr"> 946: </span>    <span style="color: #e45649;">cmpa</span>    #<span style="color: #50a14f;">0</span>                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 947: </span>    <span style="color: #e45649;">beq</span>     atoi_calc_power_exit<span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 948: </span>    <span style="color: #e45649;">dec</span>     <span style="color: #50a14f;">4</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">decrement pow var</span>
<span class="linenr"> 949: </span>
<span class="linenr"> 950: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">prepare for first shift</span>
<span class="linenr"> 951: </span>    <span style="color: #e45649;">ldd</span>     <span style="color: #50a14f;">2</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">D = tmp</span>
<span class="linenr"> 952: </span>    <span style="color: #e45649;">tfr</span>     D,Y                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">stash D in Y</span>
<span class="linenr"> 953: </span>
<span class="linenr"> 954: </span>    <span style="color: #e45649;">lsld</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">D *= 8</span>
<span class="linenr"> 955: </span>    <span style="color: #e45649;">lsld</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 956: </span>    <span style="color: #e45649;">lsld</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 957: </span>
<span class="linenr"> 958: </span>    <span style="color: #e45649;">std</span>     <span style="color: #50a14f;">2</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">tmp = D</span>
<span class="linenr"> 959: </span>
<span class="linenr"> 960: </span>    <span style="color: #9ca0a4;">;; </span><span style="color: #9ca0a4;">prepare for shift again</span>
<span class="linenr"> 961: </span>    <span style="color: #e45649;">tfr</span>     Y,D                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">retrieve D from Y</span>
<span class="linenr"> 962: </span>
<span class="linenr"> 963: </span>    <span style="color: #e45649;">lsld</span>                        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">D *= 2</span>
<span class="linenr"> 964: </span>
<span class="linenr"> 965: </span>    <span style="color: #e45649;">addd</span>    <span style="color: #50a14f;">2</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">tmp += D</span>
<span class="linenr"> 966: </span>    <span style="color: #e45649;">std</span>     <span style="color: #50a14f;">2</span>,SP                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 967: </span>
<span class="linenr"> 968: </span>    <span style="color: #e45649;">bra</span>     atoi_calc_power_lp
<span class="linenr"> 969: </span>
<span class="linenr"> 970: </span><span style="color: #a626a4;">atoi_calc_power_exit</span>
<span class="linenr"> 971: </span>    <span style="color: #e45649;">ldd</span>     <span style="color: #50a14f;">2</span>,SP                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">load tmp into D</span>
<span class="linenr"> 972: </span>    <span style="color: #e45649;">addd</span>    SP                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">add tmp to accum</span>
<span class="linenr"> 973: </span>    <span style="color: #e45649;">std</span>     SP                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr"> 974: </span>    <span style="color: #e45649;">bra</span>     atoi_accumulate
<span class="linenr"> 975: </span>
<span class="linenr"> 976: </span><span style="color: #a626a4;">atoi_exit</span>
<span class="linenr"> 977: </span>    <span style="color: #e45649;">ldd</span>     SP                  <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">D = accumulator</span>
<span class="linenr"> 978: </span>    <span style="color: #e45649;">leas</span>    <span style="color: #50a14f;">6</span>,SP
<span class="linenr"> 979: </span>    <span style="color: #e45649;">pulx</span>
<span class="linenr"> 980: </span>    <span style="color: #e45649;">puly</span>
<span class="linenr"> 981: </span>    <span style="color: #e45649;">rts</span>
<span class="linenr"> 982: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr"> 983: </span>
<span class="linenr"> 984: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">is_dig</span>
<span class="linenr"> 985: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 986: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Program:    determines if the value in A is an ascii digit</span>
<span class="linenr"> 987: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 988: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Input:      A register: Ascii test value</span>
<span class="linenr"> 989: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 990: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Output:     Modifies Zero bit in CCR</span>
<span class="linenr"> 991: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr"> 992: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Algorithm:</span>
<span class="linenr"> 993: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">if A &lt; '0' or A &gt; '9':</span>
<span class="linenr"> 994: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">return false</span>
<span class="linenr"> 995: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">else:</span>
<span class="linenr"> 996: </span><span style="color: #9ca0a4;">;;;         </span><span style="color: #9ca0a4;">return true</span>
<span class="linenr"> 997: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr"> 998: </span><span style="color: #a626a4;">is_dig</span>
<span class="linenr"> 999: </span>    <span style="color: #e45649;">cmpa</span>    #'<span style="color: #50a14f;">0</span>'                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">if A &lt; '0' or A &gt; '9' return false</span>
<span class="linenr">1000: </span>    <span style="color: #e45649;">blo</span>     is_dig_false        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr">1001: </span>    <span style="color: #e45649;">cmpa</span>    #'<span style="color: #50a14f;">9</span>'                <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr">1002: </span>    <span style="color: #e45649;">bhi</span>     is_dig_false        <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">|</span>
<span class="linenr">1003: </span>
<span class="linenr">1004: </span><span style="color: #a626a4;">is_dig_true</span>
<span class="linenr">1005: </span>    <span style="color: #e45649;">orcc</span>    #<span style="color: #6a1868;">%00000100</span>          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">set Z bit in CCR</span>
<span class="linenr">1006: </span>    <span style="color: #e45649;">rts</span>
<span class="linenr">1007: </span>
<span class="linenr">1008: </span><span style="color: #a626a4;">is_dig_false</span>
<span class="linenr">1009: </span>    <span style="color: #e45649;">andcc</span>   #<span style="color: #6a1868;">%11111011</span>          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">clear Z bit in CCR</span>
<span class="linenr">1010: </span>    <span style="color: #e45649;">rts</span>
<span class="linenr">1011: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr">1012: </span>
<span class="linenr">1013: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">print</span>
<span class="linenr">1014: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">1015: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Program: Output character string to SCI port, print message</span>
<span class="linenr">1016: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Input:   Register X points to ASCII characters in memory</span>
<span class="linenr">1017: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Output:  message printed on the terminal connected to SCI port</span>
<span class="linenr">1018: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">1019: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Registers modified: CCR</span>
<span class="linenr">1020: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Algorithm:</span>
<span class="linenr">1021: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">Pick up 1 byte from memory where X register is pointing</span>
<span class="linenr">1022: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">Send it out to SCI port</span>
<span class="linenr">1023: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">Update X register to point to the next byte</span>
<span class="linenr">1024: </span><span style="color: #9ca0a4;">;;;     </span><span style="color: #9ca0a4;">Repeat until the byte data $00 is encountered</span>
<span class="linenr">1025: </span><span style="color: #9ca0a4;">;;;       </span><span style="color: #9ca0a4;">(String is terminated with NULL=$00)</span>
<span class="linenr">1026: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr">1027: </span><span style="color: #a626a4;">print</span>
<span class="linenr">1028: </span>    <span style="color: #e45649;">psha</span>                   <span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">Save registers</span>
<span class="linenr">1029: </span>    <span style="color: #e45649;">pshx</span>
<span class="linenr">1030: </span><span style="color: #a626a4;">printmsgloop</span>
<span class="linenr">1031: </span>    <span style="color: #e45649;">ldaa</span>    <span style="color: #50a14f;">1</span>,X+           <span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">pick up an ASCII character from string</span>
<span class="linenr">1032: </span>                            <span style="color: #9ca0a4;">;   </span><span style="color: #9ca0a4;">pointed by X register</span>
<span class="linenr">1033: </span>                            <span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">then update the X register to point to</span>
<span class="linenr">1034: </span>                            <span style="color: #9ca0a4;">;   </span><span style="color: #9ca0a4;">the next byte</span>
<span class="linenr">1035: </span>    <span style="color: #e45649;">cmpa</span>    #NULL
<span class="linenr">1036: </span>    <span style="color: #e45649;">beq</span>     printmsgdone   <span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">end of strint yet?</span>
<span class="linenr">1037: </span>    <span style="color: #e45649;">jsr</span>     putchar        <span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">if not, print character and do next</span>
<span class="linenr">1038: </span>    <span style="color: #e45649;">bra</span>     printmsgloop
<span class="linenr">1039: </span>
<span class="linenr">1040: </span><span style="color: #a626a4;">printmsgdone</span>
<span class="linenr">1041: </span>    <span style="color: #e45649;">pulx</span>
<span class="linenr">1042: </span>    <span style="color: #e45649;">pula</span>
<span class="linenr">1043: </span>    <span style="color: #e45649;">rts</span>
<span class="linenr">1044: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr">1045: </span>
<span class="linenr">1046: </span>
<span class="linenr">1047: </span>
<span class="linenr">1048: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr">1049: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">putchar</span>
<span class="linenr">1050: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">1051: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Program: Send one character to SCI port, terminal</span>
<span class="linenr">1052: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Input:   Accumulator A contains an ASCII character, 8bit</span>
<span class="linenr">1053: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Output:  Send one character to SCI port, terminal</span>
<span class="linenr">1054: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Registers modified: CCR</span>
<span class="linenr">1055: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Algorithm:</span>
<span class="linenr">1056: </span><span style="color: #9ca0a4;">;;;    </span><span style="color: #9ca0a4;">Wait for transmit buffer become empty</span>
<span class="linenr">1057: </span><span style="color: #9ca0a4;">;;;      </span><span style="color: #9ca0a4;">Transmit buffer empty is indicated by TDRE bit</span>
<span class="linenr">1058: </span><span style="color: #9ca0a4;">;;;      </span><span style="color: #9ca0a4;">TDRE = 1 : empty - Transmit Data Register Empty, ready to transmit</span>
<span class="linenr">1059: </span><span style="color: #9ca0a4;">;;;      </span><span style="color: #9ca0a4;">TDRE = 0 : not empty, transmission in progress</span>
<span class="linenr">1060: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr">1061: </span><span style="color: #a626a4;">putchar</span>
<span class="linenr">1062: </span>    <span style="color: #e45649;">brclr</span> SCISR1,#<span style="color: #6a1868;">%10000000</span>,putchar   <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">wait for transmit buffer empty</span>
<span class="linenr">1063: </span>    <span style="color: #e45649;">staa</span>  SCIDRL                      <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">send a character</span>
<span class="linenr">1064: </span>    <span style="color: #e45649;">rts</span>
<span class="linenr">1065: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr">1066: </span>
<span class="linenr">1067: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr">1068: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">getchar</span>
<span class="linenr">1069: </span><span style="color: #9ca0a4;">;;;</span>
<span class="linenr">1070: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Program: Input one character from SCI port (terminal/keyboard)</span>
<span class="linenr">1071: </span><span style="color: #9ca0a4;">;;;             </span><span style="color: #9ca0a4;">if a character is received, other wise return NULL</span>
<span class="linenr">1072: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Input:   none</span>
<span class="linenr">1073: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Output:  Accumulator A containing the received ASCII character</span>
<span class="linenr">1074: </span><span style="color: #9ca0a4;">;;;          </span><span style="color: #9ca0a4;">if a character is received.</span>
<span class="linenr">1075: </span><span style="color: #9ca0a4;">;;;          </span><span style="color: #9ca0a4;">Otherwise Accumulator A will contain a NULL character, $00.</span>
<span class="linenr">1076: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Registers modified: CCR</span>
<span class="linenr">1077: </span><span style="color: #9ca0a4;">;;; </span><span style="color: #9ca0a4;">Algorithm:</span>
<span class="linenr">1078: </span><span style="color: #9ca0a4;">;;;    </span><span style="color: #9ca0a4;">Check for receive buffer become full</span>
<span class="linenr">1079: </span><span style="color: #9ca0a4;">;;;      </span><span style="color: #9ca0a4;">Receive buffer full is indicated by RDRF bit</span>
<span class="linenr">1080: </span><span style="color: #9ca0a4;">;;;      </span><span style="color: #9ca0a4;">RDRF = 1 : full - Receive Data Register Full, 1 byte received</span>
<span class="linenr">1081: </span><span style="color: #9ca0a4;">;;;      </span><span style="color: #9ca0a4;">RDRF = 0 : not full, 0 byte received</span>
<span class="linenr">1082: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr">1083: </span><span style="color: #a626a4;">getchar</span>
<span class="linenr">1084: </span>    <span style="color: #e45649;">brclr</span> SCISR1,#<span style="color: #6a1868;">%00100000</span>,getchar7
<span class="linenr">1085: </span>    <span style="color: #e45649;">ldaa</span>  SCIDRL
<span class="linenr">1086: </span>    <span style="color: #e45649;">rts</span>
<span class="linenr">1087: </span><span style="color: #a626a4;">getchar7</span>
<span class="linenr">1088: </span>    <span style="color: #e45649;">clra</span>
<span class="linenr">1089: </span>    <span style="color: #e45649;">rts</span>
<span class="linenr">1090: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr">1091: </span>
<span class="linenr">1092: </span><span style="color: #9ca0a4;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="linenr">1093: </span><span style="color: #a626a4;">rtiisr</span>
<span class="linenr">1094: </span>    <span style="color: #e45649;">bset</span>    CRGFLG,<span style="color: #6a1868;">%10000000</span> <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">clear RTI Interrupt Flag - for the next one</span>
<span class="linenr">1095: </span>    <span style="color: #e45649;">ldx</span>     ctr2p5m          <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">every time the RTI occur, increase</span>
<span class="linenr">1096: </span>    <span style="color: #e45649;">inx</span>                      <span style="color: #9ca0a4;">;    </span><span style="color: #9ca0a4;">the 16bit interrupt count</span>
<span class="linenr">1097: </span>    <span style="color: #e45649;">stx</span>     ctr2p5m
<span class="linenr">1098: </span>    <span style="color: #e45649;">rti</span>
<span class="linenr">1099: </span>
<span class="linenr">1100: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">OPTIONAL</span>
<span class="linenr">1101: </span><span style="color: #9ca0a4;">;</span><span style="color: #9ca0a4;">more variable/data section below</span>
<span class="linenr">1102: </span><span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">this is after the program code section</span>
<span class="linenr">1103: </span><span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">of the RAM.  RAM ends at $3FFF</span>
<span class="linenr">1104: </span><span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">in MC9S12C128 chip</span>
<span class="linenr">1105: </span>
<span class="linenr">1106: </span>               <span style="color: #e45649;">END</span>               <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">this is end of assembly source file</span>
<span class="linenr">1107: </span>                                 <span style="color: #9ca0a4;">; </span><span style="color: #9ca0a4;">lines below are ignored - not assembled/compiled</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5e5455a" class="outline-3">
<h3 id="org5e5455a">Computer Engineering 473</h3>
<div class="outline-text-3" id="text-org5e5455a">

<div id="org8852a25" class="figure">
<p><img src="../resources/portfolio/car_demo.jpg" alt="car_demo.jpg" width="700px" margin="auto">
</p>
</div>

<p>
This course was also taught by Professor Choi, the course webpage can be found
<a href="https://www.cse.psu.edu/~kxc104/class/cmpen473/22s/">here</a>. We spent the semester designing and building an autonomous robotic car
from scratch, using a Raspberry Pi 4. We started by learning how to access the
GPIO registers on the Pi in memory, using the <code>mmap</code> C function. From that point
on, continued to iterate on the design, constantly adding new features.
</p>
</div>

<div id="outline-container-orgf1a8595" class="outline-4">
<h4 id="orgf1a8595">Ring Buffer Implmentation</h4>
<div class="outline-text-4" id="text-orgf1a8595">
<p>
This course heavily incorporated multithreaded programming and interthread
communication. Most of my peers used the professor&rsquo;s FIFO implementation, but I
had already made a ring-buffer implementation by the time he distributed his
solution.
</p>
</div>

<div id="outline-container-org85f65d5" class="outline-5">
<h5 id="org85f65d5">ringbuf.h</h5>
<div class="outline-text-5" id="text-org85f65d5">
<div class="org-src-container">
<pre class="src src-c"><span class="linenr"> 1: </span><span style="color: #4078f2; font-weight: bold;">#if</span><span style="color: #4078f2; font-weight: bold;">n</span><span style="color: #4078f2; font-weight: bold;">def</span> <span style="color: #b751b6;">RINGBUF_H</span>
<span class="linenr"> 2: </span><span style="color: #4078f2; font-weight: bold;">#define</span> <span style="color: #6a1868;">RINGBUF_H</span>
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">stdlib.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span><span style="color: #9ca0a4;">/* </span><span style="color: #9ca0a4;">Lock-Free thread messaging.</span>
<span class="linenr"> 7: </span><span style="color: #9ca0a4;"> *</span>
<span class="linenr"> 8: </span><span style="color: #9ca0a4;"> * ring-buffer has designated producers and consumers. the read-head points to</span>
<span class="linenr"> 9: </span><span style="color: #9ca0a4;"> * the location of the next insertion, and the read-head points to the location</span>
<span class="linenr">10: </span><span style="color: #9ca0a4;"> * before the next read.</span>
<span class="linenr">11: </span><span style="color: #9ca0a4;"> *</span>
<span class="linenr">12: </span><span style="color: #9ca0a4;"> * every time an element is inserted into the ringbuffer, the write_head is</span>
<span class="linenr">13: </span><span style="color: #9ca0a4;"> * incremented.</span>
<span class="linenr">14: </span><span style="color: #9ca0a4;">*</span><span style="color: #9ca0a4;">*/</span>
<span class="linenr">15: </span><span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span> <span style="color: #4078f2;">{</span>
<span class="linenr">16: </span>    <span style="color: #986801;">char</span>* <span style="color: #6a1868;">_buffer</span>;
<span class="linenr">17: </span>    <span style="color: #986801;">size_t</span> <span style="color: #6a1868;">length</span>;
<span class="linenr">18: </span>    <span style="color: #986801;">size_t</span> <span style="color: #6a1868;">element_size</span>;
<span class="linenr">19: </span>
<span class="linenr">20: </span>    <span style="color: #986801;">int</span> <span style="color: #6a1868;">write_head</span>;
<span class="linenr">21: </span>    <span style="color: #986801;">int</span> <span style="color: #6a1868;">read_head</span>;
<span class="linenr">22: </span><span style="color: #4078f2;">}</span>;
<span class="linenr">23: </span>
<span class="linenr">24: </span><span style="color: #9ca0a4;">/// </span><span style="color: #9ca0a4;">wrapper struct. This struct is what is passed to the producer thread.</span>
<span class="linenr">25: </span><span style="color: #9ca0a4;">/// </span><span style="color: #9ca0a4;">the ringbuffer field is not meant to be directly accessed.</span>
<span class="linenr">26: </span><span style="color: #e45649;">struct</span> <span style="color: #986801;">Producer</span> <span style="color: #4078f2;">{</span>
<span class="linenr">27: </span>    <span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span>* <span style="color: #6a1868;">_ringbuf</span>;
<span class="linenr">28: </span><span style="color: #4078f2;">}</span>;
<span class="linenr">29: </span>
<span class="linenr">30: </span><span style="color: #9ca0a4;">/// </span><span style="color: #9ca0a4;">wrapper struct. This struct is what is passed to the consumer thread.</span>
<span class="linenr">31: </span><span style="color: #9ca0a4;">/// </span><span style="color: #9ca0a4;">the ringbuffer field is not meant to be directly accessed.</span>
<span class="linenr">32: </span><span style="color: #e45649;">struct</span> <span style="color: #986801;">Consumer</span> <span style="color: #4078f2;">{</span>
<span class="linenr">33: </span>    <span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span>* <span style="color: #6a1868;">_ringbuf</span>;
<span class="linenr">34: </span><span style="color: #4078f2;">}</span>;
<span class="linenr">35: </span>
<span class="linenr">36: </span><span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span> <span style="color: #a626a4;">ringbuf_new</span><span style="color: #4078f2;">(</span><span style="color: #986801;">size_t</span> <span style="color: #6a1868;">len</span>, <span style="color: #986801;">size_t</span> <span style="color: #6a1868;">element_size</span><span style="color: #4078f2;">)</span>;
<span class="linenr">37: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">ringbuf_del</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span>* <span style="color: #6a1868;">ringbuf</span><span style="color: #4078f2;">)</span>;
<span class="linenr">38: </span>
<span class="linenr">39: </span><span style="color: #986801;">int</span> <span style="color: #a626a4;">ringbuf_next_index</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">const</span> <span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span>* <span style="color: #6a1868;">rb</span>, <span style="color: #986801;">int</span> <span style="color: #6a1868;">index</span><span style="color: #4078f2;">)</span>;
<span class="linenr">40: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">ringbuf_print</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span>* <span style="color: #6a1868;">rb</span><span style="color: #4078f2;">)</span>;
<span class="linenr">41: </span>
<span class="linenr">42: </span><span style="color: #e45649;">struct</span> <span style="color: #986801;">Producer</span> <span style="color: #a626a4;">ringbuf_make_producer</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span>* <span style="color: #6a1868;">ringbuf</span><span style="color: #4078f2;">)</span>;
<span class="linenr">43: </span>
<span class="linenr">44: </span><span style="color: #9ca0a4;">/// </span><span style="color: #9ca0a4;">pushes value into the ringbuffer returns 0 on success.</span>
<span class="linenr">45: </span><span style="color: #9ca0a4;">/// </span><span style="color: #9ca0a4;">may fail if the ring buffer is full (ie, write-head runs into read-head).</span>
<span class="linenr">46: </span><span style="color: #9ca0a4;">/// </span><span style="color: #9ca0a4;">returns -1 on fail</span>
<span class="linenr">47: </span><span style="color: #986801;">int</span> <span style="color: #a626a4;">producer_push</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">Producer</span>* <span style="color: #6a1868;">producer</span>, <span style="color: #986801;">void</span>* <span style="color: #6a1868;">val</span><span style="color: #4078f2;">)</span>;
<span class="linenr">48: </span>
<span class="linenr">49: </span><span style="color: #e45649;">struct</span> <span style="color: #986801;">Consumer</span> <span style="color: #a626a4;">ringbuf_make_consumer</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span>* <span style="color: #6a1868;">ringbuf</span><span style="color: #4078f2;">)</span>;
<span class="linenr">50: </span>
<span class="linenr">51: </span><span style="color: #986801;">void</span>* <span style="color: #a626a4;">consumer_pop</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">Consumer</span>* <span style="color: #6a1868;">consumer</span><span style="color: #4078f2;">)</span>;
<span class="linenr">52: </span><span style="color: #986801;">void</span>* <span style="color: #a626a4;">consumer_peek</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">Consumer</span>* <span style="color: #6a1868;">consumer</span><span style="color: #4078f2;">)</span>;
<span class="linenr">53: </span>
<span class="linenr">54: </span>
<span class="linenr">55: </span><span style="color: #4078f2; font-weight: bold;">#endif</span> <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">RINGBUF_H</span>
<span class="linenr">56: </span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4283494" class="outline-5">
<h5 id="org4283494">ringub.c</h5>
<div class="outline-text-5" id="text-org4283494">
<div class="org-src-container">
<pre class="src src-c"><span class="linenr">  1: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #50a14f;">"ringbuf.h"</span>
<span class="linenr">  2: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">stdlib.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  3: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">string.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  4: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">stdio.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  5: </span>
<span class="linenr">  6: </span><span style="color: #9ca0a4;">/// </span><span style="color: #9ca0a4;">allocates/creates a new ringbuffer</span>
<span class="linenr">  7: </span><span style="color: #9ca0a4;">///</span>
<span class="linenr">  8: </span><span style="color: #9ca0a4;">/// </span><span style="color: #9ca0a4;">len must be at least 3</span>
<span class="linenr">  9: </span><span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span> <span style="color: #a626a4;">ringbuf_new</span><span style="color: #4078f2;">(</span><span style="color: #986801;">size_t</span> <span style="color: #6a1868;">len</span>, <span style="color: #986801;">size_t</span> <span style="color: #6a1868;">element_size</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 10: </span>    <span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span> <span style="color: #6a1868;">rb</span>;
<span class="linenr"> 11: </span>
<span class="linenr"> 12: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">allocate space for the ring-buffer</span>
<span class="linenr"> 13: </span>    rb._buffer = malloc<span style="color: #a626a4;">(</span>len * element_size<span style="color: #a626a4;">)</span>;
<span class="linenr"> 14: </span>    rb.length = len;
<span class="linenr"> 15: </span>    rb.element_size = element_size;
<span class="linenr"> 16: </span>
<span class="linenr"> 17: </span>    rb.write_head = <span style="color: #da8548; font-weight: bold;">1</span>;
<span class="linenr"> 18: </span>    rb.read_head = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr"> 19: </span>
<span class="linenr"> 20: </span>    <span style="color: #e45649;">return</span> rb;
<span class="linenr"> 21: </span><span style="color: #4078f2;">}</span>
<span class="linenr"> 22: </span>
<span class="linenr"> 23: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">debug function, prints the ring-buffer</span>
<span class="linenr"> 24: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">ringbuf_print</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span>* <span style="color: #6a1868;">rb</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 25: </span>    printf<span style="color: #a626a4;">(</span><span style="color: #50a14f;">"ringbuf: &lt; "</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 26: </span>    <span style="color: #e45649;">for</span> <span style="color: #a626a4;">(</span><span style="color: #986801;">char</span>* <span style="color: #6a1868;">c</span> = rb-&gt;_buffer; c &lt;= &amp;rb-&gt;_buffer<span style="color: #50a14f;">[</span>rb-&gt;length - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #50a14f;">]</span>; c++<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr"> 27: </span>        printf<span style="color: #50a14f;">(</span><span style="color: #50a14f;">"%d "</span>, *c<span style="color: #50a14f;">)</span>;
<span class="linenr"> 28: </span>    <span style="color: #a626a4;">}</span>
<span class="linenr"> 29: </span>
<span class="linenr"> 30: </span>    printf<span style="color: #a626a4;">(</span><span style="color: #50a14f;">"&gt;\n"</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 31: </span><span style="color: #4078f2;">}</span>
<span class="linenr"> 32: </span><span style="color: #9ca0a4;">/// </span><span style="color: #9ca0a4;">frees the ringbuffer zeros it's fields</span>
<span class="linenr"> 33: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">ringbuf_del</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span> *<span style="color: #6a1868;">rb</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 34: </span>    free<span style="color: #a626a4;">(</span><span style="color: #50a14f;">(</span><span style="color: #986801;">void</span> *<span style="color: #50a14f;">)</span>rb-&gt;_buffer<span style="color: #a626a4;">)</span>;
<span class="linenr"> 35: </span>    rb-&gt;element_size = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr"> 36: </span>    rb-&gt;length = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr"> 37: </span>    rb-&gt;_buffer = <span style="color: #b751b6;">NULL</span>;
<span class="linenr"> 38: </span>    rb-&gt;write_head = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr"> 39: </span>    rb-&gt;read_head = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr"> 40: </span><span style="color: #4078f2;">}</span>
<span class="linenr"> 41: </span>
<span class="linenr"> 42: </span><span style="color: #986801;">int</span> <span style="color: #a626a4;">ringbuf_next_index</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">const</span> <span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span>* <span style="color: #6a1868;">rb</span>, <span style="color: #986801;">int</span> <span style="color: #6a1868;">index</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 43: </span>    <span style="color: #986801;">int</span> <span style="color: #6a1868;">new</span> = index + <span style="color: #da8548; font-weight: bold;">1</span>;
<span class="linenr"> 44: </span>    <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span>new &gt;= rb-&gt;length<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr"> 45: </span>        <span style="color: #e45649;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr"> 46: </span>    <span style="color: #a626a4;">}</span> <span style="color: #e45649;">else</span> <span style="color: #a626a4;">{</span>
<span class="linenr"> 47: </span>        <span style="color: #e45649;">return</span> new;
<span class="linenr"> 48: </span>    <span style="color: #a626a4;">}</span>
<span class="linenr"> 49: </span><span style="color: #4078f2;">}</span>
<span class="linenr"> 50: </span>
<span class="linenr"> 51: </span><span style="color: #e45649;">struct</span> <span style="color: #986801;">Producer</span> <span style="color: #a626a4;">ringbuf_make_producer</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span> *<span style="color: #6a1868;">rb</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 52: </span>    <span style="color: #e45649;">struct</span> <span style="color: #986801;">Producer</span> <span style="color: #6a1868;">prod</span>;
<span class="linenr"> 53: </span>
<span class="linenr"> 54: </span>    prod._ringbuf = rb;
<span class="linenr"> 55: </span>
<span class="linenr"> 56: </span>    <span style="color: #e45649;">return</span> prod;
<span class="linenr"> 57: </span><span style="color: #4078f2;">}</span>
<span class="linenr"> 58: </span>
<span class="linenr"> 59: </span><span style="color: #986801;">int</span> <span style="color: #a626a4;">producer_push</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">Producer</span>* <span style="color: #6a1868;">producer</span>, <span style="color: #986801;">void</span>* <span style="color: #6a1868;">val</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 60: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">get an easy handle to the ring-buffer</span>
<span class="linenr"> 61: </span>    <span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span> <span style="color: #6a1868;">rb</span> = *producer-&gt;_ringbuf;
<span class="linenr"> 62: </span>
<span class="linenr"> 63: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">ringbuffer is full, need to wait until consumer increments the read head.</span>
<span class="linenr"> 64: </span>    <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span>ringbuf_next_index<span style="color: #50a14f;">(</span>&amp;rb, rb.write_head<span style="color: #50a14f;">)</span> == rb.read_head<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr"> 65: </span>        <span style="color: #e45649;">return</span> -<span style="color: #da8548; font-weight: bold;">1</span>;
<span class="linenr"> 66: </span>    <span style="color: #a626a4;">}</span>
<span class="linenr"> 67: </span>
<span class="linenr"> 68: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">copy the data into the ring-buffer</span>
<span class="linenr"> 69: </span>    <span style="color: #986801;">char</span>* <span style="color: #6a1868;">dest</span> = rb._buffer + rb.write_head*rb.element_size;
<span class="linenr"> 70: </span>    memcpy<span style="color: #a626a4;">(</span>dest, val, rb.element_size<span style="color: #a626a4;">)</span>;
<span class="linenr"> 71: </span>
<span class="linenr"> 72: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">wrap the write head around if it is past the upper bound</span>
<span class="linenr"> 73: </span>    producer-&gt;_ringbuf-&gt;write_head = ringbuf_next_index<span style="color: #a626a4;">(</span>&amp;rb, rb.write_head<span style="color: #a626a4;">)</span>;
<span class="linenr"> 74: </span>
<span class="linenr"> 75: </span>    <span style="color: #e45649;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr"> 76: </span><span style="color: #4078f2;">}</span>
<span class="linenr"> 77: </span>
<span class="linenr"> 78: </span><span style="color: #e45649;">struct</span> <span style="color: #986801;">Consumer</span> <span style="color: #a626a4;">ringbuf_make_consumer</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span> *<span style="color: #6a1868;">rb</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 79: </span>    <span style="color: #e45649;">struct</span> <span style="color: #986801;">Consumer</span> <span style="color: #6a1868;">con</span>;
<span class="linenr"> 80: </span>
<span class="linenr"> 81: </span>    con._ringbuf = rb;
<span class="linenr"> 82: </span>
<span class="linenr"> 83: </span>    <span style="color: #e45649;">return</span> con;
<span class="linenr"> 84: </span><span style="color: #4078f2;">}</span>
<span class="linenr"> 85: </span>
<span class="linenr"> 86: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">increments the read head and returns the value.</span>
<span class="linenr"> 87: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">returns NULL if buffer is empty</span>
<span class="linenr"> 88: </span><span style="color: #986801;">void</span>* <span style="color: #a626a4;">consumer_pop</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">Consumer</span>* <span style="color: #6a1868;">consumer</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 89: </span>    <span style="color: #986801;">void</span>* <span style="color: #6a1868;">val</span> = consumer_peek<span style="color: #a626a4;">(</span>consumer<span style="color: #a626a4;">)</span>;
<span class="linenr"> 90: </span>
<span class="linenr"> 91: </span>    <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span>val == <span style="color: #b751b6;">NULL</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr"> 92: </span>        <span style="color: #e45649;">return</span> <span style="color: #b751b6;">NULL</span>;
<span class="linenr"> 93: </span>    <span style="color: #a626a4;">}</span>
<span class="linenr"> 94: </span>
<span class="linenr"> 95: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">get an easy handle to the ring-buffer</span>
<span class="linenr"> 96: </span>    <span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span> <span style="color: #6a1868;">rb</span> = *consumer-&gt;_ringbuf;
<span class="linenr"> 97: </span>
<span class="linenr"> 98: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">wrap the write head around if it is past the upper bound</span>
<span class="linenr"> 99: </span>    consumer-&gt;_ringbuf-&gt;read_head = ringbuf_next_index<span style="color: #a626a4;">(</span>&amp;rb, rb.read_head<span style="color: #a626a4;">)</span>;
<span class="linenr">100: </span>    <span style="color: #e45649;">return</span> val;
<span class="linenr">101: </span><span style="color: #4078f2;">}</span>
<span class="linenr">102: </span>
<span class="linenr">103: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">returns the value after the read head.</span>
<span class="linenr">104: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">returns NULL if buffer is empty</span>
<span class="linenr">105: </span><span style="color: #986801;">void</span>* <span style="color: #a626a4;">consumer_peek</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">Consumer</span>* <span style="color: #6a1868;">consumer</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr">106: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">get an easy handle to the ring-buffer</span>
<span class="linenr">107: </span>    <span style="color: #e45649;">struct</span> <span style="color: #986801;">RingBuffer</span> <span style="color: #6a1868;">rb</span> = *consumer-&gt;_ringbuf;
<span class="linenr">108: </span>
<span class="linenr">109: </span>    <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span>ringbuf_next_index<span style="color: #50a14f;">(</span>&amp;rb, rb.read_head<span style="color: #50a14f;">)</span> == rb.write_head<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr">110: </span>        <span style="color: #e45649;">return</span> <span style="color: #b751b6;">NULL</span>;
<span class="linenr">111: </span>    <span style="color: #a626a4;">}</span>
<span class="linenr">112: </span>
<span class="linenr">113: </span>    <span style="color: #e45649;">return</span> rb._buffer + ringbuf_next_index<span style="color: #a626a4;">(</span>&amp;rb, rb.read_head<span style="color: #a626a4;">)</span>*rb.element_size;
<span class="linenr">114: </span><span style="color: #4078f2;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga52398f" class="outline-4">
<h4 id="orga52398f">Curses Asynchronous User Interface (for debugging)</h4>
<div class="outline-text-4" id="text-orga52398f">
<p>
One of the problems I faced while debugging this program was data visibility. I
often needed to see the state of many variables across many threads. This would
clog up the standard output during debugging, which prevented me from being able
to understand everything going on in my code. I decided to create a graphical
user interface using the ncurses API to help format all the data better.
</p>

<p>
Since ncurses is not an async library, this presented some challenges for me,
since I could no longer simply use print statements for debugging. I had to
create a custom API for the display so that it could be controlled
asynchronously from many threads. This API ended up being a source of
frustration for me, however, since my implementation had data races/unsafe
pointer utilization which I didn&rsquo;t discover until later in the semester.
</p>

<p>
This problem can be found on <i>line 148</i> of <code>gui.c</code>. As you can see here, I am
storing the pointer of the command or <b>data</b> to be written to the screen in a
queue, which will be processed at some point in the future. This is a problem,
because if that pointer is changed before the GUI prints the data at its
address, then it will start printing garbage and mess up the whole graphical
interface.
</p>
</div>

<div id="outline-container-orgae4f951" class="outline-5">
<h5 id="orgae4f951">gui.h</h5>
<div class="outline-text-5" id="text-orgae4f951">
<div class="org-src-container">
<pre class="src src-c"><span class="linenr">  1: </span><span style="color: #4078f2; font-weight: bold;">#if</span><span style="color: #4078f2; font-weight: bold;">n</span><span style="color: #4078f2; font-weight: bold;">def</span> <span style="color: #b751b6;">GUI_H_</span>
<span class="linenr">  2: </span><span style="color: #4078f2; font-weight: bold;">#define</span> <span style="color: #6a1868;">GUI_H_</span>
<span class="linenr">  3: </span>
<span class="linenr">  4: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">ncurses.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  5: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">stdlib.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  6: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">string.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  7: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">ringbuf.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  8: </span>
<span class="linenr">  9: </span><span style="color: #4078f2; font-weight: bold;">#define</span> <span style="color: #6a1868;">COMMAND_PROMPT</span> <span style="color: #50a14f;">"hw11&gt; "</span>
<span class="linenr"> 10: </span>
<span class="linenr"> 11: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">GUI data structure. This structure holds all the data that the GUI needs in</span>
<span class="linenr"> 12: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">order to operate. it contains WINDOW* fields which refer to ncurses windows.</span>
<span class="linenr"> 13: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">the help and status windows have additional "master" windows. The master</span>
<span class="linenr"> 14: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">windows are a little larger than the regular window, and contain the border</span>
<span class="linenr"> 15: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">and window title.</span>
<span class="linenr"> 16: </span><span style="color: #9ca0a4;">//</span>
<span class="linenr"> 17: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">there are strings associated with the title of the status and help windows.</span>
<span class="linenr"> 18: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">This string contains additional title data. For each window the title will</span>
<span class="linenr"> 19: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">read as follows:</span>
<span class="linenr"> 20: </span><span style="color: #9ca0a4;">//  </span><span style="color: #9ca0a4;">"[window: window_title]"</span>
<span class="linenr"> 21: </span><span style="color: #9ca0a4;">//  </span><span style="color: #9ca0a4;">where "window" is either "help" or "status".</span>
<span class="linenr"> 22: </span><span style="color: #9ca0a4;">//</span>
<span class="linenr"> 23: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">To add text to the status or help windows, one should use the wprintw</span>
<span class="linenr"> 24: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">function provided by ncurses.</span>
<span class="linenr"> 25: </span><span style="color: #9ca0a4;">//</span>
<span class="linenr"> 26: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">the cmd window is used for command input. the "line_mode" option allows line</span>
<span class="linenr"> 27: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">mode to be turned on/off. When line mode is off, only one character will ever</span>
<span class="linenr"> 28: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">be entered onto the command line. with line mode on, successive key presses</span>
<span class="linenr"> 29: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">will append the typed character onto the command line.</span>
<span class="linenr"> 30: </span><span style="color: #e45649;">typedef</span> <span style="color: #e45649;">struct</span> <span style="color: #986801;">Gui</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 31: </span>    <span style="color: #986801;">WINDOW</span> *<span style="color: #6a1868;">cmd</span>;
<span class="linenr"> 32: </span>    <span style="color: #986801;">bool</span> <span style="color: #6a1868;">line_mode</span>;
<span class="linenr"> 33: </span>
<span class="linenr"> 34: </span>    <span style="color: #986801;">WINDOW</span> *<span style="color: #6a1868;">help</span>;
<span class="linenr"> 35: </span>    <span style="color: #986801;">WINDOW</span> *<span style="color: #6a1868;">status</span>;
<span class="linenr"> 36: </span>
<span class="linenr"> 37: </span>    <span style="color: #986801;">WINDOW</span> *<span style="color: #6a1868;">help_master</span>;
<span class="linenr"> 38: </span>    <span style="color: #986801;">WINDOW</span> *<span style="color: #6a1868;">status_master</span>;
<span class="linenr"> 39: </span>
<span class="linenr"> 40: </span>    <span style="color: #986801;">int</span> <span style="color: #6a1868;">status_x</span>, <span style="color: #6a1868;">status_y</span>;
<span class="linenr"> 41: </span>    <span style="color: #986801;">int</span> <span style="color: #6a1868;">help_x</span>, <span style="color: #6a1868;">help_y</span>;
<span class="linenr"> 42: </span>
<span class="linenr"> 43: </span>    <span style="color: #986801;">char</span>* <span style="color: #6a1868;">status_title</span>;
<span class="linenr"> 44: </span>    <span style="color: #986801;">char</span>* <span style="color: #6a1868;">help_title</span>;
<span class="linenr"> 45: </span><span style="color: #4078f2;">}</span> <span style="color: #986801;">Gui</span>;
<span class="linenr"> 46: </span>
<span class="linenr"> 47: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">allocate and initialize the GUI structure. This data must be free'ed at the</span>
<span class="linenr"> 48: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">end of the program using the gui_del function.</span>
<span class="linenr"> 49: </span><span style="color: #986801;">Gui</span> <span style="color: #a626a4;">gui_init</span><span style="color: #4078f2;">()</span>;
<span class="linenr"> 50: </span>
<span class="linenr"> 51: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">frees data allocated by the GUI free function, and ends ncurses instance</span>
<span class="linenr"> 52: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">gui_del</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Gui</span>* <span style="color: #6a1868;">gui</span><span style="color: #4078f2;">)</span>;
<span class="linenr"> 53: </span>
<span class="linenr"> 54: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">gets input from the command line, returning the character. this is a blocking</span>
<span class="linenr"> 55: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">function. if non-blocking behavior is desired, a separate thread must be used.</span>
<span class="linenr"> 56: </span><span style="color: #986801;">char</span> <span style="color: #a626a4;">get_input</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Gui</span>* <span style="color: #6a1868;">wins</span><span style="color: #4078f2;">)</span>;
<span class="linenr"> 57: </span>
<span class="linenr"> 58: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">Changes the title of the status window. You cannot just replace the string in</span>
<span class="linenr"> 59: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">the structure, because the title/border isn't updated very often. this</span>
<span class="linenr"> 60: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">function updates the relative fields in the GUI structure, and then refreshes</span>
<span class="linenr"> 61: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">the window to display the changes</span>
<span class="linenr"> 62: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">status_set_title</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Gui</span>* <span style="color: #6a1868;">wins</span>, <span style="color: #986801;">char</span>* <span style="color: #6a1868;">title</span><span style="color: #4078f2;">)</span>;
<span class="linenr"> 63: </span>
<span class="linenr"> 64: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">clears the contents of the window. this function updates the relavant fields</span>
<span class="linenr"> 65: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">in the gui structure, and then refreshes the window to reflect those changes.</span>
<span class="linenr"> 66: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">status_clear</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Gui</span>* <span style="color: #6a1868;">wins</span><span style="color: #4078f2;">)</span>;
<span class="linenr"> 67: </span>
<span class="linenr"> 68: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">Changes the title of the status window. You cannot just replace the string in</span>
<span class="linenr"> 69: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">the structure, because the title/border isn't updated very often. this</span>
<span class="linenr"> 70: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">function updates the relative fields in the GUI structure, and then refreshes</span>
<span class="linenr"> 71: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">the window to display the changes</span>
<span class="linenr"> 72: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">help_set_title</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Gui</span>* <span style="color: #6a1868;">wins</span>, <span style="color: #986801;">char</span>* <span style="color: #6a1868;">title</span><span style="color: #4078f2;">)</span>;
<span class="linenr"> 73: </span>
<span class="linenr"> 74: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">clears the contents of the window. this function updates the relavant fields</span>
<span class="linenr"> 75: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">in the gui structure, and then refreshes the window to reflect those changes.</span>
<span class="linenr"> 76: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">help_clear</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Gui</span>* <span style="color: #6a1868;">wins</span><span style="color: #4078f2;">)</span>;
<span class="linenr"> 77: </span>
<span class="linenr"> 78: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">wprintw_file</span><span style="color: #4078f2;">(</span><span style="color: #986801;">WINDOW</span>* <span style="color: #6a1868;">win</span>, <span style="color: #986801;">char</span>* <span style="color: #6a1868;">filename</span><span style="color: #4078f2;">)</span>;
<span class="linenr"> 79: </span>
<span class="linenr"> 80: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">command which is used to print data to the GUI. Commands that print stuff may take</span>
<span class="linenr"> 81: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">either a c string (char*), or if the c-string is NULL, then the subsequent command</span>
<span class="linenr"> 82: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">entries will be DATA packets, each of which contain the c member of the union.</span>
<span class="linenr"> 83: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">this allows data to be copied over rather than referenced.</span>
<span class="linenr"> 84: </span><span style="color: #e45649;">typedef</span> <span style="color: #e45649;">struct</span> <span style="color: #986801;">GuiCommand</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 85: </span>    <span style="color: #e45649;">enum</span> <span style="color: #986801;">GuiControl</span> <span style="color: #a626a4;">{</span>
<span class="linenr"> 86: </span>        <span style="color: #6a1868;">PRINT_HELP</span>,
<span class="linenr"> 87: </span>        <span style="color: #6a1868;">PRINT_FILE_HELP</span>,
<span class="linenr"> 88: </span>        <span style="color: #6a1868;">PRINT_STATUS</span>,
<span class="linenr"> 89: </span>        <span style="color: #6a1868;">TERMINAL_PRINT</span>,
<span class="linenr"> 90: </span>        <span style="color: #6a1868;">TERMINAL_ENTER</span>,
<span class="linenr"> 91: </span>        <span style="color: #6a1868;">TERMINAL_RETURN</span>,
<span class="linenr"> 92: </span>        <span style="color: #6a1868;">SET_TITLE_HELP</span>,
<span class="linenr"> 93: </span>        <span style="color: #6a1868;">SET_TITLE_STATUS</span>,
<span class="linenr"> 94: </span>        <span style="color: #6a1868;">CLEAR_HELP</span>,
<span class="linenr"> 95: </span>        <span style="color: #6a1868;">CLEAR_STATUS</span>,
<span class="linenr"> 96: </span>        <span style="color: #6a1868;">REFRESH</span>,
<span class="linenr"> 97: </span>        <span style="color: #6a1868;">CMD_ECHO_ON</span>,
<span class="linenr"> 98: </span>        <span style="color: #6a1868;">CMD_ECHO_OFF</span>,
<span class="linenr"> 99: </span>        <span style="color: #6a1868;">GUI_EXIT</span>,
<span class="linenr">100: </span>
<span class="linenr">101: </span>        <span style="color: #6a1868;">DATA</span>
<span class="linenr">102: </span>    <span style="color: #a626a4;">}</span> <span style="color: #6a1868;">cmd</span>;
<span class="linenr">103: </span>
<span class="linenr">104: </span>    <span style="color: #e45649;">union</span> <span style="color: #a626a4;">{</span>
<span class="linenr">105: </span>        <span style="color: #986801;">char</span>* <span style="color: #6a1868;">data</span>;
<span class="linenr">106: </span>        <span style="color: #986801;">char</span> <span style="color: #6a1868;">c</span>;
<span class="linenr">107: </span>    <span style="color: #a626a4;">}</span>;
<span class="linenr">108: </span>
<span class="linenr">109: </span><span style="color: #4078f2;">}</span> <span style="color: #986801;">GuiCommand</span>;
<span class="linenr">110: </span>
<span class="linenr">111: </span><span style="color: #e45649;">struct</span> <span style="color: #986801;">GuiThreadParams</span> <span style="color: #4078f2;">{</span>
<span class="linenr">112: </span>    <span style="color: #986801;">Producer</span>* <span style="color: #6a1868;">input_rb</span>;
<span class="linenr">113: </span>    <span style="color: #986801;">Consumer</span>* <span style="color: #6a1868;">command_rb</span>;
<span class="linenr">114: </span><span style="color: #4078f2;">}</span>;
<span class="linenr">115: </span>
<span class="linenr">116: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">helper function to fascilitate printing and otherwise controlling the GUI</span>
<span class="linenr">117: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">from other threads</span>
<span class="linenr">118: </span><span style="color: #9ca0a4;">//</span>
<span class="linenr">119: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">for the window refresh command, an optional string can be provided to refresh</span>
<span class="linenr">120: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">specific windows.</span>
<span class="linenr">121: </span><span style="color: #9ca0a4;">//</span>
<span class="linenr">122: </span><span style="color: #9ca0a4;">//   </span><span style="color: #9ca0a4;">'s' = status</span>
<span class="linenr">123: </span><span style="color: #9ca0a4;">//   </span><span style="color: #9ca0a4;">'h' = help</span>
<span class="linenr">124: </span><span style="color: #9ca0a4;">//   </span><span style="color: #9ca0a4;">'c' = command</span>
<span class="linenr">125: </span><span style="color: #9ca0a4;">//   </span><span style="color: #9ca0a4;">'S' = status border</span>
<span class="linenr">126: </span><span style="color: #9ca0a4;">//   </span><span style="color: #9ca0a4;">'H' = help border</span>
<span class="linenr">127: </span><span style="color: #9ca0a4;">//</span>
<span class="linenr">128: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">multiple windows can be refreshed in the same command string, for example,</span>
<span class="linenr">129: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">all the following are valid:</span>
<span class="linenr">130: </span><span style="color: #9ca0a4;">//</span>
<span class="linenr">131: </span><span style="color: #9ca0a4;">//   </span><span style="color: #9ca0a4;">"shc"</span>
<span class="linenr">132: </span><span style="color: #9ca0a4;">//   </span><span style="color: #9ca0a4;">"Ss"</span>
<span class="linenr">133: </span><span style="color: #9ca0a4;">//   </span><span style="color: #9ca0a4;">"SH"</span>
<span class="linenr">134: </span><span style="color: #9ca0a4;">//</span>
<span class="linenr">135: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">one thing to note is that all three of the following will refresh all of the</span>
<span class="linenr">136: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">windows in one command:</span>
<span class="linenr">137: </span><span style="color: #9ca0a4;">//</span>
<span class="linenr">138: </span><span style="color: #9ca0a4;">//   </span><span style="color: #9ca0a4;">"shcSH"</span>
<span class="linenr">139: </span><span style="color: #9ca0a4;">//   </span><span style="color: #9ca0a4;">""</span>
<span class="linenr">140: </span><span style="color: #9ca0a4;">//   </span><span style="color: #9ca0a4;">NULL</span>
<span class="linenr">141: </span><span style="color: #9ca0a4;">//</span>
<span class="linenr">142: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">gui_command</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Producer</span>* <span style="color: #6a1868;">gui_cmd</span>, <span style="color: #e45649;">enum</span> <span style="color: #986801;">GuiControl</span> <span style="color: #6a1868;">ctrl</span>, <span style="color: #986801;">char</span>* <span style="color: #6a1868;">data</span><span style="color: #4078f2;">)</span>;
<span class="linenr">143: </span>
<span class="linenr">144: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">neat function to package and send a GUI command, however, this function will</span>
<span class="linenr">145: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">copy the data in the data string instead of passing a pointer.</span>
<span class="linenr">146: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">gui_print_cmd</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Producer</span>* <span style="color: #6a1868;">gui_cmd</span>, <span style="color: #e45649;">enum</span> <span style="color: #986801;">GuiControl</span> <span style="color: #6a1868;">ctrl</span>, <span style="color: #986801;">char</span>* <span style="color: #6a1868;">data</span><span style="color: #4078f2;">)</span>;
<span class="linenr">147: </span>
<span class="linenr">148: </span>
<span class="linenr">149: </span>
<span class="linenr">150: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">gui_thread</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">GuiThreadParams</span>* <span style="color: #6a1868;">params</span><span style="color: #4078f2;">)</span>;
<span class="linenr">151: </span>
<span class="linenr">152: </span><span style="color: #4078f2; font-weight: bold;">#endif</span> <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">GUI_H_</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf6bf770" class="outline-5">
<h5 id="orgf6bf770">gui.c</h5>
<div class="outline-text-5" id="text-orgf6bf770">
<div class="org-src-container">
<pre class="src src-c"><span class="linenr">  1: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">curses.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  2: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">fcntl.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  3: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">gui.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  4: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">ncurses.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  5: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">stdio.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  6: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">string.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  7: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">pthread.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  8: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">termios.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr">  9: </span><span style="color: #4078f2; font-weight: bold;">#include</span> <span style="color: #4078f2;">&lt;</span><span style="color: #50a14f;">unistd.h</span><span style="color: #4078f2;">&gt;</span>
<span class="linenr"> 10: </span>
<span class="linenr"> 11: </span><span style="color: #986801;">Gui</span> <span style="color: #a626a4;">gui_init</span><span style="color: #4078f2;">()</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 12: </span>    <span style="color: #986801;">Gui</span> <span style="color: #6a1868;">wins</span>;
<span class="linenr"> 13: </span><span style="color: #4078f2; font-weight: bold;">    #define</span> <span style="color: #6a1868;">CMD_WIN_HEIGHT</span> <span style="color: #da8548; font-weight: bold;">3</span>
<span class="linenr"> 14: </span>
<span class="linenr"> 15: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">set terminal settings</span>
<span class="linenr"> 16: </span>    initscr<span style="color: #a626a4;">()</span>;
<span class="linenr"> 17: </span>    raw<span style="color: #a626a4;">()</span>;
<span class="linenr"> 18: </span>    refresh<span style="color: #a626a4;">()</span>;
<span class="linenr"> 19: </span>
<span class="linenr"> 20: </span>    <span style="color: #986801;">int</span> <span style="color: #6a1868;">xpos</span>, <span style="color: #6a1868;">ypos</span>, <span style="color: #6a1868;">width</span>, <span style="color: #6a1868;">height</span>;
<span class="linenr"> 21: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">place cmd window at bottom of screen</span>
<span class="linenr"> 22: </span>    height = <span style="color: #b751b6;">CMD_WIN_HEIGHT</span>;
<span class="linenr"> 23: </span>    width = <span style="color: #b751b6;">COLS</span>;
<span class="linenr"> 24: </span>    ypos = <span style="color: #a626a4;">(</span><span style="color: #b751b6;">LINES</span> - height<span style="color: #a626a4;">)</span>;
<span class="linenr"> 25: </span>    xpos = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr"> 26: </span>
<span class="linenr"> 27: </span>    wins.cmd = newwin<span style="color: #a626a4;">(</span>height, width, ypos, xpos<span style="color: #a626a4;">)</span>;
<span class="linenr"> 28: </span>    box<span style="color: #a626a4;">(</span>wins.cmd, <span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 29: </span>    mvwprintw<span style="color: #a626a4;">(</span>wins.cmd, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #50a14f;">"[Command Input]"</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 30: </span>    mvwprintw<span style="color: #a626a4;">(</span>wins.cmd, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #b751b6;">COMMAND_PROMPT</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 31: </span>
<span class="linenr"> 32: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">place help at top-left, taking half the screen</span>
<span class="linenr"> 33: </span>    height = <span style="color: #b751b6;">LINES</span> - <span style="color: #b751b6;">CMD_WIN_HEIGHT</span>;
<span class="linenr"> 34: </span>    width = <span style="color: #b751b6;">COLS</span> / <span style="color: #da8548; font-weight: bold;">2</span>;
<span class="linenr"> 35: </span>    ypos = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr"> 36: </span>    xpos = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr"> 37: </span>
<span class="linenr"> 38: </span>    wins.help_master = newwin<span style="color: #a626a4;">(</span>height, width, ypos, xpos<span style="color: #a626a4;">)</span>;
<span class="linenr"> 39: </span>    wins.help = newwin<span style="color: #a626a4;">(</span>height-<span style="color: #da8548; font-weight: bold;">2</span>, width-<span style="color: #da8548; font-weight: bold;">2</span>, ypos+<span style="color: #da8548; font-weight: bold;">1</span>, xpos+<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 40: </span>    help_set_title<span style="color: #a626a4;">(</span>&amp;wins, <span style="color: #50a14f;">"Default"</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 41: </span>
<span class="linenr"> 42: </span>
<span class="linenr"> 43: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">place status at top-right, taking half the screen</span>
<span class="linenr"> 44: </span>    height = <span style="color: #b751b6;">LINES</span> - <span style="color: #b751b6;">CMD_WIN_HEIGHT</span>;
<span class="linenr"> 45: </span>    width = <span style="color: #b751b6;">COLS</span> / <span style="color: #da8548; font-weight: bold;">2</span>;
<span class="linenr"> 46: </span>    ypos = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr"> 47: </span>    xpos = <span style="color: #b751b6;">COLS</span> / <span style="color: #da8548; font-weight: bold;">2</span>;
<span class="linenr"> 48: </span>
<span class="linenr"> 49: </span>    wins.status_master = newwin<span style="color: #a626a4;">(</span>height, width, ypos, xpos<span style="color: #a626a4;">)</span>;
<span class="linenr"> 50: </span>    wins.status = newwin<span style="color: #a626a4;">(</span>height-<span style="color: #da8548; font-weight: bold;">2</span>, width-<span style="color: #da8548; font-weight: bold;">2</span>, ypos+<span style="color: #da8548; font-weight: bold;">1</span>, xpos+<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 51: </span>    status_set_title<span style="color: #a626a4;">(</span>&amp;wins, <span style="color: #50a14f;">"Default"</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 52: </span>
<span class="linenr"> 53: </span>
<span class="linenr"> 54: </span>    wrefresh<span style="color: #a626a4;">(</span>wins.cmd<span style="color: #a626a4;">)</span>;
<span class="linenr"> 55: </span>    wrefresh<span style="color: #a626a4;">(</span>wins.help_master<span style="color: #a626a4;">)</span>;
<span class="linenr"> 56: </span>    wrefresh<span style="color: #a626a4;">(</span>wins.help<span style="color: #a626a4;">)</span>;
<span class="linenr"> 57: </span>    wrefresh<span style="color: #a626a4;">(</span>wins.status_master<span style="color: #a626a4;">)</span>;
<span class="linenr"> 58: </span>    wrefresh<span style="color: #a626a4;">(</span>wins.status<span style="color: #a626a4;">)</span>;
<span class="linenr"> 59: </span>
<span class="linenr"> 60: </span>    <span style="color: #e45649;">return</span> wins;
<span class="linenr"> 61: </span><span style="color: #4078f2;">}</span>
<span class="linenr"> 62: </span>
<span class="linenr"> 63: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">gui_del</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Gui</span>* <span style="color: #6a1868;">gui</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 64: </span>    delwin<span style="color: #a626a4;">(</span>gui-&gt;cmd<span style="color: #a626a4;">)</span>;
<span class="linenr"> 65: </span>    delwin<span style="color: #a626a4;">(</span>gui-&gt;status<span style="color: #a626a4;">)</span>;
<span class="linenr"> 66: </span>    delwin<span style="color: #a626a4;">(</span>gui-&gt;help<span style="color: #a626a4;">)</span>;
<span class="linenr"> 67: </span>
<span class="linenr"> 68: </span>    clear<span style="color: #a626a4;">()</span>;
<span class="linenr"> 69: </span>    refresh<span style="color: #a626a4;">()</span>;
<span class="linenr"> 70: </span>
<span class="linenr"> 71: </span>    endwin<span style="color: #a626a4;">()</span>;
<span class="linenr"> 72: </span><span style="color: #4078f2;">}</span>
<span class="linenr"> 73: </span>
<span class="linenr"> 74: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">window_title_helper</span><span style="color: #4078f2;">(</span><span style="color: #986801;">WINDOW</span>* <span style="color: #6a1868;">win</span>, <span style="color: #986801;">char</span>* <span style="color: #6a1868;">winname</span>, <span style="color: #986801;">char</span>* <span style="color: #6a1868;">title</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 75: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">redraw the border.</span>
<span class="linenr"> 76: </span>    box<span style="color: #a626a4;">(</span>win, <span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 77: </span>
<span class="linenr"> 78: </span>    mvwprintw<span style="color: #a626a4;">(</span>win, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #50a14f;">"["</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 79: </span>
<span class="linenr"> 80: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">make the window name bold</span>
<span class="linenr"> 81: </span>    wattron<span style="color: #a626a4;">(</span>win, <span style="color: #b751b6;">A_BOLD</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 82: </span>    mvwprintw<span style="color: #a626a4;">(</span>win, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">3</span>, <span style="color: #50a14f;">"%s"</span>, winname<span style="color: #a626a4;">)</span>;
<span class="linenr"> 83: </span>    wattroff<span style="color: #a626a4;">(</span>win, <span style="color: #b751b6;">A_BOLD</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 84: </span>
<span class="linenr"> 85: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">print the custom name. it shouldn't be bold.</span>
<span class="linenr"> 86: </span>    mvwprintw<span style="color: #a626a4;">(</span>win, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">3</span>+strlen<span style="color: #50a14f;">(</span>winname<span style="color: #50a14f;">)</span>, <span style="color: #50a14f;">": %s]"</span>, title<span style="color: #a626a4;">)</span>;
<span class="linenr"> 87: </span><span style="color: #4078f2;">}</span>
<span class="linenr"> 88: </span>
<span class="linenr"> 89: </span><span style="color: #986801;">char</span> <span style="color: #a626a4;">get_input</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Gui</span>* <span style="color: #6a1868;">wins</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 90: </span>    mvwprintw<span style="color: #a626a4;">(</span>wins-&gt;cmd, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #b751b6;">COMMAND_PROMPT</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 91: </span>    wrefresh<span style="color: #a626a4;">(</span>wins-&gt;cmd<span style="color: #a626a4;">)</span>;
<span class="linenr"> 92: </span>    <span style="color: #986801;">char</span> <span style="color: #6a1868;">c</span> = mvwgetch<span style="color: #a626a4;">(</span>wins-&gt;cmd, <span style="color: #da8548; font-weight: bold;">1</span>, strlen<span style="color: #50a14f;">(</span><span style="color: #b751b6;">COMMAND_PROMPT</span><span style="color: #50a14f;">)</span> + <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a626a4;">)</span>;
<span class="linenr"> 93: </span>    wrefresh<span style="color: #a626a4;">(</span>wins-&gt;cmd<span style="color: #a626a4;">)</span>;
<span class="linenr"> 94: </span>    <span style="color: #e45649;">return</span> c;
<span class="linenr"> 95: </span><span style="color: #4078f2;">}</span>
<span class="linenr"> 96: </span>
<span class="linenr"> 97: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">status_set_title</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Gui</span>* <span style="color: #6a1868;">wins</span>, <span style="color: #986801;">char</span> *<span style="color: #6a1868;">title</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr"> 98: </span>    window_title_helper<span style="color: #a626a4;">(</span>wins-&gt;status_master, <span style="color: #50a14f;">"Status"</span>, title<span style="color: #a626a4;">)</span>;
<span class="linenr"> 99: </span>    wins-&gt;status_title = title;
<span class="linenr">100: </span>
<span class="linenr">101: </span>    wrefresh<span style="color: #a626a4;">(</span>wins-&gt;status_master<span style="color: #a626a4;">)</span>;
<span class="linenr">102: </span><span style="color: #4078f2;">}</span>
<span class="linenr">103: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">status_clear</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Gui</span>* <span style="color: #6a1868;">wins</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr">104: </span>    wclear<span style="color: #a626a4;">(</span>wins-&gt;status<span style="color: #a626a4;">)</span>;
<span class="linenr">105: </span>
<span class="linenr">106: </span>    wrefresh<span style="color: #a626a4;">(</span>wins-&gt;status<span style="color: #a626a4;">)</span>;
<span class="linenr">107: </span>
<span class="linenr">108: </span>    wins-&gt;status_x = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">109: </span>    wins-&gt;status_y = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">110: </span><span style="color: #4078f2;">}</span>
<span class="linenr">111: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">help_set_title</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Gui</span>* <span style="color: #6a1868;">wins</span>, <span style="color: #986801;">char</span>* <span style="color: #6a1868;">title</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr">112: </span>    window_title_helper<span style="color: #a626a4;">(</span>wins-&gt;help_master, <span style="color: #50a14f;">"Help"</span>, title<span style="color: #a626a4;">)</span>;
<span class="linenr">113: </span>    wins-&gt;help_title = title;
<span class="linenr">114: </span>
<span class="linenr">115: </span>    wrefresh<span style="color: #a626a4;">(</span>wins-&gt;help_master<span style="color: #a626a4;">)</span>;
<span class="linenr">116: </span><span style="color: #4078f2;">}</span>
<span class="linenr">117: </span>
<span class="linenr">118: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">help_clear</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Gui</span>* <span style="color: #6a1868;">wins</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr">119: </span>    wclear<span style="color: #a626a4;">(</span>wins-&gt;help<span style="color: #a626a4;">)</span>;
<span class="linenr">120: </span>    wrefresh<span style="color: #a626a4;">(</span>wins-&gt;help<span style="color: #a626a4;">)</span>;
<span class="linenr">121: </span>
<span class="linenr">122: </span>    wins-&gt;help_x = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">123: </span>    wins-&gt;help_y = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">124: </span><span style="color: #4078f2;">}</span>
<span class="linenr">125: </span>
<span class="linenr">126: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">wprintw_file</span><span style="color: #4078f2;">(</span><span style="color: #986801;">WINDOW</span>* <span style="color: #6a1868;">win</span>, <span style="color: #986801;">char</span>* <span style="color: #6a1868;">filename</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr">127: </span>    <span style="color: #986801;">FILE</span>* <span style="color: #6a1868;">file</span> = fopen<span style="color: #a626a4;">(</span>filename, <span style="color: #50a14f;">"r"</span><span style="color: #a626a4;">)</span>;
<span class="linenr">128: </span>
<span class="linenr">129: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">attempt to open file, print error if fail</span>
<span class="linenr">130: </span>    <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span>file == <span style="color: #b751b6;">NULL</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr">131: </span>        wprintw<span style="color: #50a14f;">(</span>win, <span style="color: #50a14f;">"No help file found at: \"%s\""</span>, filename<span style="color: #50a14f;">)</span>;
<span class="linenr">132: </span>        <span style="color: #e45649;">return</span>;
<span class="linenr">133: </span>    <span style="color: #a626a4;">}</span>
<span class="linenr">134: </span>
<span class="linenr">135: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">read the help text file</span>
<span class="linenr">136: </span>    <span style="color: #986801;">char</span> <span style="color: #6a1868;">buf</span><span style="color: #a626a4;">[</span><span style="color: #da8548; font-weight: bold;">513</span><span style="color: #a626a4;">]</span> = <span style="color: #a626a4;">{</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a626a4;">}</span>;
<span class="linenr">137: </span>    <span style="color: #986801;">int</span> <span style="color: #6a1868;">bytes_read</span>;
<span class="linenr">138: </span>    <span style="color: #e45649;">while</span> <span style="color: #a626a4;">(</span><span style="color: #50a14f;">(</span>bytes_read = fread<span style="color: #b751b6;">(</span>buf, <span style="color: #e45649;">sizeof</span><span style="color: #4078f2;">(</span><span style="color: #986801;">char</span><span style="color: #4078f2;">)</span>, <span style="color: #da8548; font-weight: bold;">512</span>, file<span style="color: #b751b6;">)</span><span style="color: #50a14f;">)</span> != <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr">139: </span>        <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">null terminate the position after the last byte.</span>
<span class="linenr">140: </span>        buf<span style="color: #50a14f;">[</span>bytes_read<span style="color: #50a14f;">]</span> = <span style="color: #50a14f;">'\0'</span>;
<span class="linenr">141: </span>        wprintw<span style="color: #50a14f;">(</span>win, <span style="color: #50a14f;">"%s"</span>, buf<span style="color: #50a14f;">)</span>;
<span class="linenr">142: </span>    <span style="color: #a626a4;">}</span>
<span class="linenr">143: </span>
<span class="linenr">144: </span>    fclose<span style="color: #a626a4;">(</span>file<span style="color: #a626a4;">)</span>;
<span class="linenr">145: </span><span style="color: #4078f2;">}</span>
<span class="linenr">146: </span>
<span class="linenr">147: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">neat function to package and send a GUI command</span>
<span class="linenr">148: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">gui_command</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Producer</span>* <span style="color: #6a1868;">gui_cmd</span>, <span style="color: #e45649;">enum</span> <span style="color: #986801;">GuiControl</span> <span style="color: #6a1868;">ctrl</span>, <span style="color: #986801;">char</span>* <span style="color: #6a1868;">data</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr">149: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">if the ringbuf is full, wait until it isn't</span>
<span class="linenr">150: </span>    <span style="color: #e45649;">while</span> <span style="color: #a626a4;">(</span>producer_push<span style="color: #50a14f;">(</span>gui_cmd, &amp;<span style="color: #b751b6;">(</span>GuiCommand<span style="color: #b751b6;">){</span>ctrl, data<span style="color: #b751b6;">}</span><span style="color: #50a14f;">)</span> == -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a626a4;">)</span>;
<span class="linenr">151: </span><span style="color: #4078f2;">}</span>
<span class="linenr">152: </span>
<span class="linenr">153: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">neat function to package and send a GUI command, however, this function will</span>
<span class="linenr">154: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">copy the data in the data string instead of passing a pointer.</span>
<span class="linenr">155: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">gui_print_cmd</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Producer</span>* <span style="color: #6a1868;">gui_cmd</span>, <span style="color: #e45649;">enum</span> <span style="color: #986801;">GuiControl</span> <span style="color: #6a1868;">ctrl</span>, <span style="color: #986801;">char</span>* <span style="color: #6a1868;">data</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr">156: </span>    <span style="color: #e45649;">while</span> <span style="color: #a626a4;">(</span>producer_push<span style="color: #50a14f;">(</span>gui_cmd, &amp;<span style="color: #b751b6;">(</span>GuiCommand<span style="color: #b751b6;">){</span>ctrl, <span style="color: #b751b6;">NULL</span><span style="color: #b751b6;">}</span><span style="color: #50a14f;">)</span> == -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a626a4;">)</span>;
<span class="linenr">157: </span>
<span class="linenr">158: </span>    <span style="color: #e45649;">while</span> <span style="color: #a626a4;">(</span>*data != <span style="color: #50a14f;">'\0'</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr">159: </span>        <span style="color: #986801;">GuiCommand</span> <span style="color: #6a1868;">cmd</span>;
<span class="linenr">160: </span>        cmd.cmd = <span style="color: #b751b6;">DATA</span>;
<span class="linenr">161: </span>        cmd.c = *<span style="color: #50a14f;">(</span>data++<span style="color: #50a14f;">)</span>; <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">assign and increment</span>
<span class="linenr">162: </span>
<span class="linenr">163: </span>        <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">if the ringbuf is full, wait until it isn't.</span>
<span class="linenr">164: </span>        <span style="color: #e45649;">while</span> <span style="color: #50a14f;">(</span>producer_push<span style="color: #b751b6;">(</span>gui_cmd, &amp;cmd<span style="color: #b751b6;">)</span> == -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #50a14f;">)</span>;
<span class="linenr">165: </span>    <span style="color: #a626a4;">}</span>
<span class="linenr">166: </span><span style="color: #4078f2;">}</span>
<span class="linenr">167: </span>
<span class="linenr">168: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">get_string_helper</span><span style="color: #4078f2;">(</span><span style="color: #986801;">Consumer</span>* <span style="color: #6a1868;">command_rb</span>, <span style="color: #986801;">void</span> <span style="color: #a626a4;">(</span>*<span style="color: #a626a4;">print</span><span style="color: #a626a4;">)(</span><span style="color: #986801;">char</span>*<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr">169: </span>    <span style="color: #986801;">char</span> <span style="color: #6a1868;">data</span><span style="color: #a626a4;">[</span><span style="color: #da8548; font-weight: bold;">512</span><span style="color: #a626a4;">]</span> = <span style="color: #a626a4;">{}</span>;
<span class="linenr">170: </span>    <span style="color: #986801;">char</span>* <span style="color: #6a1868;">data_p</span> = data;
<span class="linenr">171: </span>    <span style="color: #986801;">GuiCommand</span>* <span style="color: #6a1868;">cmd</span>;
<span class="linenr">172: </span>    <span style="color: #e45649;">while</span> <span style="color: #a626a4;">(</span><span style="color: #b751b6;">true</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr">173: </span>        cmd = consumer_peek<span style="color: #50a14f;">(</span>command_rb<span style="color: #50a14f;">)</span>;
<span class="linenr">174: </span>
<span class="linenr">175: </span>        <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">keep checking for more data</span>
<span class="linenr">176: </span>        <span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>cmd == <span style="color: #b751b6;">NULL</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">{</span>
<span class="linenr">177: </span>            <span style="color: #e45649;">continue</span>;
<span class="linenr">178: </span>        <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">if the next command isn't data, end the loop.</span>
<span class="linenr">179: </span>        <span style="color: #50a14f;">}</span> <span style="color: #e45649;">else</span> <span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>cmd-&gt;cmd != <span style="color: #b751b6;">DATA</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">{</span>
<span class="linenr">180: </span>            <span style="color: #e45649;">break</span>;
<span class="linenr">181: </span>        <span style="color: #50a14f;">}</span>
<span class="linenr">182: </span>
<span class="linenr">183: </span>        consumer_pop<span style="color: #50a14f;">(</span>command_rb<span style="color: #50a14f;">)</span>;
<span class="linenr">184: </span>
<span class="linenr">185: </span>        <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">set and increment the data</span>
<span class="linenr">186: </span>        *<span style="color: #50a14f;">(</span>data_p++<span style="color: #50a14f;">)</span> = cmd-&gt;c;
<span class="linenr">187: </span>
<span class="linenr">188: </span>        <span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>data_p &gt;= data+<span style="color: #da8548; font-weight: bold;">511</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">{</span>
<span class="linenr">189: </span>            *data_p = <span style="color: #50a14f;">'\0'</span>; <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">ensure string is null-terminated</span>
<span class="linenr">190: </span>            <span style="color: #b751b6;">(</span>*print<span style="color: #b751b6;">)(</span>data<span style="color: #b751b6;">)</span>; <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">print the string using the provided function</span>
<span class="linenr">191: </span>            data_p = data; <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">reset the pointer</span>
<span class="linenr">192: </span>        <span style="color: #50a14f;">}</span>
<span class="linenr">193: </span>    <span style="color: #a626a4;">}</span>
<span class="linenr">194: </span>
<span class="linenr">195: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">print the remaining data in the the buffer</span>
<span class="linenr">196: </span>    *data_p = <span style="color: #50a14f;">'\0'</span>; <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">ensure the string is null-terminated</span>
<span class="linenr">197: </span>    <span style="color: #a626a4;">(</span>*print<span style="color: #a626a4;">)(</span>data<span style="color: #a626a4;">)</span>; <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">print the string using the provided function</span>
<span class="linenr">198: </span>
<span class="linenr">199: </span>    <span style="color: #e45649;">return</span>;
<span class="linenr">200: </span><span style="color: #4078f2;">}</span>
<span class="linenr">201: </span>
<span class="linenr">202: </span><span style="color: #986801;">void</span> <span style="color: #a626a4;">gui_thread</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">GuiThreadParams</span>* <span style="color: #6a1868;">params</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr">203: </span>    <span style="color: #986801;">Producer</span>* <span style="color: #6a1868;">input_rb</span> = params-&gt;input_rb;
<span class="linenr">204: </span>    <span style="color: #986801;">Consumer</span>* <span style="color: #6a1868;">command_rb</span> = params-&gt;command_rb;
<span class="linenr">205: </span>
<span class="linenr">206: </span>    <span style="color: #986801;">Gui</span> <span style="color: #6a1868;">gui</span> = gui_init<span style="color: #a626a4;">()</span>;
<span class="linenr">207: </span>    nodelay<span style="color: #a626a4;">(</span>gui.cmd, <span style="color: #b751b6;">true</span><span style="color: #a626a4;">)</span>;
<span class="linenr">208: </span>
<span class="linenr">209: </span>    <span style="color: #986801;">FILE</span>* <span style="color: #6a1868;">elog</span> = fopen<span style="color: #a626a4;">(</span><span style="color: #50a14f;">"gui_error_log.txt"</span>, <span style="color: #50a14f;">"w"</span><span style="color: #a626a4;">)</span>;
<span class="linenr">210: </span>
<span class="linenr">211: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">get the total elapsed time from the monotonic epoch (arbitrary)</span>
<span class="linenr">212: </span>    <span style="color: #e45649;">struct</span> <span style="color: #986801;">timespec</span> <span style="color: #6a1868;">elapsed_time</span>;
<span class="linenr">213: </span>    clock_gettime<span style="color: #a626a4;">(</span><span style="color: #b751b6;">CLOCK_MONOTONIC</span>, &amp;elapsed_time<span style="color: #a626a4;">)</span>;
<span class="linenr">214: </span>
<span class="linenr">215: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">ms precision</span>
<span class="linenr">216: </span>    <span style="color: #986801;">long</span> <span style="color: #6a1868;">last_refresh</span> = elapsed_time.tv_sec*<span style="color: #da8548; font-weight: bold;">1000</span> + elapsed_time.tv_nsec / <span style="color: #da8548; font-weight: bold;">1000000</span>;
<span class="linenr">217: </span>
<span class="linenr">218: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">this limits the amount of times a refresh can be conducted per second.</span>
<span class="linenr">219: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">there are 5 windows, each window has a field.</span>
<span class="linenr">220: </span>    <span style="color: #986801;">bool</span> <span style="color: #6a1868;">refresh_scheduled</span><span style="color: #a626a4;">[</span><span style="color: #da8548; font-weight: bold;">5</span><span style="color: #a626a4;">]</span> = <span style="color: #a626a4;">{</span><span style="color: #b751b6;">false</span><span style="color: #a626a4;">}</span>;
<span class="linenr">221: </span>    <span style="color: #986801;">bool</span> <span style="color: #6a1868;">exit</span> = <span style="color: #b751b6;">false</span>;
<span class="linenr">222: </span>    <span style="color: #986801;">bool</span> <span style="color: #6a1868;">term_mode</span> = <span style="color: #b751b6;">false</span>;
<span class="linenr">223: </span>    <span style="color: #e45649;">while</span> <span style="color: #a626a4;">(</span><span style="color: #4078f2; font-weight: bold;">!</span>exit<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr">224: </span>        <span style="color: #e45649;">struct</span> <span style="color: #986801;">GuiCommand</span>* <span style="color: #6a1868;">cmd</span> = consumer_pop<span style="color: #50a14f;">(</span>command_rb<span style="color: #50a14f;">)</span>;
<span class="linenr">225: </span>
<span class="linenr">226: </span>        <span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>cmd != <span style="color: #b751b6;">NULL</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">{</span>
<span class="linenr">227: </span>            <span style="color: #986801;">bool</span> <span style="color: #6a1868;">throw_cmd</span> = term_mode &amp;&amp; <span style="color: #b751b6;">(</span>cmd-&gt;cmd == <span style="color: #b751b6;">REFRESH</span>
<span class="linenr">228: </span>                                           || cmd-&gt;cmd == <span style="color: #b751b6;">PRINT_HELP</span>
<span class="linenr">229: </span>                                           || cmd-&gt;cmd == <span style="color: #b751b6;">PRINT_FILE_HELP</span>
<span class="linenr">230: </span>                                           || cmd-&gt;cmd == <span style="color: #b751b6;">PRINT_STATUS</span>
<span class="linenr">231: </span>                                           || cmd-&gt;cmd == <span style="color: #b751b6;">SET_TITLE_HELP</span>
<span class="linenr">232: </span>                                           || cmd-&gt;cmd == <span style="color: #b751b6;">SET_TITLE_STATUS</span>
<span class="linenr">233: </span>                                           || cmd-&gt;cmd == <span style="color: #b751b6;">CLEAR_HELP</span>
<span class="linenr">234: </span>                                           || cmd-&gt;cmd == <span style="color: #b751b6;">CLEAR_STATUS</span>
<span class="linenr">235: </span>                                           || cmd-&gt;cmd == <span style="color: #b751b6;">REFRESH</span>
<span class="linenr">236: </span>                                           || cmd-&gt;cmd == <span style="color: #b751b6;">CMD_ECHO_ON</span>
<span class="linenr">237: </span>                                           || cmd-&gt;cmd == <span style="color: #b751b6;">CMD_ECHO_OFF</span><span style="color: #b751b6;">)</span>;
<span class="linenr">238: </span>
<span class="linenr">239: </span>            <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">if any of the above commands are recieved in terminal mode,</span>
<span class="linenr">240: </span>            <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">the command must be thrown out, because they are attempting to</span>
<span class="linenr">241: </span>            <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">modify a context which doesn't exist.</span>
<span class="linenr">242: </span>            <span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span>throw_cmd<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">{</span>
<span class="linenr">243: </span>                <span style="color: #e45649;">continue</span>;
<span class="linenr">244: </span>            <span style="color: #b751b6;">}</span>
<span class="linenr">245: </span>
<span class="linenr">246: </span>            <span style="color: #e45649;">switch</span> <span style="color: #b751b6;">(</span>cmd-&gt;cmd<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">{</span>
<span class="linenr">247: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">PRINT_HELP</span> :
<span class="linenr">248: </span>            <span style="color: #4078f2;">{</span>
<span class="linenr">249: </span>                <span style="color: #986801;">void</span> <span style="color: #a626a4;">print</span> <span style="color: #a626a4;">(</span><span style="color: #986801;">char</span>* <span style="color: #6a1868;">data</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr">250: </span>                    mvwprintw<span style="color: #50a14f;">(</span>gui.help, gui.help_y, gui.help_x, <span style="color: #50a14f;">"%s"</span>, data<span style="color: #50a14f;">)</span>;
<span class="linenr">251: </span>                <span style="color: #a626a4;">}</span>
<span class="linenr">252: </span>
<span class="linenr">253: </span>                <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span>cmd-&gt;data == <span style="color: #b751b6;">NULL</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr">254: </span>                    get_string_helper<span style="color: #50a14f;">(</span>command_rb, &amp;print<span style="color: #50a14f;">)</span>;
<span class="linenr">255: </span>                <span style="color: #a626a4;">}</span> <span style="color: #e45649;">else</span> <span style="color: #a626a4;">{</span>
<span class="linenr">256: </span>                    mvwprintw<span style="color: #50a14f;">(</span>gui.help, gui.help_y, gui.help_x, <span style="color: #50a14f;">"%s"</span>, cmd-&gt;data<span style="color: #50a14f;">)</span>;
<span class="linenr">257: </span>                <span style="color: #a626a4;">}</span>
<span class="linenr">258: </span>
<span class="linenr">259: </span>                getyx<span style="color: #a626a4;">(</span>gui.help, gui.help_y, gui.help_x<span style="color: #a626a4;">)</span>;
<span class="linenr">260: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">261: </span>            <span style="color: #4078f2;">}</span>
<span class="linenr">262: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">PRINT_FILE_HELP</span> :
<span class="linenr">263: </span>                wprintw_file<span style="color: #4078f2;">(</span>gui.help, cmd-&gt;data<span style="color: #4078f2;">)</span>;
<span class="linenr">264: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">265: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">PRINT_STATUS</span> :
<span class="linenr">266: </span>            <span style="color: #4078f2;">{</span>
<span class="linenr">267: </span>                <span style="color: #986801;">void</span> <span style="color: #a626a4;">print</span> <span style="color: #a626a4;">(</span><span style="color: #986801;">char</span>* <span style="color: #6a1868;">data</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr">268: </span>                    mvwprintw<span style="color: #50a14f;">(</span>gui.status, gui.status_y, gui.status_x, <span style="color: #50a14f;">"%s"</span>, data<span style="color: #50a14f;">)</span>;
<span class="linenr">269: </span>                <span style="color: #a626a4;">}</span>
<span class="linenr">270: </span>
<span class="linenr">271: </span>                <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span>cmd-&gt;data == <span style="color: #b751b6;">NULL</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr">272: </span>                    get_string_helper<span style="color: #50a14f;">(</span>command_rb, &amp;print<span style="color: #50a14f;">)</span>;
<span class="linenr">273: </span>                <span style="color: #a626a4;">}</span> <span style="color: #e45649;">else</span> <span style="color: #a626a4;">{</span>
<span class="linenr">274: </span>                    mvwprintw<span style="color: #50a14f;">(</span>gui.status, gui.status_y, gui.status_x, <span style="color: #50a14f;">"%s"</span>, cmd-&gt;data<span style="color: #50a14f;">)</span>;
<span class="linenr">275: </span>                <span style="color: #a626a4;">}</span>
<span class="linenr">276: </span>
<span class="linenr">277: </span>                <span style="color: #9ca0a4;">//</span><span style="color: #9ca0a4;">fprintf(elog, "printing to status...\n");</span>
<span class="linenr">278: </span>
<span class="linenr">279: </span>                getyx<span style="color: #a626a4;">(</span>gui.status, gui.status_y, gui.status_x<span style="color: #a626a4;">)</span>;
<span class="linenr">280: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">281: </span>            <span style="color: #4078f2;">}</span>
<span class="linenr">282: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">TERMINAL_ENTER</span>:
<span class="linenr">283: </span>            <span style="color: #4078f2;">{</span>
<span class="linenr">284: </span>                <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">stop the fancy GUI, and</span>
<span class="linenr">285: </span>                gui_del<span style="color: #a626a4;">(</span>&amp;gui<span style="color: #a626a4;">)</span>;
<span class="linenr">286: </span>                term_mode = <span style="color: #b751b6;">true</span>;
<span class="linenr">287: </span>
<span class="linenr">288: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">289: </span>            <span style="color: #4078f2;">}</span>
<span class="linenr">290: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">TERMINAL_PRINT</span> :
<span class="linenr">291: </span>            <span style="color: #4078f2;">{</span>
<span class="linenr">292: </span>                <span style="color: #986801;">void</span> <span style="color: #a626a4;">print</span> <span style="color: #a626a4;">(</span><span style="color: #986801;">char</span>* <span style="color: #6a1868;">data</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr">293: </span>                    fprintf<span style="color: #50a14f;">(</span>stdout, <span style="color: #50a14f;">"%s"</span>, data<span style="color: #50a14f;">)</span>;
<span class="linenr">294: </span>                <span style="color: #a626a4;">}</span>
<span class="linenr">295: </span>
<span class="linenr">296: </span>                <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span>cmd-&gt;data == <span style="color: #b751b6;">NULL</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr">297: </span>                    get_string_helper<span style="color: #50a14f;">(</span>command_rb, &amp;print<span style="color: #50a14f;">)</span>;
<span class="linenr">298: </span>                <span style="color: #a626a4;">}</span> <span style="color: #e45649;">else</span> <span style="color: #a626a4;">{</span>
<span class="linenr">299: </span>                    printf<span style="color: #50a14f;">(</span><span style="color: #50a14f;">"%s"</span>, cmd-&gt;data<span style="color: #50a14f;">)</span>;
<span class="linenr">300: </span>                <span style="color: #a626a4;">}</span>
<span class="linenr">301: </span>
<span class="linenr">302: </span>                fflush<span style="color: #a626a4;">(</span>stdout<span style="color: #a626a4;">)</span>;
<span class="linenr">303: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">304: </span>            <span style="color: #4078f2;">}</span>
<span class="linenr">305: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">TERMINAL_RETURN</span> :
<span class="linenr">306: </span>            <span style="color: #4078f2;">{</span>
<span class="linenr">307: </span>                <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">reinit the GUI, and update the windows in the old structure.</span>
<span class="linenr">308: </span>                <span style="color: #986801;">Gui</span> <span style="color: #6a1868;">new_gui</span> = gui_init<span style="color: #a626a4;">()</span>;
<span class="linenr">309: </span>                nodelay<span style="color: #a626a4;">(</span>gui.cmd, <span style="color: #b751b6;">true</span><span style="color: #a626a4;">)</span>;
<span class="linenr">310: </span>
<span class="linenr">311: </span>                gui.cmd = new_gui.cmd;
<span class="linenr">312: </span>                gui.help = new_gui.help;
<span class="linenr">313: </span>                gui.status = new_gui.status;
<span class="linenr">314: </span>                gui.help_master = new_gui.help_master;
<span class="linenr">315: </span>                gui.help_master = new_gui.help_master;
<span class="linenr">316: </span>
<span class="linenr">317: </span>                help_set_title<span style="color: #a626a4;">(</span>&amp;gui, gui.help_title<span style="color: #a626a4;">)</span>;
<span class="linenr">318: </span>                status_set_title<span style="color: #a626a4;">(</span>&amp;gui, gui.status_title<span style="color: #a626a4;">)</span>;
<span class="linenr">319: </span>
<span class="linenr">320: </span>                term_mode = <span style="color: #b751b6;">false</span>;
<span class="linenr">321: </span>
<span class="linenr">322: </span>                <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">schedule refresh for everything.</span>
<span class="linenr">323: </span>                <span style="color: #e45649;">for</span> <span style="color: #a626a4;">(</span><span style="color: #986801;">int</span> <span style="color: #6a1868;">p</span> = <span style="color: #da8548; font-weight: bold;">0</span>; p &lt; <span style="color: #da8548; font-weight: bold;">5</span>; p++<span style="color: #a626a4;">)</span>
<span class="linenr">324: </span>                    refresh_scheduled<span style="color: #a626a4;">[</span>p<span style="color: #a626a4;">]</span> = <span style="color: #b751b6;">true</span>;
<span class="linenr">325: </span>
<span class="linenr">326: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">327: </span>            <span style="color: #4078f2;">}</span>
<span class="linenr">328: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">SET_TITLE_HELP</span> :
<span class="linenr">329: </span>                help_set_title<span style="color: #4078f2;">(</span>&amp;gui, cmd-&gt;data<span style="color: #4078f2;">)</span>;
<span class="linenr">330: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">331: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">SET_TITLE_STATUS</span> :
<span class="linenr">332: </span>                status_set_title<span style="color: #4078f2;">(</span>&amp;gui, cmd-&gt;data<span style="color: #4078f2;">)</span>;
<span class="linenr">333: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">334: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">CLEAR_STATUS</span> :
<span class="linenr">335: </span>                wclear<span style="color: #4078f2;">(</span>gui.status<span style="color: #4078f2;">)</span>;
<span class="linenr">336: </span>
<span class="linenr">337: </span>                gui.status_y = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">338: </span>                gui.status_x = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">339: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">340: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">CLEAR_HELP</span> :
<span class="linenr">341: </span>                wclear<span style="color: #4078f2;">(</span>gui.help<span style="color: #4078f2;">)</span>;
<span class="linenr">342: </span>
<span class="linenr">343: </span>                gui.help_y = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">344: </span>                gui.help_x = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">345: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">346: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">REFRESH</span> :
<span class="linenr">347: </span>                <span style="color: #e45649;">if</span> <span style="color: #4078f2;">(</span>cmd-&gt;data == <span style="color: #b751b6;">NULL</span> || strlen<span style="color: #a626a4;">(</span>cmd-&gt;data<span style="color: #a626a4;">)</span> == <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr">348: </span>                    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">if the user doesn't provide a string specifier, or</span>
<span class="linenr">349: </span>                    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">if they provide an empty string, refresh all windows.</span>
<span class="linenr">350: </span>                    <span style="color: #e45649;">for</span> <span style="color: #a626a4;">(</span><span style="color: #986801;">int</span> <span style="color: #6a1868;">p</span> = <span style="color: #da8548; font-weight: bold;">0</span>; p &lt; <span style="color: #da8548; font-weight: bold;">5</span>; p++<span style="color: #a626a4;">)</span>
<span class="linenr">351: </span>                        refresh_scheduled<span style="color: #a626a4;">[</span>p<span style="color: #a626a4;">]</span> = <span style="color: #b751b6;">true</span>;
<span class="linenr">352: </span>                <span style="color: #4078f2;">}</span>
<span class="linenr">353: </span>
<span class="linenr">354: </span>                <span style="color: #e45649;">if</span> <span style="color: #4078f2;">(</span>strstr<span style="color: #a626a4;">(</span>cmd-&gt;data, <span style="color: #50a14f;">"s"</span><span style="color: #a626a4;">)</span> != <span style="color: #b751b6;">NULL</span><span style="color: #4078f2;">)</span>
<span class="linenr">355: </span>                    refresh_scheduled<span style="color: #4078f2;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #4078f2;">]</span> = <span style="color: #b751b6;">true</span>;
<span class="linenr">356: </span>
<span class="linenr">357: </span>                <span style="color: #e45649;">if</span> <span style="color: #4078f2;">(</span>strstr<span style="color: #a626a4;">(</span>cmd-&gt;data, <span style="color: #50a14f;">"h"</span><span style="color: #a626a4;">)</span> != <span style="color: #b751b6;">NULL</span><span style="color: #4078f2;">)</span>
<span class="linenr">358: </span>                    refresh_scheduled<span style="color: #4078f2;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #4078f2;">]</span> = <span style="color: #b751b6;">true</span>;
<span class="linenr">359: </span>
<span class="linenr">360: </span>                <span style="color: #e45649;">if</span> <span style="color: #4078f2;">(</span>strstr<span style="color: #a626a4;">(</span>cmd-&gt;data, <span style="color: #50a14f;">"c"</span><span style="color: #a626a4;">)</span> != <span style="color: #b751b6;">NULL</span><span style="color: #4078f2;">)</span>
<span class="linenr">361: </span>                    refresh_scheduled<span style="color: #4078f2;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #4078f2;">]</span> = <span style="color: #b751b6;">true</span>;
<span class="linenr">362: </span>
<span class="linenr">363: </span>                <span style="color: #e45649;">if</span> <span style="color: #4078f2;">(</span>strstr<span style="color: #a626a4;">(</span>cmd-&gt;data, <span style="color: #50a14f;">"S"</span><span style="color: #a626a4;">)</span> != <span style="color: #b751b6;">NULL</span><span style="color: #4078f2;">)</span>
<span class="linenr">364: </span>                    refresh_scheduled<span style="color: #4078f2;">[</span><span style="color: #da8548; font-weight: bold;">3</span><span style="color: #4078f2;">]</span> = <span style="color: #b751b6;">true</span>;
<span class="linenr">365: </span>
<span class="linenr">366: </span>                <span style="color: #e45649;">if</span> <span style="color: #4078f2;">(</span>strstr<span style="color: #a626a4;">(</span>cmd-&gt;data, <span style="color: #50a14f;">"H"</span><span style="color: #a626a4;">)</span> != <span style="color: #b751b6;">NULL</span><span style="color: #4078f2;">)</span>
<span class="linenr">367: </span>                    refresh_scheduled<span style="color: #4078f2;">[</span><span style="color: #da8548; font-weight: bold;">4</span><span style="color: #4078f2;">]</span> = <span style="color: #b751b6;">true</span>;
<span class="linenr">368: </span>
<span class="linenr">369: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">370: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">CMD_ECHO_ON</span> :
<span class="linenr">371: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">372: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">CMD_ECHO_OFF</span> :
<span class="linenr">373: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">374: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">GUI_EXIT</span> :
<span class="linenr">375: </span>                exit = <span style="color: #b751b6;">true</span>;
<span class="linenr">376: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">377: </span>
<span class="linenr">378: </span>            <span style="color: #e45649;">case</span> <span style="color: #b751b6;">DATA</span> :
<span class="linenr">379: </span>                printf<span style="color: #4078f2;">(</span><span style="color: #50a14f;">"\\033[31m%c\\033[0m"</span>, cmd-&gt;c<span style="color: #4078f2;">)</span>;
<span class="linenr">380: </span>                <span style="color: #e45649;">break</span>;
<span class="linenr">381: </span>            <span style="color: #b751b6;">}</span>
<span class="linenr">382: </span>        <span style="color: #50a14f;">}</span>
<span class="linenr">383: </span>
<span class="linenr">384: </span>        <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">we don't need to refresh or anything if we are in term mode, but we do</span>
<span class="linenr">385: </span>        <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">still need to get input.</span>
<span class="linenr">386: </span>        <span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span> term_mode <span style="color: #50a14f;">)</span> <span style="color: #50a14f;">{</span>
<span class="linenr">387: </span>            <span style="color: #986801;">int</span> <span style="color: #6a1868;">c</span> = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">388: </span>
<span class="linenr">389: </span>            <span style="color: #986801;">int</span> <span style="color: #6a1868;">flags</span> = fcntl<span style="color: #b751b6;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #b751b6;">F_GETFL</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #b751b6;">)</span>;
<span class="linenr">390: </span>            fcntl<span style="color: #b751b6;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #b751b6;">F_SETFL</span>, flags | <span style="color: #b751b6;">O_NONBLOCK</span><span style="color: #b751b6;">)</span>;
<span class="linenr">391: </span>
<span class="linenr">392: </span>            <span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span>read<span style="color: #4078f2;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, &amp;c, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #4078f2;">)</span> &lt; <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #b751b6;">)</span>
<span class="linenr">393: </span>                <span style="color: #e45649;">continue</span>;
<span class="linenr">394: </span>
<span class="linenr">395: </span>            producer_push<span style="color: #b751b6;">(</span>input_rb, &amp;c<span style="color: #b751b6;">)</span>;
<span class="linenr">396: </span>            <span style="color: #e45649;">continue</span>;
<span class="linenr">397: </span>        <span style="color: #50a14f;">}</span>
<span class="linenr">398: </span>
<span class="linenr">399: </span>        <span style="color: #e45649;">struct</span> <span style="color: #986801;">timespec</span> <span style="color: #6a1868;">elapsed_time</span>;
<span class="linenr">400: </span>        clock_gettime<span style="color: #50a14f;">(</span><span style="color: #b751b6;">CLOCK_MONOTONIC</span>, &amp;elapsed_time<span style="color: #50a14f;">)</span>;
<span class="linenr">401: </span>        <span style="color: #986801;">long</span> <span style="color: #6a1868;">current_time</span> = elapsed_time.tv_sec*<span style="color: #da8548; font-weight: bold;">1000</span> + elapsed_time.tv_nsec / <span style="color: #da8548; font-weight: bold;">1000000</span>;
<span class="linenr">402: </span>
<span class="linenr">403: </span>        <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">get input and push it into the input buffer</span>
<span class="linenr">404: </span>        <span style="color: #986801;">int</span> <span style="color: #6a1868;">c</span> = mvwgetch<span style="color: #50a14f;">(</span>gui.cmd, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">7</span><span style="color: #50a14f;">)</span>;
<span class="linenr">405: </span>        <span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>c != <span style="color: #b751b6;">ERR</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">{</span>
<span class="linenr">406: </span>            producer_push<span style="color: #b751b6;">(</span>input_rb, &amp;c<span style="color: #b751b6;">)</span>;
<span class="linenr">407: </span>        <span style="color: #50a14f;">}</span>
<span class="linenr">408: </span>
<span class="linenr">409: </span>        <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">dont refresh more often than 4 times per second.</span>
<span class="linenr">410: </span>        <span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>current_time - last_refresh &gt;= <span style="color: #da8548; font-weight: bold;">250</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">{</span>
<span class="linenr">411: </span>            <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">only refresh the windows which were scheduled</span>
<span class="linenr">412: </span>            <span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span>refresh_scheduled<span style="color: #4078f2;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #4078f2;">]</span><span style="color: #b751b6;">)</span>
<span class="linenr">413: </span>                wrefresh<span style="color: #b751b6;">(</span>gui.status<span style="color: #b751b6;">)</span>;
<span class="linenr">414: </span>
<span class="linenr">415: </span>            <span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span>refresh_scheduled<span style="color: #4078f2;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #4078f2;">]</span><span style="color: #b751b6;">)</span>
<span class="linenr">416: </span>                wrefresh<span style="color: #b751b6;">(</span>gui.help<span style="color: #b751b6;">)</span>;
<span class="linenr">417: </span>
<span class="linenr">418: </span>            <span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span>refresh_scheduled<span style="color: #4078f2;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #4078f2;">]</span><span style="color: #b751b6;">)</span>
<span class="linenr">419: </span>                wrefresh<span style="color: #b751b6;">(</span>gui.cmd<span style="color: #b751b6;">)</span>;
<span class="linenr">420: </span>
<span class="linenr">421: </span>            <span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span>refresh_scheduled<span style="color: #4078f2;">[</span><span style="color: #da8548; font-weight: bold;">3</span><span style="color: #4078f2;">]</span><span style="color: #b751b6;">)</span>
<span class="linenr">422: </span>                wrefresh<span style="color: #b751b6;">(</span>gui.status_master<span style="color: #b751b6;">)</span>;
<span class="linenr">423: </span>
<span class="linenr">424: </span>            <span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span>refresh_scheduled<span style="color: #4078f2;">[</span><span style="color: #da8548; font-weight: bold;">4</span><span style="color: #4078f2;">]</span><span style="color: #b751b6;">)</span>
<span class="linenr">425: </span>                wrefresh<span style="color: #b751b6;">(</span>gui.help_master<span style="color: #b751b6;">)</span>;
<span class="linenr">426: </span>
<span class="linenr">427: </span>            last_refresh = current_time;
<span class="linenr">428: </span>
<span class="linenr">429: </span>            <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">reset trackers</span>
<span class="linenr">430: </span>            <span style="color: #e45649;">for</span> <span style="color: #b751b6;">(</span><span style="color: #986801;">int</span> <span style="color: #6a1868;">p</span> = <span style="color: #da8548; font-weight: bold;">0</span>; p &lt; <span style="color: #da8548; font-weight: bold;">5</span>; p++<span style="color: #b751b6;">)</span>
<span class="linenr">431: </span>                refresh_scheduled<span style="color: #b751b6;">[</span>p<span style="color: #b751b6;">]</span> = <span style="color: #b751b6;">false</span>;
<span class="linenr">432: </span>
<span class="linenr">433: </span>        <span style="color: #50a14f;">}</span>
<span class="linenr">434: </span>    <span style="color: #a626a4;">}</span>
<span class="linenr">435: </span>
<span class="linenr">436: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">don't need to delete the GUI if in term mode, since it is already deleted.</span>
<span class="linenr">437: </span>    <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span><span style="color: #4078f2; font-weight: bold;">!</span>term_mode<span style="color: #a626a4;">)</span>
<span class="linenr">438: </span>        gui_del<span style="color: #a626a4;">(</span>&amp;gui<span style="color: #a626a4;">)</span>;
<span class="linenr">439: </span>
<span class="linenr">440: </span>    pthread_exit<span style="color: #a626a4;">(</span><span style="color: #b751b6;">NULL</span><span style="color: #a626a4;">)</span>;
<span class="linenr">441: </span><span style="color: #4078f2;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdae2fc3" class="outline-4">
<h4 id="orgdae2fc3">Manual Driving Mode</h4>
<div class="outline-text-4" id="text-orgdae2fc3">
<p>
One of the first things we designed the car to do was to drive around manually
using keyboard commands. The exact method of achieving this didn&rsquo;t matter, as
long as some form of wireless communication was used. My preferred method was
SSH since it allowed me to control the robot and edit/run the program.
</p>

<p>
I conducted all development over ssh. I would write the code on my desktop (or
laptop sometimes), and then copy it over ssh to my robot. After about a week of
doing this, I decided to write some scripts to help me upload and run the code:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #9ca0a4;">#</span><span style="color: #9ca0a4;">!/usr/bin/</span><span style="color: #e45649;">env</span><span style="color: #9ca0a4;"> sh</span>

<span style="color: #986801;">echo</span> <span style="color: #50a14f;">"tar'ing the directory..."</span>
tar czvf code.tar $<span style="color: #4078f2;">{</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #4078f2;">}</span>/<span style="color: #4078f2;">{</span>Makefile,help_files/*,src/*,include/*<span style="color: #4078f2;">}</span>
<span style="color: #986801;">echo</span> <span style="color: #50a14f;">"scp'ing the tarball..."</span>
scp code.tar pi@192.168.179.151:~/
</pre>
</div>

<p>
I had another script on the raspberry pi that would compile and run the program
for me. This workflow worked well since I could compile and run the code with
only two commands from my computer. My robot would be across the room, and I
could change the code from my desk, drive it to where it needed to be using
manual mode, then start the part of the program I was testing.
</p>
</div>
</div>

<div id="outline-container-org11622d9" class="outline-4">
<h4 id="org11622d9">Line Follow Mode (IR sensor)</h4>
<div class="outline-text-4" id="text-org11622d9">
<p>
The next big thing we worked on was adding a mode that would allow the robot to
follow a line using an IR sensor mounted on the front of the robot. I don&rsquo;t have
any videos from this part of the demonstration, unfortunately.
</p>
</div>
</div>

<div id="outline-container-orgeb94b3a" class="outline-4">
<h4 id="orgeb94b3a">IMU Sensor Balance Board</h4>
<div class="outline-text-4" id="text-orgeb94b3a">
<p>
Our task was to make the robot balance on a clipboard with a pen (or any
otherwise cylindrical object) glued to the bottom. We attached an IMU (Inertial
Measurement Unit) sensor to the robot, which recorded the rotation and
acceleration of the car.
</p>

<p>
Since the data from the sensor was pretty noisy, we had to use filtering to make
it usable. I did a lot of research into this and decided that a <a href="https://vanhunteradams.com/Pico/ReactionWheel/Complementary_Filters.html#:~:text=A%20complementary%20filter%20is%20a,filters%20that%20you%20might%20consider.">complementary
filter</a> would be most suitable for this task. Most students used their IMU data
as the input to a bang-bang controller or some variation of it. I went another
route and used a PID controller, and was the closest to getting the robot to
balance on the board.
</p>

<p>
Even though I think that the task was ultimately impossible, I enjoyed this
assignment because I learned so much about PID controllers. Professor Choi told
me that my robot came the closest to balancing, which was a huge win in my book.
Late one night while I was working on the robot, I did film a video of it trying
and failing (yet coming so close!) to balance.
</p>

<video width="320" height="240" controls>
  <source src="../resources/portfolio/vid1.mp4">
</video>
</div>
</div>

<div id="outline-container-orge540993" class="outline-4">
<h4 id="orge540993">Line Follow Mode (Computer Vision)</h4>
<div class="outline-text-4" id="text-orge540993">
<p>
This final part of the project required us to use computer vision to
</p>
<ol class="org-ol">
<li>Track a laser pointer</li>
<li>Follow a black line on a whiteboard</li>
</ol>

<p>
We used a USB camera and did all the image processing on the CPU. I tried to
optimize my program as much as I could, but this was certainly at the limits of
what can be accomplished with the CPU on the Raspberry Pi. My program was able
to process video at about 10 frames per second.
</p>

<p>
For the laser tracker, after applying a <a href="https://en.wikipedia.org/wiki/Gamma_correction">gamma function</a>, I used a recursive
algorithm to locate the location of the laser pointer. This seemed to work
pretty well, though there were some oscillation issues due to the low frame
rate. The car had trouble putting the laser in the center of the frame in the
forward/backward axis.
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="linenr">35: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">recursive function to find the area of an area whose pixels are brighter</span>
<span class="linenr">36: </span><span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">than thresh.</span>
<span class="linenr">37: </span><span style="color: #986801;">int</span> <span style="color: #a626a4;">find_neighbors</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">image_t</span>* <span style="color: #6a1868;">image</span>, <span style="color: #986801;">uint8_t</span> <span style="color: #6a1868;">thresh</span>, <span style="color: #986801;">int</span> <span style="color: #6a1868;">x</span>, <span style="color: #986801;">int</span> <span style="color: #6a1868;">y</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr">38: </span>    <span style="color: #986801;">uint8_t</span> <span style="color: #6a1868;">c</span> = image-&gt;row<span style="color: #a626a4;">[</span>y<span style="color: #a626a4;">]</span>.column<span style="color: #a626a4;">[</span>x<span style="color: #a626a4;">]</span>.r;
<span class="linenr">39: </span>
<span class="linenr">40: </span>    <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span>c &lt; thresh<span style="color: #a626a4;">)</span>
<span class="linenr">41: </span>        <span style="color: #e45649;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">42: </span>
<span class="linenr">43: </span>    <span style="color: #9ca0a4;">// </span><span style="color: #9ca0a4;">keep future iterations from revisiting this pixel</span>
<span class="linenr">44: </span>    image-&gt;row<span style="color: #a626a4;">[</span>y<span style="color: #a626a4;">]</span>.column<span style="color: #a626a4;">[</span>x<span style="color: #a626a4;">]</span>.r = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">45: </span>    image-&gt;row<span style="color: #a626a4;">[</span>y<span style="color: #a626a4;">]</span>.column<span style="color: #a626a4;">[</span>x<span style="color: #a626a4;">]</span>.g = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">46: </span>    image-&gt;row<span style="color: #a626a4;">[</span>y<span style="color: #a626a4;">]</span>.column<span style="color: #a626a4;">[</span>x<span style="color: #a626a4;">]</span>.b = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">47: </span>
<span class="linenr">48: </span>    <span style="color: #986801;">int</span> <span style="color: #6a1868;">num_neighbors</span> = <span style="color: #da8548; font-weight: bold;">1</span>;
<span class="linenr">49: </span>    <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span>x &gt; <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a626a4;">)</span>
<span class="linenr">50: </span>        num_neighbors += find_neighbors<span style="color: #a626a4;">(</span>image, thresh, x-<span style="color: #da8548; font-weight: bold;">1</span>, y<span style="color: #a626a4;">)</span>;
<span class="linenr">51: </span>
<span class="linenr">52: </span>    <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span>x &lt; <span style="color: #b751b6;">IMAGE_WIDTH</span>-<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a626a4;">)</span>
<span class="linenr">53: </span>        num_neighbors += find_neighbors<span style="color: #a626a4;">(</span>image, thresh, x+<span style="color: #da8548; font-weight: bold;">1</span>, y<span style="color: #a626a4;">)</span>;
<span class="linenr">54: </span>
<span class="linenr">55: </span>    <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span>y &gt; <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a626a4;">)</span>
<span class="linenr">56: </span>        num_neighbors += find_neighbors<span style="color: #a626a4;">(</span>image, thresh, x, y<span style="color: #a626a4;">)</span>;
<span class="linenr">57: </span>
<span class="linenr">58: </span>    <span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span>y &lt; <span style="color: #b751b6;">IMAGE_HEIGHT</span>-<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a626a4;">)</span>
<span class="linenr">59: </span>        num_neighbors += find_neighbors<span style="color: #a626a4;">(</span>image, thresh, x, y+<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a626a4;">)</span>;
<span class="linenr">60: </span>
<span class="linenr">61: </span>    <span style="color: #e45649;">return</span> num_neighbors;
<span class="linenr">62: </span><span style="color: #4078f2;">}</span>
</pre>
</div>

<p>
Since the line had a much larger search area, the recursive algorithm was too
slow. I ended up finding a simple solution. First, average the position of the
pixels along the width of the frame. Then, navigate the robot so that this value
approaches zero while continuing to move forward.
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="linenr">64: </span><span style="color: #986801;">float</span> <span style="color: #a626a4;">avg_position</span><span style="color: #4078f2;">(</span><span style="color: #e45649;">struct</span> <span style="color: #986801;">image_t</span>* <span style="color: #6a1868;">image</span><span style="color: #4078f2;">)</span> <span style="color: #4078f2;">{</span>
<span class="linenr">65: </span>    <span style="color: #986801;">int</span> <span style="color: #6a1868;">accumulator</span> = <span style="color: #da8548; font-weight: bold;">0</span>;
<span class="linenr">66: </span>    <span style="color: #986801;">int</span> <span style="color: #6a1868;">mass</span> = <span style="color: #da8548; font-weight: bold;">1</span>;
<span class="linenr">67: </span>    <span style="color: #e45649;">for</span> <span style="color: #a626a4;">(</span><span style="color: #986801;">int</span> <span style="color: #6a1868;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; <span style="color: #b751b6;">IMAGE_WIDTH</span>; i++<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">{</span>
<span class="linenr">68: </span>        <span style="color: #986801;">int</span> <span style="color: #6a1868;">x</span> = i % <span style="color: #b751b6;">IMAGE_WIDTH</span>;
<span class="linenr">69: </span>        <span style="color: #986801;">int</span> <span style="color: #6a1868;">y</span> = <span style="color: #b751b6;">IMAGE_HEIGHT</span>-<span style="color: #da8548; font-weight: bold;">1</span>;
<span class="linenr">70: </span>
<span class="linenr">71: </span>        <span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>image-&gt;row<span style="color: #b751b6;">[</span>y<span style="color: #b751b6;">]</span>.column<span style="color: #b751b6;">[</span>x<span style="color: #b751b6;">]</span>.r == <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">{</span>
<span class="linenr">72: </span>            accumulator += x;
<span class="linenr">73: </span>            mass += <span style="color: #da8548; font-weight: bold;">1</span>;
<span class="linenr">74: </span>        <span style="color: #50a14f;">}</span>
<span class="linenr">75: </span>    <span style="color: #a626a4;">}</span>
<span class="linenr">76: </span>
<span class="linenr">77: </span>    <span style="color: #986801;">float</span> <span style="color: #6a1868;">average</span> = <span style="color: #a626a4;">(</span><span style="color: #986801;">float</span><span style="color: #a626a4;">)</span>accumulator / mass;
<span class="linenr">78: </span>
<span class="linenr">79: </span>    <span style="color: #e45649;">return</span> <span style="color: #a626a4;">(</span>average/<span style="color: #b751b6;">IMAGE_WIDTH</span><span style="color: #a626a4;">)</span>*<span style="color: #da8548; font-weight: bold;">2</span> - <span style="color: #da8548; font-weight: bold;">1.0</span>;
<span class="linenr">80: </span><span style="color: #4078f2;">}</span>
</pre>
</div>

<p>
Overall, the program ended up working fairly well. I recorded a video of it the
night before the assignment was graded.
</p>

<video width="320" height="240" controls>
  <source src="../resources/portfolio/vid2.mp4">
</video>
</div>
</div>
</div>
</div>

<div id="outline-container-org3cb48c2" class="outline-2">
<h2 id="org3cb48c2">Programming</h2>
<div class="outline-text-2" id="text-org3cb48c2">
<p>
The projects I have listed below, along with others, can be found on my <a href="https://github.com/ethanxxxl">github</a>.
</p>
</div>

<div id="outline-container-orgf35ed52" class="outline-3">
<h3 id="orgf35ed52">Capabilities Overview</h3>
<div class="outline-text-3" id="text-orgf35ed52">
<p>
I currently know the following languages well enough that I would be comfortable
working with them in a professional environment immediately:
</p>

<ul class="org-ul">
<li>C</li>
<li>C++</li>
<li>Rust</li>
<li>Assembly*</li>
<li>Python</li>
<li>Lisp**</li>
</ul>

<p>
*My experience is limited embedded systems (microcontrollers)<br>
**I mostly use Emacs Lisp
</p>

<p>
I am confident I could pick up just about any language relatively quickly, I am
currently in the process of learning haskell, which seems to be the hardest
language I have touched so far. I have used many more languages in the past, but
the ones I have listed I am most confident with.
</p>
</div>
</div>

<div id="outline-container-org2ce4716" class="outline-3">
<h3 id="org2ce4716">Code Wars</h3>
<div class="outline-text-3" id="text-org2ce4716">
<p>
Every once in a while, I like to spend some time working through programming
challenges on the codewars website. I think that it is a great way to hone
programming skills, and pick up new languages.
</p>

<img src="https://www.codewars.com/users/ethanxxxl/badges/large" alt="Codewars badge">
</div>
</div>

<div id="outline-container-org2bf0b45" class="outline-3">
<h3 id="org2bf0b45">Hack Chat</h3>
<div class="outline-text-3" id="text-org2bf0b45">
<p>
I developed this application during the Summer of 2022, while I was at AFIT
learning about cyber warfare, network defense, and other topics. The idea is
simple: multiple clients can enter a chat room on the server. I had great ideas
for this project that never came to fruition, but I did leave implement the
fundumental features. I even had the courtesy to leave it in a working state!
</p>

<p>
Since hackchat is written in rust, you can try this for yourself by running the
following code (assuming your machine has cargo installed):
</p>

<div class="org-src-container">
<pre class="src src-bash">$ <span style="color: #986801;">git</span> clone https://github.com/ethanxxxl/hackchat.git
$ <span style="color: #986801;">cd</span> hackchat
$ cargo run --bin server
</pre>
</div>

<p>
You can run clients in a few more terminals. It will prompt you for an ip
address, which is printed by the server.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ <span style="color: #986801;">cd</span> hackchat
$ cargo run --bin client
</pre>
</div>

<p>
An example of the program running and working is shown in the image below.
</p>


<div id="orga8068df" class="figure">
<p><img src="../resources/portfolio/hackchat-demo.png" alt="hackchat-demo.png" width="700px" margin="auto">
</p>
</div>

<p>
Note, that I am running this on Arch Linux. It may work on MacOS, but I&rsquo;m pretty
sure it won&rsquo;t work on Windows.
</p>
</div>
</div>

<div id="outline-container-org0964b96" class="outline-3">
<h3 id="org0964b96">Rust-Snake</h3>
<div class="outline-text-3" id="text-org0964b96">
<p>
This was the first real program I wrote using Rust; A rudimentary implementation
of the classic game Snake. I Learned a lot about the language from this project.
Unfortunately, time has not been kind to this project. It is hosted on <a href="https://github.com/ethanxxxl/rust-snake">github</a>,
so you can peruse my code if you wish, but unfortunately, when I wrote this
program, I didn&rsquo;t have the forethought to create a binary, or even take pictures
of the final product.
</p>

<p>
I did spend about 30 minutes trying to get it to work, but I was not willing to
spend any more time on it.
</p>

</div>
</div>
</div>
</div>
</div>
</body>
</html>